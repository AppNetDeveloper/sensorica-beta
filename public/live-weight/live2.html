<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BOISOLO Autoconto - Mejorado</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    /* --- Variables CSS --- */
    :root {
      --primary-dark: #2c3e50;
      --primary-light-bg: #ecf0f1;
      --accent-color: #e67e22;
      --text-light: #ffffff;
      --text-dark: #34495e;
      --text-muted: #7f8c8d;
      --card-bg: #ffffff;
      --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
      --font-family: 'Poppins', sans-serif;
      --success-color: #2ecc71;
      --warning-color: #f1c40f;
      --danger-color: #e74c3c;
      --info-color: #3498db;
      --info-box-bg: #f8f9fa;
      --info-box-border: #e9ecef;
    }

    html, body {
      width: 100%; height: 100%; margin: 0; padding: 0; display: flex; flex-direction: column;
      background-color: var(--primary-light-bg); color: var(--text-dark); font-family: var(--font-family);
      box-sizing: border-box; overflow: hidden;
    }

    /* --- Header --- */
    .header-container { width: 100%; background-color: var(--primary-dark); color: var(--text-light); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); flex-shrink: 0; }
    .header-left img { max-height: 50px; width: auto; }
    .header-center { text-align: center; font-size: 1.1rem; font-weight: 500; }
    .header-center #created-at { font-size: 0.9rem; color: #bdc3c7; }
    .header-right { text-align: right; }
    .header-right #timeDisplay { font-size: 1.4rem; font-weight: 600; margin: 0; padding: 0; }
    .header-right #scaleName { display: block; font-size: 1.1rem; color: var(--accent-color); font-weight: 600; margin: 0; padding: 0; }

    /* --- Contenido Principal --- */
    main { display: flex; flex-direction: column; align-items: center; width: 100%; flex-grow: 1; padding: 20px; overflow-y: auto; }

    /* --- Cajas Principales --- */
    .box { background-color: var(--card-bg); padding: 25px; margin-bottom: 25px; border-radius: var(--border-radius); width: 98%; max-width: 2400px; box-shadow: var(--card-shadow); border: none; display: flex; flex-direction: column; align-items: center; }
    .box h5 { color: var(--primary-dark); font-weight: 600; margin-bottom: 20px; align-self: flex-start; display: flex; align-items: center; }

    .box-content { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; width: 100%; }

    /* --- Cajas de Información Internas --- */
    .info-box { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px; border-radius: var(--border-radius); background-color: var(--info-box-bg); border: 1px solid var(--info-box-border); }
    .info-box i.display-icon { font-size: 2.8rem; color: var(--accent-color); margin-bottom: 15px; line-height: 1; }
    .live-data-box .info-box { background-color: #ffffff; }

    /* --- Tipografía Principal (Números grandes) --- */
    .weight-display, .dimension-display, #boxNumberDisplay, #lastBoxNumberDisplay,
    #weightDisplay, #dimensionDisplay, #lastWeightDisplay, #lastDimensionDisplay {
      font-size: 5rem; font-weight: 600; color: var(--text-dark); line-height: 1.1; word-wrap: break-word; margin-bottom: 5px;
      transition: transform 0.3s ease-in-out, color 0.3s ease-in-out;
    }
    .unit { font-size: 1.8rem; font-weight: 500; vertical-align: baseline; color: var(--text-muted); margin-left: 8px; }
     @media (max-width: 1200px) { .weight-display, .dimension-display, #boxNumberDisplay, #lastBoxNumberDisplay, #weightDisplay, #dimensionDisplay, #lastWeightDisplay, #lastDimensionDisplay { font-size: 4rem; } .unit { font-size: 1.5rem; } .info-box i.display-icon { font-size: 2.5rem; } }
     @media (max-width: 768px) { .weight-display, .dimension-display, #boxNumberDisplay, #lastBoxNumberDisplay, #weightDisplay, #dimensionDisplay, #lastWeightDisplay, #lastDimensionDisplay { font-size: 3.5rem; } .unit { font-size: 1.2rem; } .info-box i.display-icon { font-size: 2.2rem; } }

    .info-box p:not(.weight-display):not(.dimension-display) { font-size: 1.1rem; color: var(--text-dark); margin-top: 10px; }

    /* --- Sección Inferior (Barcode, QR, RFID) --- */
    .bottom-row { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; width: 100%; padding-top: 25px; margin-top: 20px; border-top: 1px solid var(--info-box-border); }
    .barcode-container { display: flex; align-items: center; justify-content: center; flex-grow: 1; min-width: 250px; }
    .barcode-section { display: flex; flex-direction: column; align-items: center; text-align: center; }
    .barcode-container p { font-size: 1rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 500; }
    #lastBarcode { width: 100%; max-width: 400px; height: auto; margin-top: 5px; }
    .qr-rfid-container { display: flex; flex-direction: row; align-items: center; gap: 40px; flex-grow: 1; justify-content: center; min-width: 250px; margin-top: 15px; }
    .qr-rfid-container div { display: flex; flex-direction: column; align-items: center; }
    .qr-rfid-container p { font-size: 1rem; color: var(--text-dark); margin-bottom: 8px; font-weight: 500; }
    .rfid-logo, #qrCode { width: 100px; height: 100px; object-fit: contain; background-color: transparent; padding: 0; border: none; border-radius: 0; display: flex; justify-content: center; align-items: center; }
    #qrCode { background-color: white; border: 1px solid var(--info-box-border); }

    /* --- Media Queries --- */
    @media (max-width: 992px) { .box-content { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); } .bottom-row { justify-content: center; gap: 30px; } }
    @media (max-width: 768px) { .box-content { grid-template-columns: 1fr; } .bottom-row { flex-direction: column; align-items: center; gap: 25px; } .qr-rfid-container { margin-top: 20px; gap: 25px; } }

    /* --- Animaciones --- */
    @keyframes zoomEffect { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    .zoom { animation: zoomEffect 1s ease-in-out; }
    @keyframes zoomEffectRed { 0% { transform: scale(1); color: var(--text-dark); } 50% { transform: scale(1.1); color: var(--danger-color); } 100% { transform: scale(1); color: var(--text-dark); } }
    .zoom-red { animation: zoomEffectRed 1s ease-in-out; }
    .live-indicator { display: inline-block; width: 10px; height: 10px; background-color: var(--success-color); border-radius: 50%; margin-left: 10px; animation: pulse 1.5s infinite ease-in-out; }
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }

    /* <<< NUEVO: Estilos para la barra de tolerancia >>> */
    .tolerance-bar-container {
        width: 80%; /* Ancho de la barra */
        max-width: 400px;
        margin-top: 15px; /* Espacio sobre la barra */
        margin-bottom: 5px; /* Espacio debajo */
    }
    .tolerance-bar-track {
        position: relative; /* Para posicionar el indicador dentro */
        height: 10px; /* Grosor de la barra */
        background-color: var(--info-box-border); /* Color de fondo suave */
        border-radius: 5px; /* Bordes redondeados */
        display: flex; /* Para alinear las zonas de color */
        overflow: hidden; /* Para que las zonas no se salgan */
    }
    .tolerance-zone {
        height: 100%;
        /* Los anchos se definen abajo */
    }
    .zone-low {
        background-color: var(--danger-color); /* Rojo */
        flex-basis: 48%; /* Ancho zona baja (ajustar si el rango visual cambia) */
    }
    .zone-target {
        background-color: var(--success-color); /* Verde */
        flex-basis: 4%; /* Ancho zona objetivo +/- 2% */
    }
    .zone-high {
        background-color: var(--danger-color); /* Rojo */
        flex-basis: 48%; /* Ancho zona alta */
    }
    .tolerance-indicator {
        position: absolute;
        top: -5px; /* Para que sobresalga un poco */
        bottom: -5px;
        width: 5px; /* Ancho de la línea indicadora */
        background-color: var(--primary-dark); /* Color oscuro */
        border-radius: 1.5px;
        left: 50%; /* Posición inicial (se actualiza con JS) */
        transform: translateX(-50%); /* Centrar la línea */
        transition: left 0.4s ease-in-out; /* Animación suave */
        box-shadow: 0 0 3px rgba(0,0,0,0.5); /* Sombra sutil */
        z-index: 1; /* Asegurar que esté por encima de las zonas */
        border: 1px solid white; 
        box-sizing: border-box;
    }

  </style>
</head>
<body>
  <header class="header-container">
    <div class="header-left">
      <img src="logo.png" alt="Logo de Autoconto">
    </div>
    <div class="header-center">
      <div id="orderId">Cargando...</div>
      <div id="created-at" style="font-size: 1rem;">Iniciada ...</div>
    </div>
    <div class="header-right">
      <div id="timeDisplay">--:--:--</div>
      <small id="scaleName">Cargando...</small>
    </div>
  </header>

  <main>
    <div class="box live-data-box">
      <h5 class="mb-3 fw-semibold">Datos en Directo<span class="live-indicator"></span></h5>
      <div class="box-content">
        <div class="info-box">
          <i class="bi bi-speedometer2 display-icon" aria-hidden="true"></i>
          <span class="weight-display" id="weightDisplay">-- <b class="unit">Kg</b></span>
          <div class="tolerance-bar-container">
            <div class="tolerance-bar-track">
              <div class="tolerance-zone zone-low"></div>
              <div class="tolerance-zone zone-target"></div>
              <div class="tolerance-zone zone-high"></div>
              <div class="tolerance-indicator" id="weight-tolerance-indicator"></div>
            </div>
          </div>
        </div>
        <div class="info-box">
           <i class="bi bi-rulers display-icon" id="iconDimensionLive" aria-hidden="true"></i>
          <span class="dimension-display" id="dimensionDisplay">-- <b class="unit">mm</b></span>
        </div>
        <div class="info-box">
           <i class="bi bi-box-seam display-icon" aria-hidden="true"></i>
          <span id="boxNumberDisplay">-- <b class="unit">Cajas</b></span>
        </div>
      </div>
    </div>

    <div class="box">
       <h5 class="mb-3 fw-semibold">Última Caja Registrada</h5>
      <div class="box-content">
        <div class="info-box">
           <i class="bi bi-speedometer2 display-icon" aria-hidden="true"></i>
          <span class="weight-display" id="lastWeightDisplay">-- <b class="unit">Kg</b></span>
        </div>
        <div class="info-box">
           <i class="bi bi-rulers display-icon" id="iconDimensionLast" aria-hidden="true"></i>
          <span class="dimension-display" id="lastDimensionDisplay">-- <b class="unit">mm</b></span>
        </div>
        <div class="info-box">
            <i class="bi bi-box-seam display-icon" aria-hidden="true"></i>
          <span id="lastBoxNumberDisplay">-- <b class="unit">Cajas</b></span>
        </div>
      </div>
      <div class="bottom-row">
        <div class="barcode-container">
          <div class="barcode-section">
            <p>Código Barras Última <b id="boxTypeModel">Caja</b></p>
            <svg id="lastBarcode"></svg>
          </div>
        </div>
        <div class="qr-rfid-container">
          <div class="rfid-section">
            <p>RFID Code</p>
             <img src="rfid-logo.png" alt="RFID Code" class="rfid-logo">
          </div>
          <div class="qr-section">
            <p>QR Code</p>
            <div id="qrCode" class="qr-code"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

  <script>
    // Variables globales
    let lastWeight = null, lastDimension = null, lastBoxNumber = null;
    let liveWeight = null, liveDimension = null, liveBoxNumber = null;
    let qrCodeInstance = null;
    const qrCodeElement = document.getElementById("qrCode");
    let updateInterval = null;

    /** Obtiene token de URL */
    function getTokenFromUrl() { const urlParams = new URLSearchParams(window.location.search); return urlParams.get('token'); }
    /** Verifica parámetro m3 */
    function hasM3Param() { const urlParams = new URLSearchParams(window.location.search); return urlParams.get('m3') === 'true'; }

    const token = getTokenFromUrl();
    const apiUrl = token ? `/api/control-weight/${token}` : null;
    const isM3Active = hasM3Param();

    // Cambiar icono si m3=true
    if (isM3Active) {
      const iconDimensionLive = document.getElementById('iconDimensionLive');
      if (iconDimensionLive) { iconDimensionLive.classList.remove('bi-rulers'); iconDimensionLive.classList.add('bi-box'); }
      const iconDimensionLast = document.getElementById('iconDimensionLast');
      if (iconDimensionLast) { iconDimensionLast.classList.remove('bi-rulers'); iconDimensionLast.classList.add('bi-box'); }
    }

    /** Función auxiliar para actualizar texto */
    function setTextContent(id, text) { const element = document.getElementById(id); if (element) element.textContent = text; else console.warn(`Elemento ID '${id}' no encontrado.`); }
    /** Función auxiliar para actualizar HTML */
    function setHTMLContent(id, html) { const element = document.getElementById(id); if (element) element.innerHTML = html; else console.warn(`Elemento ID '${id}' no encontrado.`); }
    /** Aplica animación CSS */
    function applyAnimation(elementId, animationClass, duration = 1000) { const element = document.getElementById(elementId); if (element) { element.classList.add(animationClass); setTimeout(() => { element.classList.remove(animationClass); }, duration); } }

    /** Obtiene datos y actualiza la interfaz */
    async function updateData() {
      if (!apiUrl) { console.warn("No se puede actualizar: falta token."); setTextContent('orderId', 'Error: Falta Token'); return; }
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) { throw new Error(`Error HTTP: ${response.status} ${response.statusText}`); }
        const data = await response.json();
        // console.log("Datos recibidos:", data);

        // --- 1. Extraer y procesar datos ---
        const grossWeight = parseFloat(data.gross_weight) || 0;
        const theoreticalWeight = parseFloat(data.teoretico_weight); // <<< NUEVO: Peso teórico
        const dimensionValue = data.dimension ?? '--';
        const boxNumberValue = data.box_number ?? '--';
        const boxType = data.box_type || 'Caja';
        const lastControlWeight = parseFloat(data.last_control_weight) || 0;
        const lastDimensionValue = data.last_dimension ?? '--';
        const lastBoxM3 = data.box_m3;
        const lastBoxNumberValue = data.last_box_number ?? '--';
        const lastBarcodeValue = data.last_barcoder ? data.last_barcoder.toString() : '';

        // --- 2. Actualizar UI (excepto barra de tolerancia) ---
        setTextContent('scaleName', data.name || "Báscula Desconocida");
        setTextContent('orderId', data.order_id || "N/A");
        if (data.created_at) { const createdAt = new Date(data.created_at); const formattedDate = createdAt.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }); const formattedTime = createdAt.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); setTextContent('created-at', `Iniciada ${formattedDate} ${formattedTime}`); }
        else { setTextContent('created-at', "Iniciada ..."); }

        // Datos en vivo
        if (grossWeight !== liveWeight) { applyAnimation('weightDisplay', 'zoom'); setHTMLContent('weightDisplay', `${grossWeight.toFixed(2)} <b class="unit">Kg</b>`); liveWeight = grossWeight; }
        let liveDimensionUnit = 'mm'; let liveDimensionDisplayValue = dimensionValue; if (isM3Active) { liveDimensionUnit = 'mm'; }
        if (dimensionValue !== liveDimension) { applyAnimation('dimensionDisplay', 'zoom'); setHTMLContent('dimensionDisplay', `${liveDimensionDisplayValue} <b class="unit">${liveDimensionUnit}</b>`); liveDimension = dimensionValue; }
        if (boxNumberValue !== liveBoxNumber) { applyAnimation('boxNumberDisplay', 'zoom'); setHTMLContent('boxNumberDisplay', `${boxNumberValue} <b class="unit">${boxType}</b>`); liveBoxNumber = boxNumberValue; }

        // Últimos datos
        if (lastControlWeight !== lastWeight) { applyAnimation('lastWeightDisplay', 'zoom-red'); setHTMLContent('lastWeightDisplay', `${lastControlWeight.toFixed(2)} <b class="unit">Kg</b>`); lastWeight = lastControlWeight; }
        let lastDimensionDisplayValue = '--'; let lastDimensionUnit = 'mm'; if (isM3Active && lastBoxM3 !== null && !isNaN(parseFloat(lastBoxM3))) { lastDimensionDisplayValue = (parseFloat(lastBoxM3) / 1000000).toFixed(3); lastDimensionUnit = 'm³'; } else { lastDimensionDisplayValue = lastDimensionValue; lastDimensionUnit = 'mm'; }
        if (lastDimensionValue !== lastDimension) { applyAnimation('lastDimensionDisplay', 'zoom-red'); setHTMLContent('lastDimensionDisplay', `${lastDimensionDisplayValue} <b class="unit">${lastDimensionUnit}</b>`); lastDimension = lastDimensionValue; } else { setHTMLContent('lastDimensionDisplay', `${lastDimensionDisplayValue} <b class="unit">${lastDimensionUnit}</b>`); }
        if (lastBoxNumberValue !== lastBoxNumber) { applyAnimation('lastBoxNumberDisplay', 'zoom-red'); setHTMLContent('lastBoxNumberDisplay', `${lastBoxNumberValue} <b class="unit">${boxType}</b>`); lastBoxNumber = lastBoxNumberValue; }
        setTextContent('boxTypeModel', boxType);

        // Barcode y QR
        if (lastBarcodeValue) { try { JsBarcode("#lastBarcode", lastBarcodeValue, { format: "CODE128", displayValue: true, textMargin: 5, fontSize: 18, height: 100, margin: 10 }); document.getElementById('lastBarcode').style.display = 'block'; } catch (e) { console.error("Error BC:", e); document.getElementById('lastBarcode').style.display = 'none'; } } else { document.getElementById('lastBarcode').style.display = 'none'; }
        if (lastBarcodeValue) { if (qrCodeInstance) { qrCodeElement.innerHTML = ''; } qrCodeInstance = new QRCode(qrCodeElement, { text: lastBarcodeValue, width: 100, height: 100, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H }); qrCodeElement.style.display = 'flex'; } else { qrCodeElement.innerHTML = ''; qrCodeElement.style.display = 'none'; qrCodeInstance = null; }

        // --- 3. Actualizar Barra de Tolerancia de Peso ---
        const indicator = document.getElementById('weight-tolerance-indicator');
        if (indicator && !isNaN(theoreticalWeight) && theoreticalWeight > 0) {
            const tolerance = 0.05; // 5%
            const lowerLimit = theoreticalWeight * (1 - tolerance);
            const upperLimit = theoreticalWeight * (1 + tolerance);

            // Definir el rango visual de la barra (ej. +/- 10% del teórico)
            const rangeMargin = 0.20; // 20%
            const minRange = theoreticalWeight * (1 - rangeMargin);
            const maxRange = theoreticalWeight * (1 + rangeMargin);
            const rangeSpan = maxRange - minRange;

            let indicatorPositionPercent = 50; // Posición por defecto (centro)

            if (rangeSpan > 0) { // Evitar división por cero
                // Calcular la posición relativa del peso actual dentro del rango visual
                const relativePosition = (grossWeight - minRange) / rangeSpan;
                // Limitar la posición entre 0% y 100%
                indicatorPositionPercent = Math.max(0, Math.min(100, relativePosition * 100));
            } else if (grossWeight < theoreticalWeight) {
                 indicatorPositionPercent = 0; // Si no hay rango, poner a la izquierda si es menor
            } else if (grossWeight > theoreticalWeight) {
                 indicatorPositionPercent = 100; // Si no hay rango, poner a la derecha si es mayor
            }

            // Mover el indicador
            indicator.style.left = indicatorPositionPercent + '%';

             // Opcional: Cambiar color del indicador según si está en tolerancia
             if (grossWeight >= lowerLimit && grossWeight <= upperLimit) {
                 indicator.style.backgroundColor = 'var(--success-color)'; // Verde si está en tolerancia
             } else {
                 indicator.style.backgroundColor = 'var(--danger-color)'; // Rojo si está fuera
             }

            indicator.style.display = 'block'; // Asegurar que sea visible
        } else if (indicator) {
            indicator.style.display = 'none'; // Ocultar si no hay peso teórico
        }

      } catch (error) { console.error("Error al obtener o procesar datos:", error); }
    }

    /** Actualiza la hora */
    function updateTime() { const timeElement = document.getElementById('timeDisplay'); if (!timeElement) return; const now = new Date(); const options = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }; timeElement.textContent = now.toLocaleTimeString('es-ES', options); }

    // --- Inicialización ---
    updateTime(); setInterval(updateTime, 1000);
    if (apiUrl) {
        updateData(); // Primera llamada
        updateInterval = setInterval(updateData, 300); // Intervalo 300ms
    } else {
        setTextContent('orderId', 'Error: Falta Token');
        console.error("No se iniciará la actualización: falta token.");
    }
    window.addEventListener('beforeunload', () => { if (updateInterval) clearInterval(updateInterval); });

  </script>
</body>
</html>
