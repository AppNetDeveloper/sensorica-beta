<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Optimizado - Autoconto</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <script src="https://www.gstatic.com/charts/loader.js"></script>
  <script>
    // Cargar la librería de Google Charts (solo paquete 'sankey')
    google.charts.load('current', { packages: ['sankey'] });
  </script>

  <style>
    /* --- Variables CSS Industriales --- */
    :root {
      --primary-dark: #1a1d29;
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --metal-texture: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 25%, #e5e7eb 50%, #d1d5db 75%, #e5e7eb 100%);
      --primary-light-bg: #e5e7eb;
      --accent-color: #667eea;
      --accent-color-darker: #5568d3;
      --text-light: #ffffff;
      --text-dark: #2d3748;
      --text-muted: #718096;
      --card-bg: #ffffff;
      --card-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
      --card-shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.12);
      --border-radius: 16px;
      --font-family: 'Poppins', sans-serif;
      --success-color: #10b981;
      --success-led: #22c55e;
      --warning-color: #eab308;
      --warning-led: #fbbf24;
      --danger-color: #dc2626;
      --danger-led: #ef4444;
      --info-color: #667eea;
      --progress-bg: #e9ecef;
      --led-glow: 0 0 15px rgba(102, 126, 234, 0.6), 0 0 30px rgba(102, 126, 234, 0.3);
    }
    /* --- Estilos Generales --- */
    body {
      font-family: var(--font-family);
      background: var(--metal-texture);
      background-size: 200% 200%;
      color: var(--text-dark);
      margin: 0;
      padding: 0;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
      pointer-events: none;
      opacity: 0.3;
      z-index: 0;
    }
    .container-fluid {
      position: relative;
      z-index: 1;
    }
    /* Header Info Flotante Glassmorphism */
    .floating-header {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.95) 0%, rgba(5, 150, 105, 0.95) 100%);
      color: white;
      padding: 16px 28px;
      border-radius: 16px;
      margin: 20px 0;
      box-shadow: 
        0 8px 32px rgba(16, 185, 129, 0.5),
        0 0 0 1px rgba(255,255,255,0.2) inset,
        0 20px 60px rgba(0,0,0,0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 24px;
      backdrop-filter: blur(20px) saturate(180%);
      position: relative;
      overflow: hidden;
      animation: slideDown 0.5s ease-out;
    }
    .floating-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      animation: sweep 3s infinite;
    }
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    @keyframes sweep {
      0% { left: -100%; }
      100% { left: 200%; }
    }
    .floating-header-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
      z-index: 1;
    }
    .floating-header-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      opacity: 0.85;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .floating-header-value {
      font-size: 1.2rem;
      font-weight: 700;
      font-family: 'Roboto Mono', monospace;
    }
    .floating-header-value.large {
      font-size: 1.8rem;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
      animation: pulse-glow 2s infinite;
    }
    @keyframes pulse-glow {
      0%, 100% { 
        text-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.3);
      }
      50% { 
        text-shadow: 0 2px 8px rgba(0,0,0,0.3), 0 0 30px rgba(255,255,255,0.5);
      }
    }
    /* Cards */
    .card-custom {
      background-color: var(--card-bg);
      box-shadow: 
        var(--card-shadow),
        inset 0 1px 0 rgba(255,255,255,0.6),
        inset 0 -1px 0 rgba(0,0,0,0.1);
      border-radius: var(--border-radius);
      border: 1px solid #cbd5e1;
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
      animation: fadeInUp 0.6s ease-out backwards;
    }
    .card-custom:nth-child(1) { animation-delay: 0.1s; }
    .card-custom:nth-child(2) { animation-delay: 0.2s; }
    .card-custom:nth-child(3) { animation-delay: 0.3s; }
    .card-custom:nth-child(4) { animation-delay: 0.4s; }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .card-custom::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
      border-radius: 16px 16px 0 0;
    }
    .card-custom:hover {
      box-shadow: var(--card-shadow-hover);
      transform: translateY(-2px);
    }
    /* Small Cards Industriales */
    .small-card {
      background: linear-gradient(145deg, #ffffff 0%, #f7fafc 100%);
      border: 2px solid #e2e8f0;
      border-radius: var(--border-radius);
      padding: 18px 12px;
      text-align: center;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      color: var(--text-dark);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 100%;
      position: relative;
    }
    .small-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 10px,
        rgba(0,0,0,0.02) 10px,
        rgba(0,0,0,0.02) 11px
      );
      pointer-events: none;
      z-index: 0;
    }
    .small-card > * {
      position: relative;
      z-index: 1;
    }
    .small-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      border-color: var(--info-color);
    }
    .small-card .metric {
      font-size: 2rem;
      font-weight: 700;
      font-family: 'Roboto Mono', monospace;
      line-height: 1.2;
      margin-bottom: 8px;
      letter-spacing: -1px;
      transition: all 0.3s ease;
    }
    .small-card:hover .metric {
      transform: scale(1.05);
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
    }
    .small-card .metric-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      line-height: 1.3;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .small-card .metric-label i {
      font-size: 1rem;
      transition: all 0.3s ease;
    }
    .small-card:hover .metric-label i {
      transform: scale(1.2) rotate(5deg);
      filter: drop-shadow(0 0 6px currentColor);
    }
    .small-card .metric-red { 
      color: var(--danger-color);
      text-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
    }
    .small-card .metric-yellow { 
      color: var(--warning-color);
      text-shadow: 0 0 20px rgba(234, 179, 8, 0.3);
    }
    .small-card .metric-green { 
      color: var(--success-color);
      text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
      animation: pulse-success 2s infinite;
    }
    .small-card .metric-blue { 
      color: var(--info-color);
      text-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
    }
    @keyframes pulse-success {
      0%, 100% { 
        text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
      }
      50% { 
        text-shadow: 0 0 30px rgba(16, 185, 129, 0.5);
      }
    }

    /* --- Estilos de Barras de Progreso Mejoradas --- */
    .progress-section { 
      margin-bottom: 25px; 
      position: relative;
    }
    .progress-label { 
      font-size: 0.95rem; 
      font-weight: 700; 
      color: var(--text-dark); 
      margin-bottom: 10px; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .progress-label::before {
      content: '';
      width: 4px;
      height: 16px;
      background: var(--primary-gradient);
      border-radius: 2px;
    }
    .progress { 
      position: relative; 
      height: 32px; 
      background: linear-gradient(145deg, #e9ecef 0%, #dee2e6 100%);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 
        inset 0 2px 6px rgba(0,0,0,0.1),
        0 2px 8px rgba(0,0,0,0.05);
      border: 1px solid #dee2e6;
    }
    .progress-bar { 
      font-weight: 700; 
      font-size: 0.8rem; 
      font-family: 'Roboto Mono', monospace;
      line-height: 32px; 
      color: var(--text-light); 
      text-align: center; 
      white-space: nowrap; 
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 200%; }
    }
    .progress-bar-label { 
      position: absolute; 
      right: 12px; 
      top: 0; 
      line-height: 32px; 
      font-size: 0.85rem; 
      font-weight: 700;
      font-family: 'Roboto Mono', monospace; 
      color: var(--text-dark); 
      mix-blend-mode: difference; 
      filter: invert(1) grayscale(1) contrast(100); 
      padding: 0 6px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    #availability-progress-bar { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
    }
    #availability-progress-bar-stop { 
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
    }
    #performance-progress-bar { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
    }
    #performance-progress-bar-slow { 
      background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
      box-shadow: 0 0 15px rgba(234, 179, 8, 0.5);
    }
    #quality-progress-bar { 
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
    }
    #quality-progress-bar-defects { 
      background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
      box-shadow: 0 0 15px rgba(249, 115, 22, 0.5);
    }

    /* --- Estilo OEE Box Industrial --- */
    .oee-box-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: linear-gradient(145deg, #1a1d29 0%, #0f1117 100%);
      color: var(--text-light);
      padding: 25px;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: 
        inset 0 2px 8px rgba(0,0,0,0.5),
        0 4px 20px rgba(0,0,0,0.3);
      border: 2px solid #2d3748;
    }
    .oee-box-container .oee-title {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.85;
    }
    .oee-percentage {
      font-size: 5.5rem;
      font-family: 'Roboto Mono', monospace;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
      background-size: 200% auto;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 8px;
      filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.8));
      animation: gradient-shift 3s ease infinite, scale-pulse 2s ease-in-out infinite;
    }
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% center; }
      50% { background-position: 100% center; }
    }
    @keyframes scale-pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }
    .oee-subtitle {
      font-size: 0.85rem;
      color: #94a3b8;
      font-weight: 600;
    }

    /* --- Estilos Sankey Chart Industrial --- */
    .grafico-container {
      padding: 20px;
      background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: var(--border-radius);
      position: relative;
      flex-grow: 1;
      display: flex;
      border: 2px solid #dee2e6;
      box-shadow: 
        inset 0 2px 6px rgba(0,0,0,0.05),
        0 4px 15px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    .grafico-container:hover {
      border-color: var(--info-color);
      box-shadow: 
        inset 0 2px 6px rgba(0,0,0,0.05),
        0 8px 25px rgba(102, 126, 234, 0.2);
    }
    #sankey_fullscreen_container {
      position: relative;
      width: 100%;
    }
    #sankey_chart {
      width: 100%;
      height: auto;
      min-height: 300px;
    }
    #enter_fullscreen, #exit_fullscreen {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: var(--primary-gradient);
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    #enter_fullscreen:hover, #exit_fullscreen:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    #enter_fullscreen i, #exit_fullscreen i {
      font-size: 1.2rem;
      color: white;
    }
    #exit_fullscreen {
      display: none;
    }
    #sankey_fullscreen_container:fullscreen {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      height: 100vh;
      background-color: #fff;
      padding: 20px;
      box-sizing: border-box;
    }
    #sankey_fullscreen_container:fullscreen #sankey_chart {
      height: 85vh !important;
      width: 95% !important;
    }

    /* --- Títulos de Cards con Badges --- */
    .card-custom h5 {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 20px;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .status-badge:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    }
    .status-badge.live {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      animation: pulse-badge 2s infinite, glow-green 2s infinite;
    }
    @keyframes glow-green {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 0 20px rgba(16, 185, 129, 0.4);
      }
      50% {
        box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 0 30px rgba(16, 185, 129, 0.7);
      }
    }
    .status-badge.info {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .status-badge.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    .status-badge-icon {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: white;
      box-shadow: 0 0 6px rgba(255,255,255,0.8);
    }
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    /* --- Utilidades --- */
    .icon-label{display:inline-flex;align-items:center;gap:6px}.icon-label i{font-size:1.1em}
  </style>
</head>
<body>

  <div class="container-fluid px-4">
    <!-- Header Flotante -->
    <div class="floating-header">
      <div class="floating-header-item">
        <span class="floating-header-label">Línea</span>
        <span class="floating-header-value" id="production-line-name">Cargando...</span>
      </div>
      <div class="floating-header-item">
        <span class="floating-header-label">Orden</span>
        <span class="floating-header-value" id="order-id">Cargando...</span>
      </div>
      <div class="floating-header-item">
        <span class="floating-header-label">Iniciada</span>
        <span class="floating-header-value" id="created-at">...</span>
      </div>
      <div class="floating-header-item">
        <span class="floating-header-label">Hora</span>
        <span class="floating-header-value large" id="clock">--:--:--</span>
      </div>
    </div>
    <div class="row g-4">
      <div class="col-lg-6 mb-2">
        <div class="card card-custom">
          <div class="card-body">
            <h5 class="mb-3 fw-semibold">
              Estado Actual
              <span class="status-badge live">
                <span class="status-badge-icon"></span>
                LIVE
              </span>
            </h5>
            <div class="row g-3">
              <div class="col-md-4"><div class="small-card"><div class="metric metric-green" id="units-made-real">--</div><div class="metric-label"><i class="bi bi-check-circle"></i> Uds Fabricadas</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric metric-blue" id="units-pending">--</div><div class="metric-label"><i class="bi bi-hourglass-split"></i> Uds Pendientes</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric metric-yellow" id="units-delayed">--</div><div class="metric-label"><i class="bi bi-exclamation-triangle"></i> Uds Atrasadas</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="sensor-stops-time">--:--</div><div class="metric-label"><i class="bi bi-pause-circle"></i> Paradas Sensores</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="preparing-time">--:--</div><div class="metric-label"><i class="bi bi-gear"></i> T. Preparación</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric metric-red" id="unidentified-time">--:--</div><div class="metric-label"><i class="bi bi-question-circle"></i> Paradas No Identificadas</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric metric-yellow" id="slow-time">--:--</div><div class="metric-label"><i class="bi bi-speedometer2"></i> Tiempo Lento</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="total-downtime">--:--:--</div><div class="metric-label"><i class="bi bi-clock-history"></i> T. Total Perdido</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="on_time">--:--:--</div><div class="metric-label"><i class="bi bi-clock-history"></i> T. Producción</div></div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-2">
        <div class="card card-custom">
          <div class="card-body">
            <h5 class="mb-3 fw-semibold">
              Configuración y Ciclos
              <span class="status-badge info">
                <i class="bi bi-gear-fill" style="font-size: 0.75rem;"></i>
                CONFIG
              </span>
            </h5>
            <div class="row g-3">
              <div class="col-md-4"><div class="small-card"><div class="metric" id="box">--</div><div class="metric-label"><i class="bi bi-box-seam"></i> Cajas/Pedido</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="units-box">--</div><div class="metric-label"><i class="bi bi-box-arrow-in-down"></i> Uds/Caja</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="units">--</div><div class="metric-label"><i class="bi bi-boxes"></i> Uds Total Pedido</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="time-box">--:--:--</div><div class="metric-label"><i class="bi bi-clock"></i> TC Teórico/Caja</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="theoretical-cycle-time">--</div><div class="metric-label"><i class="bi bi-stopwatch"></i> TC Teórico(s)/Ud</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric" id="theoretical-end-time">--:--:--</div><div class="metric-label"><i class="bi bi-calendar-check"></i> Fin Orden (Teórico)</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric metric-red" id="time-box-real">--:--:--</div><div class="metric-label"><i class="bi bi-stopwatch-fill"></i> TC Real/Caja</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric metric-red" id="real-cycle-time">--</div><div class="metric-label"><i class="bi bi-stopwatch-fill"></i> TC Real(s)/Ud</div></div></div>
              <div class="col-md-4"><div class="small-card"><div class="metric metric-red" id="real-end-time">--:--:--</div><div class="metric-label"><i class="bi bi-calendar-x"></i> Fin Orden (Real)</div></div></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-6 mb-2">
        <div class="card card-custom">
           <div class="card-body p-4 d-flex flex-column">
             <h5 class="mb-3 fw-semibold">
               Eficiencia OEE
               <span class="status-badge success">
                 <i class="bi bi-graph-up-arrow" style="font-size: 0.75rem;"></i>
                 ANÁLISIS
               </span>
             </h5>
             <div class="row flex-grow-1">
                <div class="col-md-8 d-flex flex-column justify-content-around">
                    <div class="progress-section mb-3">
                      <span class="progress-label">Disponibilidad</span>
                      <div class="progress">
                        <div id="availability-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        <div id="availability-progress-bar-stop" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        <span id="availability-progress-bar-label" class="progress-bar-label">--:--:--</span> </div>
                    </div>
                    <div class="progress-section mb-3">
                       <span class="progress-label">Rendimiento</span>
                       <div id="performance-progress-container" style="width: 100%; margin: 0;">
                           <div class="progress">
                               <div id="performance-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                               <div id="performance-progress-bar-slow" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                               <span id="performance-progress-bar-label" class="progress-bar-label">--:--:--</span> </div>
                       </div>
                    </div>
                    <div class="progress-section mb-0">
                       <span class="progress-label">Calidad</span>
                       <div id="quality-progress-container" style="width: 100%; margin: 0;">
                           <div class="progress">
                               <div id="quality-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                               <div id="quality-progress-bar-defects" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                               <span id="quality-progress-bar-label" class="progress-bar-label">--:--:--</span> </div>
                       </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="oee-box-container h-100">
                        <div class="oee-title">EFECTIVIDAD / OEE</div>
                        <div class="oee-percentage" id="oee-percentage">--</div> <div class="oee-subtitle">ORDEN ACTUAL</div>
                    </div>
                </div>
             </div>
           </div>
        </div>
      </div>
      <div class="col-lg-6 mb-2">
        <div class="card card-custom">
          <div class="card-body p-4 d-flex flex-column">
            <div class="row g-4 flex-grow-1">
              <div class="col-lg-8 d-flex flex-column">
                 <h5 class="mb-3 fw-semibold">
                   Flujo de Material
                   <span class="status-badge info">
                     <i class="bi bi-diagram-3" style="font-size: 0.75rem;"></i>
                     SANKEY
                   </span>
                 </h5>
                 <div class="grafico-container flex-grow-1 d-flex">
                    <div id="sankey_fullscreen_container" class="w-100">
                       <button id="enter_fullscreen" onclick="enterFullScreen()" title="Pantalla Completa"><i class="bi bi-arrows-fullscreen"></i></button>
                       <button id="exit_fullscreen" onclick="exitFullScreen()" title="Salir Pantalla Completa"><i class="bi bi-x-lg"></i></button>
                       <div id="sankey_chart"></div>
                    </div>
                 </div>
              </div>
              <div class="col-lg-4 d-flex flex-column justify-content-around">
                 <h5 class="mb-3 fw-semibold text-center">
                   Estado Cajas
                   <span class="status-badge success">
                     <i class="bi bi-boxes" style="font-size: 0.75rem;"></i>
                     TRACKING
                   </span>
                 </h5>
                 <div class="mb-3"><div class="small-card"><div class="metric metric-green" id="box-finalized">--</div><div class="metric-label"><i class="bi bi-check2-square"></i> Cajas Finalizadas</div></div></div>
                 <div class="mb-3"><div class="small-card"><div class="metric" id="total-weight">-- kg</div><div class="metric-label"><i class="bi bi-box"></i> Peso Acumulado</div></div></div>
                 <div class="mb-0"><div class="small-card"><div class="metric metric-blue" id="box-pending">--</div><div class="metric-label"><i class="bi bi-hourglass-bottom"></i> Cajas Pendientes</div></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div> </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Variables Globales ---
    let lastSankeyData = null;
    let sankeyChartInstance = null;
    let updateInterval = null;

    // --- Funciones Auxiliares ---
    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const clockElement = document.getElementById('clock');
      if (clockElement) clockElement.textContent = `${hours}:${minutes}:${seconds}`;
    }

    function formatTime(seconds) {
      if (!isFinite(seconds) || isNaN(seconds)) return '--:--:--';
      seconds = Math.max(0, Math.floor(seconds));
      const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
      const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
      const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${hrs}:${mins}:${secs}`;
    }

    // --- Funciones Fullscreen ---
    function enterFullScreen() { const container = document.getElementById('sankey_fullscreen_container'); if (!container) return; if (container.requestFullscreen) container.requestFullscreen(); else if (container.mozRequestFullScreen) container.mozRequestFullScreen(); else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen(); else if (container.msRequestFullscreen) container.msRequestFullscreen(); }
    function exitFullScreen() { if (document.exitFullscreen) document.exitFullscreen(); else if (document.mozCancelFullScreen) document.mozCancelFullScreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); else if (document.msExitFullscreen) document.msExitFullscreen(); }
    function handleFullscreenChange() { const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; const enterBtn = document.getElementById('enter_fullscreen'); const exitBtn = document.getElementById('exit_fullscreen'); if (enterBtn && exitBtn) { enterBtn.style.display = isFullscreen ? 'none' : 'flex'; exitBtn.style.display = isFullscreen ? 'flex' : 'none'; } drawSankeyChart(lastSankeyData); }

    // --- Funciones de Gráfico y Datos ---

    /** Dibuja/actualiza el gráfico Sankey */
    function drawSankeyChart(sankeyData) {
        const chartDiv = document.getElementById('sankey_chart');
        if (!chartDiv || !google.visualization || !google.visualization.Sankey) { console.warn("Div #sankey_chart o Google Charts no está listo."); if(chartDiv) chartDiv.innerHTML = '<p class="text-center text-muted">Cargando gráfico...</p>'; return; }
        if (!sankeyData || !sankeyData.rows || !Array.isArray(sankeyData.rows)) { console.warn("Datos de filas para Sankey no válidos:", sankeyData); chartDiv.innerHTML = '<p class="text-center text-warning">Datos para gráfico no disponibles.</p>'; lastSankeyData = null; return; }
        lastSankeyData = sankeyData;
        const dataTable = new google.visualization.DataTable();
        dataTable.addColumn('string', 'From'); dataTable.addColumn('string', 'To'); dataTable.addColumn('number', 'Weight'); dataTable.addColumn({ type: 'string', role: 'tooltip' });
        dataTable.addRows(sankeyData.rows);
        const isFullscreenActive = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
        const chartHeight = isFullscreenActive ? window.innerHeight * 0.85 : undefined;
        const options = { width: '100%', height: chartHeight, sankey: { node: { label: { fontName: 'Poppins', fontSize: 12, color: '#34495e' }, nodePadding: 20, labelPadding: 5, width: 10 }, link: { colorMode: 'gradient' } }, tooltip: { isHtml: true } };
        try { if (!sankeyChartInstance) sankeyChartInstance = new google.visualization.Sankey(chartDiv); sankeyChartInstance.clearChart(); if (dataTable.getNumberOfRows() > 0) sankeyChartInstance.draw(dataTable, options); else chartDiv.innerHTML = '<p class="text-center text-muted">No hay datos de flujo para mostrar.</p>'; }
        catch (e) { console.error("Error al dibujar Sankey:", e); chartDiv.innerHTML = '<p class="text-center text-danger">Error al dibujar gráfico.</p>'; }
    }

    /** Obtiene datos y actualiza el dashboard */
    async function fetchProductionData() {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        if (!token) { setTextContent('order-id', "Error: Falta token"); console.error('Token no encontrado'); if (updateInterval) clearInterval(updateInterval); return; }

        const response = await fetch(`/api/order-stats?token=${token}`);
        if (!response.ok) { let errorBody = await response.text(); throw new Error(`Error API: ${response.status} ${response.statusText}. Cuerpo: ${errorBody}`); }
        const data = await response.json();

        // --- 1. Extraer y Calcular Variables Base ---
        const productionLineName = data.production_line_name || "N/A";
        const orderId = data.order_id || "N/A";
        const createdAtRaw = data.created_at;
        const unitsMadeRealRaw = data.units_made_real ?? 0;
        const unitsPendingRaw = data.units_pending ?? 0;
        const unitsDelayedRaw = data.units_delayed ?? 0;
        const sensorStopsTimeInSeconds = data.production_stops_time ?? 0;
        const prepairTimeInSeconds = data.prepair_time ?? 0;
        const downTimeInSeconds = data.down_time ?? 0;
        const boxTarget = data.box ?? 0;
        const unitsPerBoxRaw = data.units_box ?? 1;
        const unitsTarget = data.units ?? 0;
        const onTimeInSeconds = data.on_time ?? 0;
        const boxesMade = data.weights_0_orderNumber ?? 0;
        const timeOneBoxTheoretical = data.optimalproductionTime_weight ?? 0;
        const theoreticalCycleTimeRaw = data.seconds_per_unit_theoretical;
        const realCycleTimeRaw = data.seconds_per_unit_real;
        const theoreticalEndTimeRaw = data.theoretical_end_time ?? 0;
        const realEndTimeRaw = data.real_end_time ?? 0;
        const oeeValueRaw = data.oee;
        const boxFinalized = parseFloat(data.weights_0_orderNumber || 0);
        const totalWeightBoxFinalized = parseFloat(data.weights_0_orderKg || 0);
        const totalWeightBoxFinalized1 = parseFloat(data.weights_1_orderKg || 0);
        const totalWeightBoxFinalized2 = parseFloat(data.weights_2_orderKg || 0);

        // Convertir a números donde sea necesario
        const unitsMadeRealValue = parseFloat(unitsMadeRealRaw) || 0;
        const unitsPerBoxValue = parseFloat(unitsPerBoxRaw) || 1;
        const theoreticalCycleTimeValue = parseFloat(theoreticalCycleTimeRaw);
        const realCycleTimeValue = parseFloat(realCycleTimeRaw);

        // Cálculos derivados importantes
        const totalStopTimeInSeconds = sensorStopsTimeInSeconds + downTimeInSeconds + prepairTimeInSeconds;
        const slowTimeInSeconds = (unitsDelayedRaw ?? 0) * (!isNaN(theoreticalCycleTimeValue) ? theoreticalCycleTimeValue : 0);
        const totalLostTimeInSeconds = totalStopTimeInSeconds + slowTimeInSeconds;
        const onTime = totalStopTimeInSeconds + slowTimeInSeconds;
        const timeOneBoxReal = boxesMade > 0 ? onTimeInSeconds / boxesMade : 0;
        const weightPerBox = boxFinalized > 0 ? totalWeightBoxFinalized / boxFinalized : 0;
        const weightPerUnit = unitsPerBoxValue > 0 ? weightPerBox / unitsPerBoxValue : 0;


        // --- 2. Actualizar Interfaz ---

        // Actualizar Header
        setTextContent("production-line-name", productionLineName);
        setTextContent("order-id", `Orden: ${orderId}`);
        if (createdAtRaw) { const createdAt = new Date(createdAtRaw); const formattedDate = createdAt.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }); const formattedTime = createdAt.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); setTextContent("created-at", `Iniciada ${formattedDate} ${formattedTime}`); }
        else { setTextContent("created-at", "Iniciada --/--/---- --:--"); }

        // Actualizar Card 1
        setTextContent("units-made-real", unitsMadeRealRaw);
        setTextContent("units-pending", unitsPendingRaw);
        setTextContent("units-delayed", unitsDelayedRaw);
        setTextContent("sensor-stops-time", formatTime(sensorStopsTimeInSeconds));
        setTextContent("preparing-time", formatTime(prepairTimeInSeconds));
        setTextContent("unidentified-time", formatTime(downTimeInSeconds));
        setTextContent("slow-time", formatTime(slowTimeInSeconds));
        setTextContent("total-downtime", formatTime(totalLostTimeInSeconds));
        setTextContent("on_time", formatTime(data.on_time ?? 0));

        // Actualizar Card 2
        setTextContent("box", boxTarget);
        setTextContent("units-box", unitsPerBoxRaw);
        setTextContent("units", unitsTarget);
        setTextContent("time-box", formatTime(timeOneBoxTheoretical));
        setTextContent("theoretical-cycle-time", !isNaN(theoreticalCycleTimeValue) ? theoreticalCycleTimeValue.toFixed(2) : '--');
        setTextContent("real-cycle-time", !isNaN(realCycleTimeValue) ? realCycleTimeValue.toFixed(2) : '--');
        setTextContent("time-box-real", formatTime(timeOneBoxReal));
        setTextContent("theoretical-end-time", formatTime(theoreticalEndTimeRaw));
        setTextContent("real-end-time", formatTime(realEndTimeRaw));

        // Actualizar Card 3: OEE
        setTextContent("oee-percentage", (isFinite(oeeValueRaw) && !isNaN(oeeValueRaw)) ? Math.round(oeeValueRaw) : '--');

        // --- Inicio Bloque OEE (Lógica Específica del Usuario Integrada) ---
        const timeDifferenceInSeconds = onTimeInSeconds;
        const plannedProductionTime = timeDifferenceInSeconds;
        const runTime = Math.max(0, plannedProductionTime - totalStopTimeInSeconds);

        // ** Disponibilidad **
        let availabilityPercentage = plannedProductionTime > 0 ? (runTime / plannedProductionTime) * 100 : 0;
        availabilityPercentage = Math.min(100, Math.max(0, availabilityPercentage || 0));
        let stopPercentage = 100 - availabilityPercentage;
        updateProgressBar('availability-progress-bar', availabilityPercentage);
        updateProgressBar('availability-progress-bar-stop', stopPercentage);
        setTextContent('availability-progress-bar-label', formatTime(totalStopTimeInSeconds)); // Etiqueta con Tiempo

        // ** Rendimiento **
        const timeWithoutStopsInSeconds = timeDifferenceInSeconds - totalStopTimeInSeconds;
        const performanceContainer = document.getElementById('performance-progress-container');
        if (performanceContainer) performanceContainer.style.width = availabilityPercentage.toFixed(2) + '%';
        const idealCycleTime = !isNaN(theoreticalCycleTimeValue) ? theoreticalCycleTimeValue : 0;
        const idealRunTime = idealCycleTime * unitsMadeRealValue; // Usar valor numérico
        let performancePercentageOriginal = runTime > 0 ? (idealRunTime / runTime) * 100 : 0;
        performancePercentageOriginal = Math.min(100, Math.max(0, performancePercentageOriginal || 0));
        let slowPercentageOriginal = 100 - performancePercentageOriginal;
        updateProgressBar('performance-progress-bar', performancePercentageOriginal);
        updateProgressBar('performance-progress-bar-slow', slowPercentageOriginal);
        setTextContent('performance-progress-bar-label', formatTime(slowTimeInSeconds)); // Etiqueta con Tiempo

        // ** Calidad **
        const timeAtTheoreticalSpeedInSeconds = timeWithoutStopsInSeconds - slowTimeInSeconds;
        const calidadBarWidth = (availabilityPercentage * performancePercentageOriginal) / 100;
        const qualityContainer = document.getElementById('quality-progress-container');
        if (qualityContainer) qualityContainer.style.width = Math.min(100, Math.max(0, calidadBarWidth)).toFixed(2) + '%';

        // Calcular porcentajes de calidad (Buenas/Totales) para ANCHO de barras
        let qualityPercentageStandard = 0;
        let defectPercentageStandard = 0;
        const rejectedUnits = weightPerUnit > 0 ? Math.round((totalWeightBoxFinalized1 + totalWeightBoxFinalized2) / weightPerUnit) : 0;
        const goodUnits = Math.max(0, unitsMadeRealValue - rejectedUnits); // Usar valor numérico
        qualityPercentageStandard = unitsMadeRealValue > 0 ? (goodUnits / unitsMadeRealValue) * 100 : 0;
        qualityPercentageStandard = Math.min(100, Math.max(0, qualityPercentageStandard || 0));
        defectPercentageStandard = 100 - qualityPercentageStandard;
        updateProgressBar('quality-progress-bar', qualityPercentageStandard); // Barra verde = % buenas
        updateProgressBar('quality-progress-bar-defects', defectPercentageStandard); // Barra naranja = % malas

        // Calcular TIEMPO para ETIQUETA Calidad (según fórmula original)
        let qualityLabelTime = 0;
        if (!isNaN(realCycleTimeValue) && weightPerUnit > 0) {
             qualityLabelTime = Math.round(totalWeightBoxFinalized1 / weightPerUnit) * realCycleTimeValue;
        }
        setTextContent('quality-progress-bar-label', formatTime(qualityLabelTime)); // Etiqueta con Tiempo (Rechazo 1)
        // --- Fin Bloque OEE ---


        // --- Actualizar Card 4: Sankey y Cajas ---
        setTextContent("box-finalized", boxFinalized);
        setTextContent("box-pending", Math.max(0, (boxTarget ?? 0) - boxFinalized));
        setTextContent("total-weight", `${totalWeightBoxFinalized.toFixed(1)} kg`);

        // Preparar datos Sankey
        const udsNotEnvasadas = Math.max(0, Math.round(unitsMadeRealValue - (unitsPerBoxValue * boxFinalized)));
        const rejectedUnitsQuality = weightPerUnit > 0 ? Math.round((totalWeightBoxFinalized1 + totalWeightBoxFinalized2) / weightPerUnit) : 0; // Recalcular rechazos
        const totalWeightFromAllUnitsCreated = weightPerUnit > 0 ? Math.round(unitsMadeRealValue * weightPerUnit) : 0;
        const weightUnpackagedUnits = weightPerUnit > 0 ? Math.max(0, Math.round((udsNotEnvasadas - rejectedUnitsQuality) * weightPerUnit)) : 0;
        const weightPackagedUnits = Math.round(totalWeightBoxFinalized);
        const weightRejectedUnits1 = Math.round(totalWeightBoxFinalized1);
        const weightRejectedUnits2 = Math.round(totalWeightBoxFinalized2);
        const weightRejectedFromProduction = Math.max(0, weightRejectedUnits1);
        const sankeyRowsRaw = [
            ['Material Total', 'Uds Fabricadas', totalWeightFromAllUnitsCreated, `Peso Total Estimado<br><b>${totalWeightFromAllUnitsCreated} kg</b>`],
            ['Material Total', 'Rechazo Directo', weightRejectedUnits2, `Rechazo Directo<br><b>${weightRejectedUnits2} kg</b>`],
            ['Uds Fabricadas', 'Unidades Envasadas', weightPackagedUnits, `Envasadas: ${Math.round(unitsPerBoxValue * boxFinalized)} uds<br><b>${weightPackagedUnits} kg</b>`], // Corregido: usar unitsPerBoxValue
            ['Uds Fabricadas', 'Unidades Sin Envasar', weightUnpackagedUnits, `Sin Envasar (Buenas): ${Math.round(udsNotEnvasadas - rejectedUnitsQuality)} uds<br><b>${weightUnpackagedUnits} kg</b>`],
            ['Uds Fabricadas', 'Rechazo Producción', weightRejectedFromProduction, `Rechazo Producción: ${weightPerUnit > 0 ? Math.round(weightRejectedFromProduction/weightPerUnit) : 0} uds<br><b>${weightRejectedFromProduction} kg</b>`]
        ];
        const sankeyRows = sankeyRowsRaw.filter(row => row[2] > 0);
        drawSankeyChart({ rows: sankeyRows });

      } catch (error) {
        console.error("Error en fetchProductionData:", error);
        resetDashboardOnError();
      }
    }

    /** Función auxiliar para actualizar texto */
    function setTextContent(id, text) { const element = document.getElementById(id); if (element) element.textContent = text; else console.warn(`Elemento ID '${id}' no encontrado.`); }
    /** Función auxiliar para actualizar barra de progreso */
    function updateProgressBar(id, percentage) { const element = document.getElementById(id); if (element) { const validPercentage = Math.min(100, Math.max(0, percentage || 0)); element.style.width = validPercentage.toFixed(2) + '%'; element.setAttribute('aria-valuenow', validPercentage.toFixed(2)); } else { console.warn(`Barra progreso ID '${id}' no encontrada.`); } }
    /** Resetea el dashboard en caso de error */
    function resetDashboardOnError() { const elementsToReset = { "production-line-name": "N/A", "created-at": "Error", "order-id": "Error Carga", "units-made-real": "--", "units-pending": "--", "units-delayed": "--", "box": "--", "units-box": "--", "units": "--", "total-downtime": "--:--:--", "theoretical-cycle-time": "--", "real-cycle-time": "--", "sensor-stops-time": "--:--:--", "slow-time": "--:--:--", "unidentified-time": "--:--:--", "time-box": "--:--:--", "time-box-real": "--:--:--", "theoretical-end-time": "--:--:--", "real-end-time": "--:--:--", "oee-percentage": "--", "box-finalized": "--", "box-pending": "--", "total-weight": "-- kg" }; for (const id in elementsToReset) setTextContent(id, elementsToReset[id]); ['availability', 'performance', 'quality'].forEach(type => { updateProgressBar(`${type}-progress-bar`, 0); const stopBar = document.getElementById(`${type}-progress-bar-stop`) || document.getElementById(`${type}-progress-bar-slow`) || document.getElementById(`${type}-progress-bar-defects`); if(stopBar) updateProgressBar(stopBar.id, 0); setTextContent(`${type}-progress-bar-label`, '--:--:--'); /* Etiqueta reseteada a tiempo */ const container = document.getElementById(`${type}-progress-container`); if (container) container.style.width = '0%'; }); const chartDiv = document.getElementById('sankey_chart'); if(chartDiv) chartDiv.innerHTML = '<p class="text-center text-danger">Error al cargar datos.</p>'; lastSankeyData = null; }

    // --- Inicialización ---
    document.addEventListener("fullscreenchange", handleFullscreenChange); document.addEventListener("webkitfullscreenchange", handleFullscreenChange); document.addEventListener("mozfullscreenchange", handleFullscreenChange); document.addEventListener("MSFullscreenChange", handleFullscreenChange);
    updateClock(); setInterval(updateClock, 1000);
    google.charts.setOnLoadCallback(() => { console.log("Google Charts 'sankey' cargado."); const chartDiv = document.getElementById('sankey_chart'); if(chartDiv) { try { sankeyChartInstance = new google.visualization.Sankey(chartDiv); } catch(e) { console.error("Error al crear Sankey:", e); return; } } else { console.error("#sankey_chart no encontrado."); return; } fetchProductionData(); if (updateInterval) clearInterval(updateInterval); updateInterval = setInterval(fetchProductionData, 1000); });
    window.addEventListener('beforeunload', () => { if (updateInterval) clearInterval(updateInterval); });

  </script>

</body>
</html>
