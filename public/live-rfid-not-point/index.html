<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RFID Error Points</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <style>
    /* Custom styles for DataTables buttons to match Tailwind look */
    .dt-button {
      background-color: #4a5568; /* gray-700 */
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem; /* rounded-md */
      border: none;
      transition: background-color 0.2s;
    }
    .dt-button:hover {
      background-color: #2d3748; /* gray-800 */
    }
    /* Ensure tfoot inputs are full width */
    tfoot input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #e2e8f0; /* gray-300 */
      border-radius: 0.375rem; /* rounded-md */
    }
    /* Adjust DataTables search input */
    div.dataTables_wrapper div.dataTables_filter input {
        margin-left: 0.5em;
        display: inline-block;
        width: auto;
        padding: 0.5rem;
        border: 1px solid #e2e8f0; /* gray-300 */
        border-radius: 0.375rem; /* rounded-md */
    }
    /* Style for the table itself */
    #errorTable {
        width: 100%;
    }
    /* Add some margin to the DataTables controls */
    .dataTables_wrapper .dt-buttons {
        margin-bottom: 1rem;
    }
    .dataTables_wrapper .dataTables_filter {
        margin-bottom: 1rem;
    }
  </style>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js" defer></script>

  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js" defer></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js" defer></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js" defer></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js" defer></script>

  <script defer>
    document.addEventListener('DOMContentLoaded', () => {
      /* ------ crear inputs de búsqueda por columna ------ */
      $('#errorTable tfoot th').each(function () {
        const title = $(this).text();
        // Add Tailwind classes to the input fields in the footer
        $(this).html(`<input type="text" class="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar ${title}" />`);
      });

      /* ------ Inicializar DataTable con Buttons ------ */
      const table = $('#errorTable').DataTable({
        dom: 'Bfrtip', // Defines the positions of the elements (Buttons, filtering, table, info, pagination)
        buttons: [
          { extend: 'excelHtml5', title: 'RFID_Error_Points', className: 'bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded' },
          { extend: 'pdfHtml5',   title: 'RFID_Error_Points', orientation: 'landscape', pageSize: 'A4', className: 'bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded' },
          { extend: 'print',      title: 'RFID Error Points', className: 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded' }
        ],
        columns: [
          { data: 'id',                 title: 'ID' },
          { data: 'name',               title: 'Nombre' },
          { data: 'epc',                title: 'EPC' },
          { data: 'tid',                title: 'TID' },
          { data: null,                 title: 'PUESTO', render: row => row.rfid_reading?.name ?? '' },
          { data: 'production_line.name', title: 'Línea' },
          { data: 'product_list.name',  title: 'Producto' },
          { data: 'operator.name',      title: 'Operario' },
          { data: null,                 title: 'Color RFID', render: row => row.rfid_color_name ?? (row.rfid_reading?.rfid_color?.name ?? '') },
          { data: 'created_at',         title: 'Fecha', render: data => data ? dayjs(data).format('YYYY-MM-DD HH:mm:ss') : '' },
        ],
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
        responsive: true,
        deferRender: true,
        paging: true,
        pageLength: 10, 
        autoWidth: false, 
        // Apply Tailwind classes to the table
        initComplete: function(settings, json) {
          $('#errorTable').addClass('min-w-full divide-y divide-gray-200 shadow-md');
          $('#errorTable thead').addClass('bg-gray-50');
          // Ensure header cells get styled correctly on init and subsequent draws
          $('#errorTable thead th').addClass('px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider');
          $('#errorTable tbody').addClass('bg-white divide-y divide-gray-200');
          // TD styling will be applied dynamically or on drawCallback
        },
        // Apply styles to body cells on each draw
        drawCallback: function(settings) {
            $('#errorTable tbody tr').each(function() {
                $(this).find('td').addClass('px-6 py-4 whitespace-nowrap text-sm text-gray-700');
            });
            // Re-apply header styles in case they are lost on redraw
            $('#errorTable thead th').addClass('px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider');
        }
      });

      /* ------ búsqueda individual por columna ------ */
      table.columns().every(function () {
        const col = this;
        $('input', this.footer()).on('keyup change clear', function () {
          if (col.search() !== this.value) {
            col.search(this.value).draw();
          }
        });
      });

      /* ------ Cargar datos desde la API ------ */
      const loadData = (dateStr) => {
        const url = `/api/rfid-error-points?date=${encodeURIComponent(dateStr)}`;
        console.log(`Fetching data from: ${url}`);
        
        fetch(url)
          .then(r => {
            if (!r.ok) {
              throw new Error(`HTTP error! status: ${r.status}`);
            }
            return r.json();
          })
          .then(json => {
            if (json && json.data) { // Check if json and json.data exist
                table.clear().rows.add(json.data).draw();
                console.log('Data loaded from API');
            } else {
                // Handle cases where data might be empty or not in expected format
                table.clear().draw();
                console.warn('API response did not contain data or was in an unexpected format:', json);
                // Optionally, display a message to the user
                displayUserMessage('No se encontraron datos para la fecha seleccionada o hubo un problema con la respuesta.', 'warning');

            }
          })
          .catch(err => {
            console.error("Error fetching data:", err);
            // Display a user-friendly error message
            displayUserMessage(`Error al obtener datos: ${err.message}. Revisa la consola para más detalles.`, 'error');
            table.clear().draw(); // Clear table in case of error
          });
      };

      // Function to display messages to the user
      const displayUserMessage = (message, type = 'error') => {
        const messageContainer = document.getElementById('message-container');
        if (!messageContainer) {
            console.error("Message container not found");
            return;
        }

        let bgColor, textColor, borderColor, title;
        if (type === 'error') {
            bgColor = 'bg-red-100';
            textColor = 'text-red-700';
            borderColor = 'border-red-400';
            title = 'Error!';
        } else if (type === 'warning') {
            bgColor = 'bg-yellow-100';
            textColor = 'text-yellow-700';
            borderColor = 'border-yellow-400';
            title = 'Atención:';
        } else { // 'info' or default
            bgColor = 'bg-blue-100';
            textColor = 'text-blue-700';
            borderColor = 'border-blue-400';
            title = 'Información:';
        }

        messageContainer.innerHTML = `
            <div class="${bgColor} border ${borderColor} ${textColor} px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">${title}</strong>
                <span class="block sm:inline"> ${message}</span>
            </div>
        `;
        messageContainer.classList.remove('hidden'); // Make it visible

        // Optional: Hide message after some time
        // setTimeout(() => {
        //     messageContainer.classList.add('hidden');
        //     messageContainer.innerHTML = '';
        // }, 5000); // Hide after 5 seconds
      };


      /* ------ Eventos de UI ------ */
      $('#loadBtn').on('click', () => {
        const messageContainer = document.getElementById('message-container');
        if (messageContainer) { // Clear previous messages before new load
            messageContainer.innerHTML = '';
            messageContainer.classList.add('hidden');
        }
        const dateInput = $('#date').val();
        const date = dateInput || new Date().toISOString().slice(0, 10);
        loadData(date);
      });

      /* ------ Carga inicial (hoy) ------ */
      const today = new Date().toISOString().slice(0, 10);
      $('#date').val(today);
      // Ensure message container is cleared on initial load as well
      const initialMessageContainer = document.getElementById('message-container');
      if (initialMessageContainer) {
          initialMessageContainer.innerHTML = '';
          initialMessageContainer.classList.add('hidden');
      }
      loadData(today); // Load data for today on initial page load
    });
  </script>
</head>
<body class="bg-gray-100 font-sans">

  <div class="container mx-auto p-4 md:p-8">
    <header class="mb-8 text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Lecturas RFID sin PUNTO</h1>
    </header>

    <div id="message-container" class="mb-4 hidden"></div>

    <div class="bg-white shadow-md rounded-lg p-6 mb-8">
      <div class="controls flex flex-col sm:flex-row items-center gap-4 mb-6">
        <div class="flex items-center">
          <label for="date" class="text-gray-700 font-medium mr-2">Fecha:</label>
          <input type="date" id="date" class="block w-full sm:w-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
        <button id="loadBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out">
          Cargar Datos
        </button>
      </div>
    </div>
    
    <div class="bg-white shadow-md rounded-lg p-2 sm:p-6 overflow-x-auto">
      <table id="errorTable" class="display nowrap min-w-full">
        <thead class="bg-gray-50">
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>EPC</th>
            <th>TID</th>
            <th>PUESTO</th>
            <th>Línea</th>
            <th>Producto</th>
            <th>Operario</th>
            <th>Color RFID</th>
            <th>Fecha</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
        <tfoot class="bg-gray-50">
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>EPC</th>
            <th>TID</th>
            <th>PUESTO</th>
            <th>Línea</th>
            <th>Producto</th>
            <th>Operario</th>
            <th>Color RFID</th>
            <th>Fecha</th>
          </tr>
        </tfoot>
      </table>
    </div>

  </div>

</body>
</html>
