<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla Trabajadores Ordenada por Primer Puesto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { padding: 0; }
            .container { box-shadow: none; margin: 0; max-width: 100%; }
            .modal { display: none !important; }
            .kpi-card-container, #searchInputContainer { display: none !important; }
        }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: flex;
            justify-content: center; align-items: center; z-index: 1000; padding: 1rem;
            transition: all 0.3s ease-in-out;
        }
        .modal-content {
            background-color: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 600px;
            display: flex; flex-direction: column;
            transition: all 0.3s ease-in-out;
        }
        #chartModal .modal-content {
            max-width: 850px; /* Ancho normal */
            height: auto;
            max-height: 90vh; /* Alto normal */
        }

        /* Estilos para modal maximizado */
        .modal.modal-fullscreen { padding: 0; }
        .modal.modal-fullscreen .modal-content {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            margin: 0;
            border-radius: 0;
            padding: 0; 
            display: flex;
            flex-direction: column;
        }
        .modal.modal-fullscreen .modal-header {
            padding: 1rem; 
            flex-shrink: 0; 
        }
        .modal.modal-fullscreen .chart-container {
            width: 100% !important; 
            flex-grow: 1; 
            padding: 1rem; 
            box-sizing: border-box; 
            display: block; 
            overflow-x: auto !important; 
            overflow-y: hidden; 
        }
         .modal.modal-fullscreen .chart-container svg {
            margin-left: 0;
            margin-right: 0;
        }
        .modal.modal-fullscreen .modal-footer {
            padding: 1rem; 
            flex-shrink: 0; 
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-header h3 { margin: 0; }
        .modal-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: right;}


        .edit-icon, .analyze-icon, .fullscreen-icon {
            cursor: pointer; margin-left: 8px; color: #3b82f6;
            display: inline-flex; align-items: center;
        }
        .edit-icon:hover, .analyze-icon:hover, .fullscreen-icon:hover { color: #2563eb; }
        .hidden { display: none; }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px;
            border-radius: 50%; border-left-color: #09f;
            animation: spin 1s ease infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-container { width: 100%; height: 450px; overflow-x: auto; flex-shrink: 0; }
        .chart-container svg { display: block; margin: auto; }
        .bar { 
            fill: steelblue; 
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .bar:hover { 
            fill: #1d4ed8;
            transform: scale(1.02);
        }
        .axis-label { font-size: 0.8rem; }
        .tooltip {
            position: absolute; text-align: center; padding: 12px; font: 13px sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            pointer-events: none; opacity: 0; z-index: 1010;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            transform: translateY(-5px);
            transition: all 0.3s ease;
        }
        .pie-slice-label { /* Estilo para etiquetas del gr√°fico circular */
            font-size: 9px;
            fill: #333; /* Cambiado a color oscuro para etiquetas externas */
        }
        .btn-ia-local { background-color: #4f46e5; }
        .btn-ia-local:hover { background-color: #4338ca; }
        .kpi-card {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 1px solid #e5e7eb; border-radius: 0.75rem;
            padding: 1rem; text-align: center; position: relative;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: all 0.3s ease; cursor: pointer;
        }
        .kpi-card:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.2), 0 8px 16px -4px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .kpi-tooltip {
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: white; padding: 0.75rem 1rem;
            border-radius: 0.5rem; font-size: 0.875rem; white-space: nowrap;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
            z-index: 20; margin-bottom: 0.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .kpi-tooltip::after {
            content: ''; position: absolute; top: 100%; left: 50%;
            transform: translateX(-50%); border: 6px solid transparent;
            border-top-color: rgba(0,0,0,0.9);
        }
        .kpi-card:hover .kpi-tooltip {
            opacity: 1; visibility: visible;
        }
        .kpi-title { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; text-transform: uppercase; font-weight: 600; }
        .kpi-value { font-size: 1.25rem; font-weight: bold; color: #1f2937; margin-bottom: 0.25rem; }
        .kpi-indicator {
            position: absolute; top: 0.5rem; right: 0.5rem;
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #d1d5db; transition: all 0.3s ease;
        }
        .kpi-indicator.excellent { background-color: #10b981; box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
        .kpi-indicator.good { background-color: #f59e0b; box-shadow: 0 0 8px rgba(245, 158, 11, 0.4); }
        .kpi-indicator.warning { background-color: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }
        .trend-arrow {
            font-size: 0.75rem; margin-left: 0.25rem;
            display: inline-block; transition: all 0.3s ease;
        }
        .trend-up { color: #10b981; }
        .trend-down { color: #ef4444; }
        .trend-stable { color: #6b7280; }
        .legend-item { display: flex; align-items: center; margin-right: 15px; font-size: 0.8rem; }
        .legend-color { width: 12px; height: 12px; margin-right: 5px; border: 1px solid #ccc; }
        .heatmap-cell {
            stroke: #fff; stroke-width: 2px; cursor: pointer;
            transition: all 0.3s ease;
        }
        .heatmap-cell:hover {
            stroke: #333; stroke-width: 3px;
            filter: brightness(1.1);
        }
        .trend-line {
            fill: none; stroke-width: 3px; stroke-linecap: round;
        }
        .trend-point {
            fill: #fff; stroke-width: 2px; cursor: pointer;
            transition: all 0.3s ease;
        }
        .trend-point:hover {
            r: 6; stroke-width: 3px;
        }
        .ranking-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 0.5rem; padding: 1rem; margin: 0.5rem 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .ranking-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .ranking-position {
            font-size: 2rem; font-weight: bold;
            background: rgba(255,255,255,0.2);
            border-radius: 50%; width: 3rem; height: 3rem;
            display: flex; align-items: center; justify-content: center;
            margin-right: 1rem;
        }
        .countdown-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); display: flex;
            justify-content: center; align-items: center; z-index: 2000;
            animation: fadeIn 0.3s ease-in-out;
        }
        .countdown-content {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white; padding: 2rem; border-radius: 1rem;
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.5s ease-out;
        }
        .countdown-number {
            font-size: 4rem; font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            animation: pulse 1s ease-in-out;
        }
        .session-indicator {
            position: fixed; top: 1rem; right: 1rem; z-index: 1500;
            background: rgba(0,0,0,0.8); color: white; padding: 0.5rem 1rem;
            border-radius: 0.5rem; font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        .session-indicator.warning {
            background: rgba(255, 107, 107, 0.9);
            animation: blink 1s infinite;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="container mx-auto bg-white rounded-lg shadow-md overflow-hidden">
    <div class="p-4 md:p-6 border-b border-gray-200">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
             <div class="flex items-center gap-3">
                 <h1 class="text-2xl font-bold text-gray-700">Listado de Trabajadores</h1>
                 <div id="lockButton" class="no-print cursor-pointer text-gray-600 hover:text-blue-600 transition-colors">
                     <svg id="lockIcon" class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6zm-1.5-1a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-1z" clip-rule="evenodd" /></svg>
                     <svg id="unlockIcon" class="icon hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h1.5a.5.5 0 00.5-.5V8a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v.5a.5.5 0 00.5.5H9v1h4z" clip-rule="evenodd" /><path d="M9 5.5a3 3 0 00-3 3V9h1.5a.5.5 0 01.5.5v1a.5.5 0 01-.5.5H5v.5a3 3 0 003 3h.5a.5.5 0 00.5-.5V12a.5.5 0 00-.5-.5H8a.5.5 0 00-.5.5v.5a.5.5 0 00.5.5h.5a1.5 1.5 0 001.5-1.5v-.5a.5.5 0 00-.5-.5H9V9h1V5.5z"/></svg>
                 </div>
            </div>
             <div class="flex flex-col sm:flex-row sm:items-center gap-4 no-print">
                 <div class="flex items-center space-x-2">
                     <label for="dateRangeSelect" class="text-sm font-medium text-gray-700">Periodo:</label>
                     <select id="dateRangeSelect" name="dateRange" class="block w-full sm:w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm">
                         <option value="today" selected>Hoy</option>
                         <option value="yesterday">Ayer</option>
                         <option value="day_minus_2">Hace 2 d√≠as</option>
                         <option value="day_minus_3">Hace 3 d√≠as</option>
                         <option value="day_minus_4">Hace 4 d√≠as</option>
                         <option value="day_minus_5">Hace 5 d√≠as</option>
                         <option value="day_minus_6">Hace 6 d√≠as</option>
                         <option value="day_minus_7">Hace 7 d√≠as</option>
                         <option value="last7days">√öltimos 7 d√≠as (rango)</option>
                         <option value="last30days">√öltimos 30 d√≠as (rango)</option>
                         <option value="custom">üìÖ Personalizado</option>
                     </select>
                 </div>
                 <div id="customDateRangeContainer" class="flex items-center space-x-2 hidden">
                     <label for="customDateFrom" class="text-sm font-medium text-gray-700">Desde:</label>
                     <input type="date" id="customDateFrom" class="block w-auto px-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm">
                     <label for="customDateTo" class="text-sm font-medium text-gray-700">Hasta:</label>
                     <input type="date" id="customDateTo" class="block w-auto px-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm">
                     <button id="applyCustomDateBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out">Aplicar</button>
                 </div>
                  <div class="flex items-center">
                     <input id="filterPostsCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                     <label for="filterPostsCheckbox" class="ml-2 block text-sm text-gray-900">Solo operarios con asignaciones</label>
                   </div>
             </div>
        </div>
        <!-- Botones de An√°lisis y Gr√°ficos -->
        <div class="no-print mb-4 space-y-2">
            <!-- Primera fila: Gr√°ficos y An√°lisis -->
            <div class="flex flex-wrap justify-end items-center gap-2">
                <button id="viewWorkerChartBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üìä Cajas/Trabajador</button>
                <button id="viewWorkerCHChartBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">‚ö° c/h/Trabajador</button>
                <button id="viewPostChartBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üìä Cajas/Puesto (Barras)</button>
                <button id="viewPostCHChartBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">‚ö° c/h/Puesto (Barras)</button>
                <button id="viewWorkerPieChartBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üìä Cajas/Empleado (Circular)</button>
                <button id="viewWorkerCHPieChartBtn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">‚ö° c/h/Empleado (Circular)</button>
                <button id="viewConfeccionPorTrabajadorChartBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üìä Confecci√≥n/Trabajador</button>
                <button id="viewWorkerEvolutionBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üìà Evoluci√≥n Operarios</button>
                <button id="viewWorkerEvolutionCHBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">‚ö° Evoluci√≥n Operarios c/h</button>
                <button id="viewInsightsBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üí° Insights</button>
                <button id="viewTemporalComparisonBtn" class="bg-violet-500 hover:bg-violet-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üìà Comparar Per√≠odos</button>
                <button id="viewHeatmapBtn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üïê Heatmap Horas</button>
            </div>
            
            <!-- Segunda fila: An√°lisis avanzados y Acciones -->
            <div class="flex flex-wrap justify-between items-center gap-2">
                <!-- Bot√≥n IA destacado a la izquierda -->
                <button id="analizarTodosLocalAIBtn" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg text-sm shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-150 ease-in-out hidden flex items-center gap-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M9.5 2A7.5 7.5 0 002 9.5c0 1.76.61 3.37 1.63 4.66l-1.36 4.08a1 1 0 001.28 1.28l4.08-1.36A7.47 7.47 0 009.5 17a7.5 7.5 0 000-15zM9 12H8v-1h1v1zm2 0h-1v-1h1v1zm2 0h-1v-1h1v1zm0-3H8V8h5v1z"/><circle cx="17" cy="17" r="5" fill="currentColor" opacity="0.5"/><path d="M17 14v6m-3-3h6" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
                    <span class="font-extrabold">ü§ñ AN√ÅLISIS IA</span>
                    <span class="text-xs bg-yellow-400 text-purple-900 px-1.5 py-0.5 rounded-full font-bold">PRO</span>
                </button>
                
                <!-- Botones de la derecha -->
                <div class="flex flex-wrap gap-2">
                    <button id="viewDistributionBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üéØ Distribuci√≥n Puestos</button>
                    <button id="viewRankingBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üèÜ Top 10 Cajas</button>
                    <button id="viewRankingCHBtn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">‚ö° Top 10 c/h</button>
                    <button id="viewFullRankingBtn" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">üìã Ranking Completo Cajas</button>
                    <button id="viewFullRankingCHBtn" class="bg-lime-500 hover:bg-lime-600 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out hidden">‚ö° Ranking Completo c/h</button>
                    <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 2l5 5h-5V4zM8 12h8v2H8v-2zm0 4h8v2H8v-2z"/></svg>
                        Excel
                    </button>
                    <button id="printBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-xs transition-colors duration-150 ease-in-out flex items-center gap-1">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
                        Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="kpiCardContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 p-4 md:p-6 no-print">
        <div class="kpi-card">
            <div class="kpi-title">Total Cajas Producidas</div>
            <div id="kpiTotalCajas" class="kpi-value">-</div>
            <div id="kpiTotalCajasIndicator" class="kpi-indicator"></div>
            <div id="kpiTotalCajasTooltip" class="kpi-tooltip">Suma total de todas las cajas producidas en el per√≠odo</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Trabajadores Activos</div>
            <div id="kpiTrabajadoresActivos" class="kpi-value">-</div>
            <div id="kpiTrabajadoresIndicator" class="kpi-indicator"></div>
            <div id="kpiTrabajadoresTooltip" class="kpi-tooltip">N√∫mero de operarios con producci√≥n registrada</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Promedio Cajas/Hora</div>
            <div id="kpiAvgCajasHora" class="kpi-value">-</div>
            <div id="kpiAvgIndicator" class="kpi-indicator"></div>
            <div id="kpiAvgTooltip" class="kpi-tooltip">Productividad promedio de todo el equipo</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Operario Top</div>
            <div id="kpiPuestoMasProductivo" class="kpi-value">-</div>
            <div id="kpiTopIndicator" class="kpi-indicator"></div>
            <div id="kpiTopTooltip" class="kpi-tooltip">Trabajador con mayor producci√≥n del per√≠odo</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Eficiencia Global</div>
            <div id="kpiEficienciaGlobal" class="kpi-value">-</div>
            <div id="kpiEficienciaIndicator" class="kpi-indicator"></div>
            <div id="kpiEficienciaTooltip" class="kpi-tooltip">Eficiencia vs promedio de los 3 mejores trabajadores</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">Tiempo Promedio/Caja</div>
            <div id="kpiTiempoPromedio" class="kpi-value">-</div>
            <div id="kpiTiempoIndicator" class="kpi-indicator"></div>
            <div id="kpiTiempoTooltip" class="kpi-tooltip">Tiempo promedio invertido por cada caja producida</div>
        </div>
    </div>

    <div id="searchInputContainer" class="p-4 md:px-6 no-print">
        <input type="text" id="searchInput" placeholder="Buscar en tabla (Nombre, C√≥digo, Puesto, Confecci√≥n)..." class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" autocomplete="off">
    </div>

    <div class="overflow-x-auto p-4 md:p-6">
        <table id="workersTable" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codigo</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unidades (Turno) <span id="totalUnidadesTurnoHeader" class="font-bold"></span></th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puesto</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inicio Puesto</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fin Puesto</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cajas/Hora</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confeccion</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="workersTableBody">
                <tr id="loadingRow"><td colspan="9" class="px-4 py-4 text-center text-gray-500">Cargando datos...</td></tr>
                <tr id="errorRow" class="hidden"><td colspan="9" class="px-4 py-4 text-center text-red-500"></td></tr>
                <tr id="noDataRow" class="hidden"><td colspan="9" class="px-4 py-4 text-center text-gray-500">No se encontraron datos.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="passwordModal" class="modal hidden no-print">
    <div class="modal-content">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Introducir Contrase√±a</h3>
        <div>
            <input type="password" id="passwordInput" class="block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 mb-2" placeholder="Contrase√±a" autocomplete="new-password">
            <p id="passwordError" class="text-red-500 text-sm mb-4 hidden">Contrase√±a incorrecta.</p>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button type="button" id="cancelPasswordBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 rounded-md shadow-sm">Cancelar</button>
            <button type="button" id="submitPasswordBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-md shadow-sm">Desbloquear</button>
        </div>
    </div>
</div>

<div id="editQuantityModal" class="modal hidden no-print">
    <div class="modal-content">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Editar Cantidad</h3>
        <div>
            <label for="editQuantityInput" class="block text-sm font-medium text-gray-700">Nueva cantidad:</label>
            <input type="number" id="editQuantityInput" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 mb-2" placeholder="Cantidad" autocomplete="off">
            <p id="editQuantityError" class="text-red-500 text-sm mb-4 hidden">Valor inv√°lido.</p>
            <p id="editApiStatus" class="text-sm mt-2"></p>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button type="button" id="cancelEditBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 rounded-md shadow-sm">Cancelar</button>
            <button type="button" id="saveEditBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 border border-transparent rounded-md shadow-sm">Guardar</button>
        </div>
    </div>
</div>

<div id="analysisModal" class="modal hidden no-print">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="analysisModalTitle" class="text-lg font-medium leading-6 text-gray-900">An√°lisis de Rendimiento</h3>
            <button type="button" id="closeAnalysisModalBtn" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="analysisModalContent" class="text-sm text-gray-700 whitespace-pre-wrap overflow-y-auto" style="max-height: calc(90vh - 100px); margin-top:1rem; margin-bottom:1rem;"></div>
        <div id="analysisModalStatus" class="mt-3 text-sm text-gray-500"></div>
        <div class="modal-footer">
            <button type="button" id="okAnalysisModalBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-md shadow-sm">OK</button>
        </div>
    </div>
</div>

<div id="promptEditModal" class="modal hidden no-print">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="promptEditModalTitle" class="text-lg font-medium leading-6 text-gray-900">ü§ñ Editar Prompt de IA</h3>
            <button type="button" id="closePromptEditModalBtn" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div class="p-4">
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">‚ÑπÔ∏è Edita el prompt que se enviar√° a la IA. Usa las variables disponibles como referencia.</p>
            </div>
            <div class="mb-4">
                <label for="promptTextArea" class="block text-sm font-medium text-gray-700 mb-2">Prompt:</label>
                <textarea id="promptTextArea" rows="12" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm font-mono" placeholder="Escribe tu prompt aqu√≠..."></textarea>
            </div>
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                <p class="text-xs font-semibold text-blue-800 mb-1">üìä Datos disponibles:</p>
                <p id="promptDataSummary" class="text-xs text-blue-700"></p>
            </div>
        </div>
        <div class="modal-footer flex justify-between">
            <button type="button" id="cancelPromptEditBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 rounded-md shadow-sm">Cancelar</button>
            <button type="button" id="sendPromptBtn" class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 rounded-md shadow-sm flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                Enviar a IA
            </button>
        </div>
    </div>
</div>

<div id="chartModal" class="modal hidden no-print">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="chartModalTitle" class="text-lg font-medium leading-6 text-gray-900">üìä Gr√°fico de Producci√≥n</h3>
            <div class="flex items-center">
                 <button type="button" id="toggleFullscreenChartBtn" class="text-gray-500 hover:text-gray-700 mr-2 fullscreen-icon" title="Pantalla Completa">
                    <svg id="expandIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg>
                    <svg id="contractIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19v-4m0 0h4M15 19l-5-5M5 9V5m0 0h4M5 5l5 5m0 0M9 5h4M5 9v4m0 0M19 9v4" /></svg>
                </button>
                <button type="button" id="closeChartModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </div>
        <div id="chartContainer" class="chart-container"></div>
        <div class="modal-footer">
            <button type="button" id="okChartModalBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-md shadow-sm">OK</button>
        </div>
    </div>
</div>

<div id="countdownModal" class="countdown-modal hidden no-print">
    <div class="countdown-content">
        <h2 class="text-2xl font-bold mb-4">‚ö†Ô∏è Sesi√≥n Expirando</h2>
        <p class="mb-4">Tu sesi√≥n expirar√° en:</p>
        <div id="countdownNumber" class="countdown-number">5</div>
        <p class="mt-4 text-sm opacity-80">Mueve el rat√≥n para mantener la sesi√≥n activa</p>
        <button id="extendSessionBtn" class="mt-4 px-4 py-2 bg-white text-red-600 rounded-lg font-bold hover:bg-gray-100 transition-colors">
            Extender Sesi√≥n
        </button>
    </div>
</div>

<div id="sessionIndicator" class="session-indicator hidden no-print">
    <span id="sessionTime">Sesi√≥n activa</span>
</div>

<div id="tooltip" class="tooltip"></div>

<script>
    // URLs de API para datos de trabajadores y edici√≥n
    const apiBaseUrl = '/api/workers/all-list/completed';
    const apiEditPostUrl = '/api/operator-post/update-count';

    // URLs y configuraci√≥n para la IA Local (din√°micas desde API de prompts)
    let localAISubmitTaskUrl = null;              // se setea tras cargar prompt
    let localAITaskStatusUrlBase = null;          // se setea tras cargar prompt
    const defaultLocalAIModelName = 'gemma3:4b-it-qat';
    let localAIApiToken = null;                   // se setea tras cargar prompt
    let iaEnabled = false;                        // se activa al recibir config v√°lida
    const localAICallbackUrl = 'https://tudominio.com/webhook/ollama-callback';

    // Configuraci√≥n para obtener prompts desde la API de Laravel
    const apiPromptBaseUrl = '/api/ia-prompts/';
    const promptApiKeys = {
        individual: 'individual_worker_analysis_v3',
        global: 'overall_team_analysis_v3'
    };

    const fallbackIndividualPrompt = "Analiza al trabajador: {{workerName}} con datos: {{postsDetails}}. Compara con: {{overallSummary}}";
    const fallbackGlobalPrompt = "Analiza el rendimiento global con estos datos: {{overallSummary}}";

    // Variables globales (declaraciones)
    let tableBody, loadingRow, errorRow, errorCell, noDataRow, exportExcelBtn, printBtn,
        dateRangeSelect, filterPostsCheckbox, analizarTodosLocalAIBtn,
        viewWorkerChartBtn, viewWorkerCHChartBtn, viewPostChartBtn, viewPostCHChartBtn, viewWorkerPieChartBtn, viewWorkerCHPieChartBtn, viewConfeccionPorTrabajadorChartBtn,
        viewWorkerEvolutionBtn, viewWorkerEvolutionCHBtn, viewDistributionBtn, viewRankingBtn, viewRankingCHBtn, viewFullRankingBtn, viewFullRankingCHBtn,
        viewInsightsBtn, viewTemporalComparisonBtn, viewHeatmapBtn,
        totalUnidadesTurnoHeader,
        lockButton, lockIcon, unlockIcon, passwordModal, passwordInput, passwordError,
        cancelPasswordBtn, submitPasswordBtn, editQuantityModal, editQuantityInput,
        editQuantityError, editApiStatus, cancelEditBtn, saveEditBtn,
        analysisModal, analysisModalTitle, analysisModalContent, analysisModalStatus,
        closeAnalysisModalBtn, okAnalysisModalBtn,
        promptEditModal, promptTextArea, promptDataSummary, closePromptEditModalBtn, cancelPromptEditBtn, sendPromptBtn,
        chartModal, chartModalTitleEl, chartContainerEl, toggleFullscreenChartBtn, expandIcon, contractIcon,
        tooltip,
        kpiCardContainer, kpiTotalCajas, kpiTrabajadoresActivos, kpiAvgCajasHora, kpiPuestoMasProductivo,
        kpiEficienciaGlobal, kpiTiempoPromedio,
        searchInput,
        countdownModal, countdownNumber, extendSessionBtn, sessionIndicator, sessionTime;

    let originalWorkersData = [];
    let displayedPostRowsCount = 0;
    let liveUpdateIntervalId = null;
    let isLocked = true;
    let currentEditContext = null;
    let currentLocalAITaskId = null;
    let localAIPollingIntervalId = null;
    let currentChartType = null;
    let pendingPromptData = null; // Para guardar modelo y t√≠tulo mientras se edita
    let customDateRangeContainer, customDateFrom, customDateTo, applyCustomDateBtn;
    
    // Variables de sesi√≥n
    let sessionTimeout = null;
    let countdownInterval = null;
    let lastActivity = Date.now();
    let sessionDuration = 30 * 60 * 1000; // 30 minutos
    let warningTime = 10 * 1000; // Advertir 10 segundos antes
    let countdownTime = 5; // Countdown de 5 segundos
    const SESSION_KEY = 'workersDashboardSession';
    const PASSWORD_HASH = 'boisolo'; // En producci√≥n usar hash real 

    const dateTimeFormatOptions = { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false };
    const dateFormatter = new Intl.DateTimeFormat(navigator.language || 'es-ES', dateTimeFormatOptions);

    // --- Funciones de Gesti√≥n de Sesi√≥n ---
    
    function saveSession() {
        const sessionData = {
            timestamp: Date.now(),
            isUnlocked: true
        };
        localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
    }
    
    function loadSession() {
        try {
            const sessionData = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (sessionData && sessionData.isUnlocked) {
                const elapsed = Date.now() - sessionData.timestamp;
                if (elapsed < sessionDuration) {
                    return true; // Sesi√≥n v√°lida
                }
            }
        } catch (e) {
            console.log('Error loading session:', e);
        }
        localStorage.removeItem(SESSION_KEY);
        return false;
    }
    
    function clearSession() {
        localStorage.removeItem(SESSION_KEY);
        if (sessionTimeout) {
            clearTimeout(sessionTimeout);
            sessionTimeout = null;
        }
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
    }
    
    function resetSessionTimer() {
        lastActivity = Date.now();
        
        if (sessionTimeout) {
            clearTimeout(sessionTimeout);
        }
        
        // Actualizar timestamp en localStorage
        if (!isLocked) {
            saveSession();
        }
        
        // Configurar nuevo timeout
        sessionTimeout = setTimeout(() => {
            startLogoutCountdown();
        }, sessionDuration - warningTime);
        
        updateSessionIndicator();
    }
    
    function startLogoutCountdown() {
        if (isLocked) return; // No hacer countdown si ya est√° bloqueado
        
        countdownTime = 5;
        if (countdownModal && countdownNumber) {
            countdownNumber.textContent = countdownTime;
            countdownModal.classList.remove('hidden');
        }
        
        if (sessionIndicator) {
            sessionIndicator.classList.add('warning');
        }
        
        countdownInterval = setInterval(() => {
            countdownTime--;
            if (countdownNumber) {
                countdownNumber.textContent = countdownTime;
            }
            
            if (countdownTime <= 0) {
                forceLogout();
            }
        }, 1000);
    }
    
    function forceLogout() {
        clearSession();
        
        if (countdownModal) {
            countdownModal.classList.add('hidden');
        }
        
        if (sessionIndicator) {
            sessionIndicator.classList.add('hidden');
        }
        
        toggleLockState(true);
        
        // Mostrar mensaje de sesi√≥n expirada
        if (passwordModal && passwordError) {
            passwordError.textContent = 'üîí Sesi√≥n expirada por inactividad. Introduce la contrase√±a nuevamente.';
            passwordError.classList.remove('hidden');
        }
    }
    
    function extendSession() {
        if (countdownInterval) {
            clearInterval(countdownInterval);
            countdownInterval = null;
        }
        
        if (countdownModal) {
            countdownModal.classList.add('hidden');
        }
        
        if (sessionIndicator) {
            sessionIndicator.classList.remove('warning');
        }
        
        resetSessionTimer();
    }
    
    function updateSessionIndicator() {
        if (!sessionIndicator || !sessionTime || isLocked) {
            if (sessionIndicator) sessionIndicator.classList.add('hidden');
            return;
        }
        
        const elapsed = Date.now() - lastActivity;
        const remaining = sessionDuration - elapsed;
        
        if (remaining > 0) {
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            sessionTime.textContent = `Sesi√≥n: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            sessionIndicator.classList.remove('hidden');
        } else {
            sessionIndicator.classList.add('hidden');
        }
    }
    
    function setupActivityListeners() {
        const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        
        events.forEach(event => {
            document.addEventListener(event, () => {
                if (!isLocked) {
                    resetSessionTimer();
                }
            }, true);
        });
    }

    // --- Definiciones de Funciones ---

    async function getPromptFromServer(promptApiKey) {
        try {
            const response = await fetch(`${apiPromptBaseUrl}${promptApiKey}`);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Error al obtener prompt ${promptApiKey} desde API: ${response.status} - ${errorText}. Usando prompt de fallback.`);
                return { content: promptApiKey === promptApiKeys.individual ? fallbackIndividualPrompt : fallbackGlobalPrompt, modelName: defaultLocalAIModelName, error: true, errorMessage: `Error API ${response.status}: No se pudo cargar el prompt '${promptApiKey}'.` };
            }
            const promptData = await response.json();
            // Si vienen ai_url y ai_token, configuramos las URLs y token para IA
            if (promptData.ai_url && promptData.ai_token) {
                localAISubmitTaskUrl = `${promptData.ai_url}/api/ollama-tasks`;
                localAITaskStatusUrlBase = `${promptData.ai_url}/api/ollama-tasks/`;
                localAIApiToken = promptData.ai_token;
                iaEnabled = true;
                console.log('IA configurada desde API de prompts:', { localAISubmitTaskUrl, localAITaskStatusUrlBase });
            } else {
                iaEnabled = false;
                localAISubmitTaskUrl = null;
                localAITaskStatusUrlBase = null;
                localAIApiToken = null;
                console.warn('IA no configurada desde API de prompts (faltan ai_url o ai_token).');
            }
            if (!promptData.content) {
                console.error(`Prompt ${promptApiKey} obtenido de API pero sin contenido. Usando fallback.`);
                return { content: promptApiKey === promptApiKeys.individual ? fallbackIndividualPrompt : fallbackGlobalPrompt, modelName: promptData.model_name || defaultLocalAIModelName, error: true, errorMessage: `Prompt '${promptApiKey}' sin contenido.` };
            }
            return { content: promptData.content, modelName: promptData.model_name || defaultLocalAIModelName, error: false };
        } catch (error) {
            console.error(`Error de red al obtener prompt ${promptApiKey}:`, error, ". Usando prompt de fallback.");
            return { content: promptApiKey === promptApiKeys.individual ? fallbackIndividualPrompt : fallbackGlobalPrompt, modelName: defaultLocalAIModelName, error: true, errorMessage: `Error de red al cargar prompt '${promptApiKey}'.` };
        }
    }

    function showPasswordModal() {
        if(passwordModal && passwordInput && passwordError) {
            passwordInput.value = ''; passwordError.classList.add('hidden');
            passwordModal.classList.remove('hidden'); passwordInput.focus();
        }
    }
    function hidePasswordModal() { if(passwordModal) passwordModal.classList.add('hidden'); }

    function updateHeaderButtonsState() {
        const hasData = displayedPostRowsCount > 0;
        const actionButtons = [analizarTodosLocalAIBtn, viewWorkerChartBtn, viewWorkerCHChartBtn, viewPostChartBtn, viewPostCHChartBtn, viewWorkerPieChartBtn, viewWorkerCHPieChartBtn, viewConfeccionPorTrabajadorChartBtn, viewWorkerEvolutionBtn, viewWorkerEvolutionCHBtn, viewDistributionBtn, viewRankingBtn, viewRankingCHBtn, viewFullRankingBtn, viewFullRankingCHBtn, viewInsightsBtn, viewTemporalComparisonBtn, viewHeatmapBtn];
        actionButtons.forEach(btn => {
            if (btn) {
                if (isLocked || !hasData) { btn.classList.add('hidden'); btn.disabled = true; }
                else { btn.classList.remove('hidden'); btn.disabled = false; }
            }
        });
        if (exportExcelBtn) exportExcelBtn.disabled = !hasData;
        if (kpiCardContainer) {
            if (isLocked || !hasData) kpiCardContainer.classList.add('hidden');
            else kpiCardContainer.classList.remove('hidden');
        }
    }

    function toggleLockState(locked) {
        isLocked = locked;
        if (isLocked) { 
            if(lockIcon) lockIcon.classList.remove('hidden'); 
            if(unlockIcon) unlockIcon.classList.add('hidden');
            clearSession();
            if(sessionIndicator) sessionIndicator.classList.add('hidden');
        }
        else { 
            if(lockIcon) lockIcon.classList.add('hidden'); 
            if(unlockIcon) unlockIcon.classList.remove('hidden');
            saveSession();
            resetSessionTimer();
            // Actualizar indicador cada segundo
            setInterval(() => {
                if (!isLocked) updateSessionIndicator();
            }, 1000);
        }
        updateHeaderButtonsState(); 
        populateTable(originalWorkersData);
    }
    
    function showEditQuantityModal(workerClientId, postIndex, currentQuantity, quantityCell, cajasHoraCell, workerUnitsCell) {
        currentEditContext = { workerClientId, postIndex, currentQuantity, quantityCell, cajasHoraCell, workerUnitsCell };
        if(editQuantityInput) editQuantityInput.value = currentQuantity;
        if(editQuantityError) editQuantityError.classList.add('hidden');
        if(editApiStatus) { editApiStatus.textContent = ''; editApiStatus.classList.remove('text-red-500', 'text-green-500');}
        if(editQuantityModal) editQuantityModal.classList.remove('hidden');
        if(editQuantityInput) {editQuantityInput.focus(); editQuantityInput.select(); }
        if(saveEditBtn) { saveEditBtn.disabled = false; saveEditBtn.textContent = 'Guardar'; }
    }
    function hideEditQuantityModal() { if(editQuantityModal) editQuantityModal.classList.add('hidden'); currentEditContext = null; }

    async function handleSaveEdit() {
        const newQuantity = parseFloat(editQuantityInput.value);
        if (isNaN(newQuantity) || newQuantity < 0) {
            if(editQuantityError) { editQuantityError.textContent = 'N√∫mero inv√°lido.'; editQuantityError.classList.remove('hidden'); }
            if(editApiStatus) editApiStatus.textContent = ''; return;
        }
        if(editQuantityError) editQuantityError.classList.add('hidden');
        if (currentEditContext) {
            const { workerClientId, postIndex, quantityCell, cajasHoraCell, workerUnitsCell } = currentEditContext;
            const worker = originalWorkersData.find(w => w.client_id === workerClientId);
            if (!worker || !worker.operator_posts || !worker.operator_posts[postIndex]) { if(editApiStatus) {editApiStatus.textContent = 'Error: Datos no encontrados.'; editApiStatus.classList.add('text-red-500');} return; }
            const post = worker.operator_posts[postIndex]; const postId = post.id;
            if (typeof postId === 'undefined') { if(editApiStatus) {editApiStatus.textContent = 'Error: Falta ID de puesto.'; editApiStatus.classList.add('text-red-500');} console.error("Post ID undefined:", post); return; }
            if(saveEditBtn) {saveEditBtn.disabled = true; saveEditBtn.textContent = 'Guardando...';}
            if(editApiStatus) {editApiStatus.textContent = 'Actualizando...'; editApiStatus.classList.remove('text-red-500', 'text-green-500');}
            const formData = new URLSearchParams(); formData.append('id', postId); formData.append('count', newQuantity);
            try {
                const response = await fetch(apiEditPostUrl, { method: 'POST', headers: { 'Accept': 'application/json', 'Authorization': 'Bearer 915afe8b7fabc2ca8d759761b0fe159f88bf0f064be7e4cd6a1f99021eff4e3b' }, body: formData });
                if (!response.ok) { let err = `Error Servidor: ${response.status}`; try { const eD = await response.json(); err = eD.message || err; } catch (e) { const tE = await response.text(); if(tE) err = tE; } throw new Error(err); }
                const result = await response.json();
                if (result.status === 'success') {
                    post.count = newQuantity; if(quantityCell) quantityCell.childNodes[0].nodeValue = newQuantity + ' ';
                    if(cajasHoraCell) cajasHoraCell.textContent = calculateCajasHora(post.count, post.created_at, post.finish_at);
                    if (cajasHoraCell && cajasHoraCell.classList.contains('live-cajas-hora')) cajasHoraCell.dataset.count = newQuantity;
                    const totalQtySum = worker.operator_posts.reduce((s, p) => s + ((p.count??0)>0?(p.count??0):0), 0); if(workerUnitsCell) workerUnitsCell.textContent = totalQtySum;
                    if(editApiStatus) {editApiStatus.textContent = result.message || 'Actualizado.'; editApiStatus.classList.add('text-green-500');} setTimeout(hideEditQuantityModal, 1500);
                    updateGrandTotalUnidades(); updateKPICards();
                } else { throw new Error(result.message || 'API indic√≥ fallo.'); }
            } catch (error) { console.error('Error al guardar:', error); if(editApiStatus){editApiStatus.textContent = `Error: ${error.message}`; editApiStatus.classList.add('text-red-500');}
            } finally { if(saveEditBtn){saveEditBtn.disabled = false; saveEditBtn.textContent = 'Guardar';} }
        }
    }
    
    function showAnalysisModal(title = "An√°lisis de Rendimiento") {
        if(analysisModalTitle) analysisModalTitle.textContent = title;
        if(analysisModalContent) analysisModalContent.innerHTML = '<div class="spinner"></div>';
        if(analysisModalStatus) { analysisModalStatus.textContent = `Generando an√°lisis...`; analysisModalStatus.classList.remove('text-red-500');}
        if(analysisModal) analysisModal.classList.remove('hidden');
    }
    function hideAnalysisModal() {
        if(analysisModal) analysisModal.classList.add('hidden');
        if (localAIPollingIntervalId) { clearInterval(localAIPollingIntervalId); localAIPollingIntervalId = null; currentLocalAITaskId = null; }
    }

    function generateOverallSummaryTextForContext() {
        const workersToAnalyze = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        if (workersToAnalyze.length === 0) return "No hay datos globales de trabajadores disponibles para comparaci√≥n.";
        let totalCajasGlobal = 0, totalHorasTrabajadasGlobal = 0, puestosConteo = {}, individualWorkerSummaries = [];
        workersToAnalyze.forEach(worker => {
            let workerCajas = 0, workerHoras = 0;
            (worker.operator_posts || []).filter(p => (p.count ?? 0) > 0).forEach(post => {
                const cantidad = post.count || 0; workerCajas += cantidad; totalCajasGlobal += cantidad;
                if(post.rfid_reading?.name) puestosConteo[post.rfid_reading.name] = (puestosConteo[post.rfid_reading.name] || 0) + cantidad;
                if (post.created_at) { const start = new Date(post.created_at), end = post.finish_at ? new Date(post.finish_at) : new Date(); if (end > start) { const dH = (end.getTime() - start.getTime()) / 3600000; workerHoras += dH; totalHorasTrabajadasGlobal += dH; }}
            });
            individualWorkerSummaries.push({name: worker.name || `ID ${worker.client_id}`, cajas: workerCajas, eficiencia: workerHoras > 0 ? (workerCajas / workerHoras).toFixed(2) : 'N/A'});
        });
        individualWorkerSummaries.sort((a, b) => b.cajas - a.cajas);
        const topPerformers = individualWorkerSummaries.slice(0, Math.min(3, individualWorkerSummaries.length));
        const lowPerformers = individualWorkerSummaries.slice(Math.max(0, individualWorkerSummaries.length - 3)).reverse();
        const avgCajasHoraGlobal = totalHorasTrabajadasGlobal > 0 ? (totalCajasGlobal / totalHorasTrabajadasGlobal).toFixed(2) : 'N/A';
        let puestosSummary = Object.entries(puestosConteo).sort(([,a],[,b])=>b-a).map(([n,c])=>`  - ${n}: ${c} cajas`).join('\n')||"  - Sin datos por puesto.";
        let topSummary = topPerformers.map(w=>`  - ${w.name}: ${w.cajas} cajas (Ef: ${w.eficiencia} c/h)`).join('\n')||"  - N/A";
        let lowSummary = lowPerformers.map(w=>`  - ${w.name}: ${w.cajas} cajas (Ef: ${w.eficiencia} c/h)`).join('\n')||"  - N/A";
        return `- Trabajadores activos (con producci√≥n): ${workersToAnalyze.length}\n- Total Cajas Equipo: ${totalCajasGlobal}\n- Promedio Cajas/Hora Global: ${avgCajasHoraGlobal} c/h\n- Puestos con actividad: ${Object.keys(puestosConteo).length}\n- Distribuci√≥n Cajas/Puesto:\n${puestosSummary}\n- Top Productores:\n${topSummary}\n- Menor Producci√≥n:\n${lowSummary}`.trim();
    }

    async function fetchLocalAIWorkerAnalysis(worker) {
        const analysisTitle = `An√°lisis de ${worker.name || 'Desconocido'} (IA Local)`;
        showAnalysisModal(analysisTitle);
        const promptInfo = await getPromptFromServer(promptApiKeys.individual);
        if (promptInfo.error) {
            if(analysisModalContent) analysisModalContent.textContent = promptInfo.errorMessage || "Error al cargar prompt individual.";
            if(analysisModalStatus) analysisModalStatus.textContent = "Fallo al cargar prompt."; return;
        }
        let promptTemplate = promptInfo.content; const modelToUse = promptInfo.modelName;
        const workerName = worker.name || 'Desconocido';
        let workerTotalCajas = 0, workerTotalDurationHours = 0, activePostsCount = 0;
        let postsDetails = "Trabajador sin puestos con producci√≥n.";
        if (worker.operator_posts) {
            const activeP = worker.operator_posts.filter(p => (p.count ?? 0) > 0); activePostsCount = activeP.length;
            if (activePostsCount > 0) {
                postsDetails = activeP.map(p => {
                    const cant = p.count || 0; workerTotalCajas += cant;
                    const sD = p.created_at ? new Date(p.created_at) : null; let eD = p.finish_at ? new Date(p.finish_at) : (sD ? new Date() : null);
                    if (sD && eD && eD > sD) workerTotalDurationHours += (eD.getTime() - sD.getTime()) / 3600000;
                    return `- P: ${p.rfid_reading?.name||'N/A'}, Conf: ${p.product_list?.name||'N/A'}, I: ${sD?dateFormatter.format(sD):'N/A'}, F: ${p.finish_at?dateFormatter.format(new Date(p.finish_at)):'Activo'}, Q: ${cant}, C/h: ${calculateCajasHora(cant,p.created_at,p.finish_at)}`;
                }).join('\n\n');
            }
        }
        const workerAvgCajasHora = workerTotalDurationHours > 0 ? (workerTotalCajas / workerTotalDurationHours).toFixed(2) : 'N/A';
        const overallSummaryCtx = generateOverallSummaryTextForContext();
        promptTemplate = promptTemplate.replace(/{{workerName}}/g, workerName).replace(/{{workerClientId}}/g, worker.client_id||'N/A').replace(/{{activePostsCount}}/g, activePostsCount).replace(/{{workerTotalCajas}}/g, workerTotalCajas).replace(/{{workerAvgCajasHora}}/g, workerAvgCajasHora).replace(/{{postsDetails}}/g, postsDetails).replace(/{{overallSummary}}/g, overallSummaryCtx);
        await submitLocalAITask(promptTemplate, analysisTitle, modelToUse);
    }

    async function fetchLocalAIOverallAnalysis() {
        const analysisTitle = "An√°lisis Global de Trabajadores (IA Local)";
        
        // Cargar prompt desde servidor
        const promptInfo = await getPromptFromServer(promptApiKeys.global);
        if (promptInfo.error) {
            alert(promptInfo.errorMessage || "Error al cargar prompt global.");
            return;
        }
        
        let promptTemplate = promptInfo.content;
        const modelToUse = promptInfo.modelName;
        const overallSummaryText = generateOverallSummaryTextForContext();
        
        if (overallSummaryText.startsWith("No hay datos globales")) {
            alert('No hay datos para an√°lisis global.');
            return;
        }
        
        // Reemplazar variables en el prompt
        promptTemplate = promptTemplate.replace(/{{overallSummary}}/g, overallSummaryText);
        
        // Mostrar modal de edici√≥n de prompt
        showPromptEditModal(promptTemplate, analysisTitle, modelToUse, overallSummaryText);
    }
    
    function showPromptEditModal(prompt, title, model, dataSummary) {
        if (!promptEditModal || !promptTextArea) return;
        
        // Guardar datos temporales
        pendingPromptData = { title, model };
        
        // Llenar el textarea con el prompt
        promptTextArea.value = prompt;
        
        // Mostrar resumen de datos
        if (promptDataSummary) {
            const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
            const totalWorkers = dataToProcess.length;
            const totalCajas = dataToProcess.reduce((sum, w) => sum + (w.operator_posts || []).reduce((s, p) => s + (Number(p.count) || 0), 0), 0);
            promptDataSummary.textContent = `${totalWorkers} trabajadores, ${totalCajas} cajas totales. El prompt incluye todos los datos del per√≠odo.`;
        }
        
        // Mostrar modal
        promptEditModal.classList.remove('hidden');
        promptTextArea.focus();
    }
    
    function hidePromptEditModal() {
        if (promptEditModal) {
            promptEditModal.classList.add('hidden');
            pendingPromptData = null;
        }
    }
    
    function sendEditedPrompt() {
        if (!promptTextArea || !pendingPromptData) return;
        
        const editedPrompt = promptTextArea.value.trim();
        if (!editedPrompt) {
            alert('El prompt no puede estar vac√≠o');
            return;
        }
        
        // Cerrar modal de edici√≥n
        hidePromptEditModal();
        
        // Mostrar modal de an√°lisis y enviar
        showAnalysisModal(pendingPromptData.title);
        submitLocalAITask(editedPrompt, pendingPromptData.title, pendingPromptData.model);
    }

    async function submitLocalAITask(prompt, modalTitleText, modelName) {
        if (!iaEnabled || !localAISubmitTaskUrl || !localAIApiToken) {
            if (analysisModalContent) analysisModalContent.textContent = 'M√≥dulo de IA deshabilitado. Por favor, ponte en contacto con soporte.';
            if (analysisModalStatus) analysisModalStatus.textContent = '';
            return;
        }
        if(analysisModalStatus) analysisModalStatus.textContent = 'Enviando tarea a IA...';
        const effectiveModelName = modelName || defaultLocalAIModelName;
        try {
            // Usar FormData como en QC Confirmations
            const fd = new FormData();
            fd.append('prompt', prompt);
            if (effectiveModelName) fd.append('model', effectiveModelName);
            // opcional: callback_url si quieres utilizar webhooks
            // fd.append('callback_url', localAICallbackUrl);

            const response = await fetch(localAISubmitTaskUrl, {
                method: 'POST',
                headers: { 'Authorization': localAIApiToken },
                body: fd
            });
            if (!response.ok) { const eTxt = await response.text(); throw new Error(`Error env√≠o IA: ${response.status}. ${eTxt}`); }
            const result = await response.json();
            // Extraer taskId de m√∫ltiples formas (como en QC Confirmations)
            const taskId = (result && result.task && (result.task.id || result.task.uuid)) || result.id || result.task_id || result.uuid;
            if (taskId) { currentLocalAITaskId = taskId; if(analysisModalStatus) analysisModalStatus.textContent = `Tarea enviada (ID: ${currentLocalAITaskId}). Esperando...`; startLocalAIPolling(currentLocalAITaskId); }
            else { throw new Error(result.message || 'Respuesta IA inesperada (sin task_id).'); }
        } catch (error) { console.error('Error submitLocalAITask:', error); if(analysisModalContent) analysisModalContent.textContent = `Error env√≠o IA:\n${error.message}`; if(analysisModalStatus){analysisModalStatus.textContent = 'Error env√≠o.'; analysisModalStatus.classList.add('text-red-500');} }
    }

    function startLocalAIPolling(taskId) {
        if (localAIPollingIntervalId) clearInterval(localAIPollingIntervalId);
        pollLocalAITaskStatus(taskId);
        // Reducimos el intervalo de polling a 3s seg√∫n recomendaciones
        localAIPollingIntervalId = setInterval(() => pollLocalAITaskStatus(taskId), 3000);
    }

    async function pollLocalAITaskStatus(taskId) {
        if (!taskId) return;
        if(analysisModalStatus) analysisModalStatus.textContent = `Consultando tarea ${taskId} (IA)...`;
        const statusUrl = `${localAITaskStatusUrlBase}${taskId}`;
        try {
            if (!localAITaskStatusUrlBase || !localAIApiToken) { throw new Error('IA no configurada: faltan URL o token.'); }
            const response = await fetch(statusUrl, { headers: { 'Accept': 'application/json', 'Authorization': localAIApiToken } });
            if (!response.ok) {
                if (response.status === 404) {
                    if (analysisModalContent) analysisModalContent.textContent = `Tarea ${taskId} no encontrada.`;
                    if (analysisModalStatus) { analysisModalStatus.textContent = `No existe la tarea ${taskId}.`; analysisModalStatus.classList.add('text-red-500'); }
                    if (localAIPollingIntervalId) { clearInterval(localAIPollingIntervalId); localAIPollingIntervalId = null; currentLocalAITaskId = null; }
                    return;
                }
                if (analysisModalStatus) { analysisModalStatus.textContent = `Error consulta tarea ${taskId} (${response.status}). Reintentando...`; analysisModalStatus.classList.add('text-red-500'); }
                return;
            }
            const result = await response.json();
            const task = result.task;
            if (!task) {
                if (analysisModalStatus) { analysisModalStatus.textContent = `Respuesta inesperada. Reintentando...`; analysisModalStatus.classList.add('text-red-500'); }
                return;
            }
            const status = (task.status || '').toLowerCase();
            const errorText = (task.error || '').toString();
            const isWorkerProcessingHint = errorText.toLowerCase().includes('processing by worker-');
            if (status === 'completed' || (task.response && status !== 'failed')) {
                if (analysisModalContent) analysisModalContent.textContent = task.response || '';
                if (analysisModalStatus) { analysisModalStatus.textContent = 'An√°lisis (IA) completado.'; analysisModalStatus.classList.remove('text-red-500'); }
                if (localAIPollingIntervalId) { clearInterval(localAIPollingIntervalId); localAIPollingIntervalId = null; currentLocalAITaskId = null; }
            } else if (status === 'failed' && !isWorkerProcessingHint) {
                if (analysisModalContent) analysisModalContent.textContent = `Tarea ${task.id || taskId} (IA) fall√≥.` + (task.error ? `\nError: ${task.error}` : '');
                if (analysisModalStatus) { analysisModalStatus.textContent = `Fallo tarea ${task.id || taskId} (IA).`; analysisModalStatus.classList.add('text-red-500'); }
                if (localAIPollingIntervalId) { clearInterval(localAIPollingIntervalId); localAIPollingIntervalId = null; currentLocalAITaskId = null; }
            } else if (status === 'processing' || status === 'queued' || status === 'pending' || isWorkerProcessingHint || (!task.response)) {
                if (analysisModalStatus) { analysisModalStatus.textContent = `Tarea ${task.id || taskId} (IA) en proceso (${status || 'processing'})...`; analysisModalStatus.classList.remove('text-red-500'); }
                // continuar polling
            } else {
                if (analysisModalStatus) { analysisModalStatus.textContent = `Estado desconocido: ${status}. Continuando...`; }
            }
        } catch (error) {
            if(analysisModalStatus){analysisModalStatus.textContent = `Error de red al consultar tarea ${taskId}. Reintentando...`; analysisModalStatus.classList.add('text-red-500');}
        }
    }
    
    function showChartModal(chartType) {
        if(!chartModal || !chartModalTitleEl || !chartContainerEl) return;
        currentChartType = chartType; 
        chartModal.classList.remove('hidden');
        chartModal.classList.remove('modal-fullscreen'); 
        if(expandIcon) expandIcon.classList.remove('hidden');
        if(contractIcon) contractIcon.classList.add('hidden');
        renderCurrentChart();
    }

    function renderCurrentChart() { 
        if (!currentChartType || !chartModalTitleEl) return;
        if (currentChartType === 'workers') { chartModalTitleEl.textContent = 'üìä Producci√≥n Total por Trabajador'; renderProductionByWorkerChart(); }
        else if (currentChartType === 'workersCH') { chartModalTitleEl.textContent = '‚ö° Cajas/Hora por Trabajador'; renderProductionCHByWorkerChart(); }
        else if (currentChartType === 'postsBar') { chartModalTitleEl.textContent = 'üìä Producci√≥n Total por Puesto (Barras)'; renderProductionByPostBarChart(); }
        else if (currentChartType === 'postsCHBar') { chartModalTitleEl.textContent = '‚ö° Cajas/Hora por Puesto (Barras)'; renderProductionCHByPostBarChart(); }
        else if (currentChartType === 'workerPie') { chartModalTitleEl.textContent = 'üìä Distribuci√≥n de Cajas por Empleado (Circular)'; renderWorkerDistributionPieChart(); }
        else if (currentChartType === 'workerCHPie') { chartModalTitleEl.textContent = '‚ö° Distribuci√≥n c/h por Empleado (Circular)'; renderWorkerCHDistributionPieChart(); } 
        else if (currentChartType === 'confeccionPorTrabajador') { chartModalTitleEl.textContent = 'üìä Confecci√≥n por Trabajador (Apilado)'; renderConfeccionPorTrabajadorChart(); }
        else if (currentChartType === 'workerEvolution') { chartModalTitleEl.textContent = 'üìà Evoluci√≥n de Productividad por Operario'; renderWorkerEvolutionChart(); }
        else if (currentChartType === 'workerEvolutionCH') { chartModalTitleEl.textContent = '‚ö° Evoluci√≥n de Cajas/Hora por Operario'; renderWorkerEvolutionCHChart(); }
        else if (currentChartType === 'distribution') { chartModalTitleEl.textContent = 'üéØ Distribuci√≥n de Trabajadores por Puesto'; renderWorkerDistributionChart(); }
        else if (currentChartType === 'ranking') { chartModalTitleEl.textContent = 'üèÜ Top 10 - Total Cajas'; renderRankingChart(); }
        else if (currentChartType === 'rankingCH') { chartModalTitleEl.textContent = '‚ö° Top 10 - Cajas por Hora'; renderRankingCHChart(); }
        else if (currentChartType === 'fullRanking') { chartModalTitleEl.textContent = 'üìã Ranking Completo - Total Cajas'; renderFullRankingChart(); }
        else if (currentChartType === 'fullRankingCH') { chartModalTitleEl.textContent = '‚ö° Ranking Completo - Cajas por Hora'; renderFullRankingCHChart(); }
        else if (currentChartType === 'insights') { chartModalTitleEl.textContent = 'üí° Insights Inteligentes'; renderInsightsChart(); }
        else if (currentChartType === 'temporalComparison') { chartModalTitleEl.textContent = 'üìà Comparativa Temporal'; renderTemporalComparisonChart(); }
        else if (currentChartType === 'heatmap') { chartModalTitleEl.textContent = 'üïê Heatmap de Productividad por Hora'; renderHeatmapChart(); }
    }

    function hideChartModal() {
        if(chartModal) {
            chartModal.classList.add('hidden');
            chartModal.classList.remove('modal-fullscreen'); 
            if(expandIcon) expandIcon.classList.remove('hidden');
            if(contractIcon) contractIcon.classList.add('hidden');
        }
        d3.select("#chartContainer svg").remove();
        currentChartType = null;
    }

    function toggleChartFullscreen() {
        if (!chartModal || !expandIcon || !contractIcon) return;
        chartModal.classList.toggle('modal-fullscreen');
        const isFullscreen = chartModal.classList.contains('modal-fullscreen');
        expandIcon.classList.toggle('hidden', isFullscreen);
        contractIcon.classList.toggle('hidden', !isFullscreen);
        setTimeout(() => { renderCurrentChart(); }, 100); 
    }

    function renderProductionByWorkerChart() {
        d3.select("#chartContainer svg").remove();
        const dataForChart = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)))
            .map(worker => ({ name: worker.name || `ID: ${worker.client_id || 'N/A'}`, value: (worker.operator_posts || []).reduce((sum, post) => sum + (Number(post.count) || 0), 0) }))
            .filter(d => d.value > 0).sort((a, b) => b.value - a.value);
        drawBarChart(dataForChart, "Total de Cajas Producidas por Trabajador", "Trabajadores", "Total de Cajas");
    }
    function renderProductionCHByWorkerChart() {
        d3.select("#chartContainer svg").remove();
        const dataForChart = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)))
            .map(worker => {
                const totalCajas = (worker.operator_posts || []).reduce((sum, post) => sum + (Number(post.count) || 0), 0);
                let totalHours = 0;
                (worker.operator_posts || []).forEach(post => {
                    if (post.created_at) {
                        const start = new Date(post.created_at);
                        const end = post.finish_at ? new Date(post.finish_at) : new Date();
                        if (end > start) totalHours += (end - start) / 3600000;
                    }
                });
                return { name: worker.name || `ID: ${worker.client_id || 'N/A'}`, value: totalHours > 0 ? (totalCajas / totalHours) : 0 };
            })
            .filter(d => d.value > 0).sort((a, b) => b.value - a.value);
        drawBarChart(dataForChart, "Cajas por Hora por Trabajador", "Trabajadores", "Cajas/Hora");
    }
    function renderProductionByPostBarChart() {
        d3.select("#chartContainer svg").remove();
        const postCounts = {};
        filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData))).forEach(worker => {
            (worker.operator_posts || []).forEach(post => { if ((Number(post.count) || 0) > 0 && post.rfid_reading?.name) postCounts[post.rfid_reading.name] = (postCounts[post.rfid_reading.name] || 0) + (Number(post.count) || 0); });
        });
        const dataForChart = Object.entries(postCounts).map(([name, value]) => ({ name, value })).filter(d => d.value > 0).sort((a,b) => b.value - a.value);
        drawBarChart(dataForChart, "Total de Cajas Producidas por Puesto", "Puestos de Trabajo", "Total de Cajas");
    }
    function renderProductionCHByPostBarChart() {
        d3.select("#chartContainer svg").remove();
        const postData = {};
        filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData))).forEach(worker => {
            (worker.operator_posts || []).forEach(post => {
                if (post.rfid_reading?.name && post.created_at) {
                    const postName = post.rfid_reading.name;
                    if (!postData[postName]) postData[postName] = { cajas: 0, hours: 0 };
                    postData[postName].cajas += Number(post.count) || 0;
                    const start = new Date(post.created_at);
                    const end = post.finish_at ? new Date(post.finish_at) : new Date();
                    if (end > start) postData[postName].hours += (end - start) / 3600000;
                }
            });
        });
        const dataForChart = Object.entries(postData).map(([name, data]) => ({ name, value: data.hours > 0 ? (data.cajas / data.hours) : 0 })).filter(d => d.value > 0).sort((a,b) => b.value - a.value);
        drawBarChart(dataForChart, "Cajas por Hora por Puesto", "Puestos de Trabajo", "Cajas/Hora");
    }
    function drawBarChart(chartData, titleText, xAxisLabelText, yAxisLabelText) {
        if (!chartContainerEl) return;
        if (chartData.length === 0) { chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para mostrar.</p>'; return; }
        chartContainerEl.innerHTML = '';
        
        const rect = chartContainerEl.getBoundingClientRect();
        const containerWidth = rect.width;
        const dynamicContainerHeight = rect.height > 50 ? rect.height : 450;

        const margin = {top: 40, right: 30, bottom: 120, left: 70};
        const minBarWidth = 30; 
        const calculatedWidth = Math.max(containerWidth - margin.left - margin.right, chartData.length * minBarWidth);
        const width = calculatedWidth;
        const height = dynamicContainerHeight - margin.top - margin.bottom;

        if (height <= 0 || width <=0) { console.error("Dimensiones de gr√°fico inv√°lidas:", width, height); chartContainerEl.innerHTML = '<p class="text-center text-red-500 p-4">Error al calcular dimensiones del gr√°fico.</p>'; return;}
        const svg = d3.select("#chartContainer").append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3.scaleBand().range([0, width]).domain(chartData.map(d => d.name)).padding(0.3);
        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").attr("transform", "translate(-10,5)rotate(-45)").style("text-anchor", "end").style("font-size", "10px");
        const y = d3.scaleLinear().domain([0, d3.max(chartData, d => d.value) || 10]).nice().range([height, 0]);
        svg.append("g").call(d3.axisLeft(y).ticks(Math.min(10, d3.max(chartData, d => d.value) || 10)));
        const bars = svg.selectAll(".bar").data(chartData).join("rect")
            .attr("class", "bar")
            .attr("x", d => x(d.name))
            .attr("y", height)
            .attr("width", x.bandwidth())
            .attr("height", 0)
            .on("mouseover", function(event, d) { 
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`<strong>${d.name}</strong><br/>Cajas: ${d.value}<br/>Porcentaje: ${((d.value / d3.sum(chartData, item => item.value)) * 100).toFixed(1)}%`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 15) + "px");
                d3.select(this).style("fill", "#1d4ed8").style("stroke", "#ffffff").style("stroke-width", "2px");
            })
            .on("mouseout", function() { 
                tooltip.transition().duration(500).style("opacity", 0);
                d3.select(this).style("fill", "steelblue").style("stroke", "none");
            });
        
        // Animaci√≥n de entrada
        bars.transition()
            .duration(800)
            .delay((d, i) => i * 50)
            .attr("y", d => y(d.value))
            .attr("height", d => Math.max(0, height - y(d.value)));
        svg.append("text").attr("x", width / 2).attr("y", 0 - (margin.top / 2) - 5).attr("text-anchor", "middle").style("font-size", "16px").style("font-weight", "bold").text(titleText);
        svg.append("text").attr("transform", "rotate(-90)").attr("y", 0 - margin.left + 15).attr("x",0 - (height / 2)).attr("dy", "1em").style("text-anchor", "middle").attr("class", "axis-label").text(yAxisLabelText);
        svg.append("text").attr("transform", `translate(${width/2}, ${height + margin.bottom - 10})`).style("text-anchor", "middle").attr("class", "axis-label").text(xAxisLabelText);
    }
    
    function renderWorkerDistributionPieChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        const workerCounts = {};
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));

        dataToProcess.forEach(worker => {
            const workerName = worker.name || `ID: ${worker.client_id || 'N/A'}`;
            let totalCajasTrabajador = 0;
            (worker.operator_posts || []).forEach(post => {
                totalCajasTrabajador += (Number(post.count) || 0);
            });
            if (totalCajasTrabajador > 0) {
                 workerCounts[workerName] = (workerCounts[workerName] || 0) + totalCajasTrabajador;
            }
        });

        const dataForChart = Object.entries(workerCounts)
            .map(([name, value]) => ({ name, value }))
            .filter(d => d.value > 0)
            .sort((a,b) => b.value - a.value);

        if (dataForChart.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos de producci√≥n por empleado para mostrar.</p>';
            return;
        }
        chartContainerEl.innerHTML = '';
        
        const rect = chartContainerEl.getBoundingClientRect();
        const availableWidth = rect.width;
        const availableHeight = rect.height > 50 ? rect.height : 450; // Usar 450 como alto base

        const marginPie = 40; 
        const radius = Math.min(availableWidth - (2*marginPie), availableHeight - (2*marginPie)) / 2;
        if (radius <=0) { console.error("Pie chart radius is invalid."); chartContainerEl.innerHTML = '<p class="text-center text-red-500 p-4">Error al calcular dimensiones del gr√°fico.</p>'; return; }

        const svg = d3.select("#chartContainer").append("svg").attr("width",availableWidth).attr("height",availableHeight).append("g").attr("transform",`translate(${availableWidth/2},${availableHeight/2})`);
        const color = d3.scaleOrdinal(d3.schemeCategory10); 
        const pie = d3.pie().value(d=>d.value).sort(null); 
        const data_ready = pie(dataForChart);
        
        const arcGenerator = d3.arc().innerRadius(0).outerRadius(radius); // Pie chart normal (no donut)
        const outerArcForLabels = d3.arc().innerRadius(radius * 1.05).outerRadius(radius * 1.05); // Para las l√≠neas de las etiquetas

        const slices = svg.selectAll('allSlices').data(data_ready).join('path')
            .attr('d', d3.arc().innerRadius(0).outerRadius(0))
            .attr('fill', d => color(d.data.name))
            .attr("stroke", "white").style("stroke-width", "2px").style("opacity", 0.8)
            .on("mouseover",function(e,d){
                d3.select(this).style("opacity", 1).style("stroke", "#ffffff").style("stroke-width", "3px"); 
                tooltip.transition().duration(200).style("opacity", .9);
                const percent = (d.data.value/d3.sum(dataForChart,i=>i.value)*100).toFixed(1);
                const totalCajas = d3.sum(dataForChart, i => i.value);
                tooltip.html(`<strong>${d.data.name}</strong><br/>Cajas: ${d.data.value}<br/>Porcentaje: ${percent}%<br/>Total general: ${totalCajas}`)
                    .style("left",(e.pageX+10)+"px")
                    .style("top",(e.pageY-15)+"px");
            })
            .on("mouseout",function(){
                d3.select(this).style("opacity", 0.8).style("stroke", "white").style("stroke-width", "2px");
                tooltip.transition().duration(500).style("opacity", 0);
            });
        
        // Animaci√≥n de entrada para el gr√°fico circular
        slices.transition()
            .duration(800)
            .delay((d, i) => i * 100)
            .attr('d', arcGenerator);

        // A√±adir polil√≠neas y etiquetas fuera del gr√°fico
        svg.selectAll('allPolylines')
            .data(data_ready)
            .join('polyline')
            .attr("stroke", "black")
            .style("fill", "none")
            .attr("stroke-width", 1)
            .attr('points', function(d) {
                const percent = (d.data.value / d3.sum(dataForChart, item => item.value) * 100);
                if (percent < 2) return ""; // No dibujar l√≠nea para porciones muy peque√±as
                const posA = arcGenerator.centroid(d); // Punto de inicio en el centroide de la porci√≥n
                const posB = outerArcForLabels.centroid(d); // Punto intermedio fuera del gr√°fico
                const posC = outerArcForLabels.centroid(d); // Punto final para el texto
                posC[0] = radius * 1.1 * (midAngle(d) < Math.PI ? 1 : -1); // Extender horizontalmente
                return [posA, posB, posC];
            });

        svg.selectAll('allLabels')
            .data(data_ready)
            .join('text')
            .attr('class', 'pie-slice-label') // Usar la clase CSS definida
            .text(d => {
                const percent = (d.data.value / d3.sum(dataForChart, item => item.value) * 100);
                if (percent < 2) return ""; // No mostrar etiqueta para porciones muy peque√±as
                let namePart = d.data.name;
                if (namePart.length > 10) namePart = namePart.substring(0,8) + "..."; // Acortar nombres largos
                return `${namePart} (${percent.toFixed(0)}%)`;
            })
            .attr('transform', d => {
                const pos = outerArcForLabels.centroid(d);
                pos[0] = radius * 1.15 * (midAngle(d) < Math.PI ? 1 : -1); // Posicionar texto m√°s all√° de la l√≠nea
                pos[1] += 2; // Peque√±o ajuste vertical
                return `translate(${pos})`;
            })
            .style('text-anchor', d => (midAngle(d) < Math.PI ? 'start' : 'end'));

        function midAngle(d){ return d.startAngle + (d.endAngle - d.startAngle)/2; }
    }
    
    function renderWorkerCHDistributionPieChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        const workerData = {};
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));

        dataToProcess.forEach(worker => {
            const workerName = worker.name || `ID: ${worker.client_id || 'N/A'}`;
            let totalCajas = 0, totalHours = 0;
            (worker.operator_posts || []).forEach(post => {
                totalCajas += (Number(post.count) || 0);
                if (post.created_at) {
                    const start = new Date(post.created_at);
                    const end = post.finish_at ? new Date(post.finish_at) : new Date();
                    if (end > start) totalHours += (end - start) / 3600000;
                }
            });
            if (totalHours > 0) {
                workerData[workerName] = totalCajas / totalHours;
            }
        });

        const dataForChart = Object.entries(workerData)
            .map(([name, value]) => ({ name, value }))
            .filter(d => d.value > 0)
            .sort((a,b) => b.value - a.value);

        if (dataForChart.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos de c/h por empleado para mostrar.</p>';
            return;
        }
        chartContainerEl.innerHTML = '';
        
        const rect = chartContainerEl.getBoundingClientRect();
        const availableWidth = rect.width;
        const availableHeight = rect.height > 50 ? rect.height : 450;

        const marginPie = 40; 
        const radius = Math.min(availableWidth - (2*marginPie), availableHeight - (2*marginPie)) / 2;
        if (radius <=0) { console.error("Pie chart radius is invalid."); chartContainerEl.innerHTML = '<p class="text-center text-red-500 p-4">Error al calcular dimensiones del gr√°fico.</p>'; return; }

        const svg = d3.select("#chartContainer").append("svg").attr("width",availableWidth).attr("height",availableHeight).append("g").attr("transform",`translate(${availableWidth/2},${availableHeight/2})`);
        const color = d3.scaleOrdinal(d3.schemeCategory10); 
        const pie = d3.pie().value(d=>d.value).sort(null); 
        const data_ready = pie(dataForChart);
        
        const arcGenerator = d3.arc().innerRadius(0).outerRadius(radius);
        const outerArcForLabels = d3.arc().innerRadius(radius * 1.05).outerRadius(radius * 1.05);

        const slices = svg.selectAll('allSlices').data(data_ready).join('path')
            .attr('d', d3.arc().innerRadius(0).outerRadius(0))
            .attr('fill', d => color(d.data.name))
            .attr("stroke", "white").style("stroke-width", "2px").style("opacity", 0.8)
            .on("mouseover",function(e,d){
                d3.select(this).style("opacity", 1).style("stroke", "#ffffff").style("stroke-width", "3px"); 
                tooltip.transition().duration(200).style("opacity",.9);
                tooltip.html(`<strong>${d.data.name}</strong><br/>c/h: ${d.data.value.toFixed(2)}<br/>${((d.endAngle-d.startAngle)*100/(2*Math.PI)).toFixed(1)}%`)
                    .style("left", (e.pageX+10)+"px").style("top", (e.pageY-15)+"px");
            })
            .on("mouseout",function(){
                d3.select(this).style("opacity", 0.8).style("stroke", "white").style("stroke-width", "2px");
                tooltip.transition().duration(500).style("opacity", 0);
            });

        slices.transition().duration(1000).attrTween('d', function(d){
            const i = d3.interpolate({startAngle:0, endAngle:0}, d);
            return function(t){ return arcGenerator(i(t)); };
        });

        const polylines = svg.selectAll('allPolylines').data(data_ready).join('polyline')
            .attr("stroke", "black").style("fill", "none").attr("stroke-width", 1).attr('points', function(){return [outerArcForLabels.centroid({startAngle:0,endAngle:0})];})
            .transition().duration(1000)
            .attrTween('points', function(d){
                const posA = arcGenerator.centroid(d);
                const posB = outerArcForLabels.centroid(d);
                const posC = outerArcForLabels.centroid(d);
                const midAngleVal = d.startAngle + (d.endAngle-d.startAngle)/2;
                posC[0] = radius * 1.15 * (midAngleVal < Math.PI ? 1 : -1);
                return function(t){return [d3.interpolate([0,0],posA)(t), d3.interpolate([0,0],posB)(t), d3.interpolate([0,0],posC)(t)];};
            });

        const labels = svg.selectAll('allLabels').data(data_ready).join('text')
            .text(d => `${d.data.name.substring(0,15)} (${d.data.value.toFixed(1)})`)
            .attr('transform', d=>{const pos = [0,0]; return `translate(${pos})`;})
            .style('text-anchor', 'middle').attr('class','pie-slice-label')
            .transition().duration(1000)
            .attrTween('transform', function(d){
                const pos = outerArcForLabels.centroid(d);
                const midAngleVal = d.startAngle+(d.endAngle-d.startAngle)/2;
                pos[0] = radius * 1.18 * (midAngleVal < Math.PI ? 1 : -1);
                return function(t){const interpolatedPos = d3.interpolate([0,0],pos)(t); return `translate(${interpolatedPos})`;};
            })
            .styleTween('text-anchor', function(d){
                const midAngleVal = d.startAngle+(d.endAngle-d.startAngle)/2;
                return function(t){return midAngleVal < Math.PI ? 'start' : 'end';};
            });

        function midAngle(d){ return d.startAngle + (d.endAngle - d.startAngle)/2; }
    }
    
    function renderConfeccionPorTrabajadorChart() {
        if (!chartContainerEl) { console.error("chartContainerEl no encontrado en renderConfeccionPorTrabajadorChart"); return; }
        d3.select("#chartContainer svg").remove();
        console.log("Render Confeccion/Trabajador: Iniciando");
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        if (dataToProcess.length === 0) { chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para el gr√°fico de confecci√≥n por trabajador.</p>'; console.log("Render Confeccion/Trabajador: Sin datos para procesar."); return; }
        chartContainerEl.innerHTML = '';

        const aggregatedData = {};
        const allConfecciones = new Set();
        dataToProcess.forEach(worker => {
            const workerIdentifier = worker.name || `ID: ${worker.client_id}`;
            if (!aggregatedData[workerIdentifier]) aggregatedData[workerIdentifier] = {};
            (worker.operator_posts || []).forEach(post => {
                const count = Number(post.count) || 0;
                if (count > 0 && post.product_list?.name) {
                    const confeccionName = post.product_list.name;
                    allConfecciones.add(confeccionName);
                    aggregatedData[workerIdentifier][confeccionName] = (aggregatedData[workerIdentifier][confeccionName] || 0) + count;
                }
            });
        });
        const confeccionKeys = Array.from(allConfecciones).sort();
        const chartData = Object.entries(aggregatedData).map(([trabajador, confecciones]) => {
            const row = { trabajador: trabajador };
            confeccionKeys.forEach(conKey => { row[conKey] = confecciones[conKey] || 0; });
            return row;
        }).sort((a,b) => d3.sum(confeccionKeys, key => b[key]) - d3.sum(confeccionKeys, key => a[key]));

        if (chartData.length === 0 || confeccionKeys.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos de producci√≥n con confecci√≥n por trabajador para mostrar.</p>';
            return;
        }
        const stack = d3.stack().keys(confeccionKeys);
        const series = stack(chartData);
        
        const rect = chartContainerEl.getBoundingClientRect();
        const containerWidth = rect.width;
        const dynamicContainerHeight = rect.height > 50 ? rect.height : 450;
        
        const margin = {top: 60, right: 30, bottom: 120, left: 70};
        const width = Math.max(containerWidth - margin.left - margin.right, chartData.length * 50);
        const height = dynamicContainerHeight - margin.top - margin.bottom;

        if (height <= 0 || width <=0) { console.error("Dimensiones de gr√°fico apilado inv√°lidas:", width, height); chartContainerEl.innerHTML = '<p class="text-center text-red-500 p-4">Error al calcular dimensiones del gr√°fico.</p>'; return;}

        const svg = d3.select("#chartContainer").append("svg").attr("width",width + margin.left + margin.right).attr("height",height + margin.top + margin.bottom).append("g").attr("transform",`translate(${margin.left},${margin.top})`);
        const x = d3.scaleBand().domain(chartData.map(d=>d.trabajador)).range([0,width]).padding(0.2);
        const y = d3.scaleLinear().domain([0,d3.max(series,d=>d3.max(d,d=>d[1]))||10]).nice().range([height,0]);
        const color = d3.scaleOrdinal(d3.schemeCategory10).domain(confeccionKeys);

        const stackedBars = svg.append("g").selectAll("g").data(series).join("g").attr("fill",d=>color(d.key))
            .selectAll("rect").data(d=>d).join("rect")
            .attr("x",d=>x(d.data.trabajador))
            .attr("y",height)
            .attr("height",0)
            .attr("width",x.bandwidth())
            .style("cursor", "pointer")
            .on("mouseover",function(e,d){
                const parentData=d3.select(this.parentNode).datum(); 
                const confeccionName=parentData.key; 
                const value=d.data[confeccionName];
                const totalTrabajador = confeccionKeys.reduce((sum, key) => sum + (d.data[key] || 0), 0);
                const percentOfWorker = totalTrabajador > 0 ? ((value / totalTrabajador) * 100).toFixed(1) : '0';
                
                tooltip.transition().duration(200).style("opacity",.9);
                tooltip.html(`<strong>Trabajador:</strong> ${d.data.trabajador}<br/><strong>Confecci√≥n:</strong> ${confeccionName}<br/><strong>Cajas:</strong> ${value}<br/><strong>% del trabajador:</strong> ${percentOfWorker}%<br/><strong>Total trabajador:</strong> ${totalTrabajador}`)
                    .style("left",(e.pageX+10)+"px")
                    .style("top",(e.pageY-15)+"px");
                d3.select(this).style("stroke","#ffffff").style("stroke-width","2px").style("opacity", 0.8);
            })
            .on("mouseout",function(){
                tooltip.transition().duration(500).style("opacity",0);
                d3.select(this).style("stroke","none").style("opacity", 1);
            });
        
        // Animaci√≥n de entrada para gr√°fico apilado
        stackedBars.transition()
            .duration(800)
            .delay((d, i) => i * 30)
            .attr("y",d=>y(d[1]))
            .attr("height",d=>Math.max(0,y(d[0])-y(d[1])));
        svg.append("g").attr("transform",`translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").attr("transform","translate(-10,5)rotate(-45)").style("text-anchor","end");
        svg.append("g").call(d3.axisLeft(y).ticks(Math.min(10,d3.max(series,d=>d3.max(d,d=>d[1]))||10)));
        
        const legend = svg.append("g").attr("font-family","sans-serif").attr("font-size",10).attr("text-anchor","start")
            .attr("transform", `translate(0, ${-margin.top + 20})`)
            .selectAll("g").data(confeccionKeys.slice()).join("g")
            .attr("transform",(d,i)=>`translate(${i * ( (width / Math.min(confeccionKeys.length, 6)) * 0.8 ) },0)`);

        legend.append("rect").attr("x",0).attr("y", -7).attr("width",12).attr("height",12).attr("fill",color);
        legend.append("text").attr("x",15).attr("y",0).attr("dy","0.32em").text(d=>d.length > 12 ? d.substring(0,10)+"..." : d);
        
        svg.append("text").attr("x",width/2).attr("y",0-(margin.top/2)-5).attr("text-anchor","middle").style("font-size","16px").style("font-weight","bold").text("Producci√≥n de Confecciones por Trabajador");
    }

    // === NUEVAS FUNCIONES DE AN√ÅLISIS AVANZADO ===
    
    function renderWorkerEvolutionChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        
        // Preparar datos por trabajador
        const workerData = [];
        dataToProcess.forEach(worker => {
            const workerName = worker.name || `ID: ${worker.client_id}`;
            let totalCajas = 0;
            let posts = 0;
            
            (worker.operator_posts || []).forEach(post => {
                const cantidad = Number(post.count) || 0;
                if (cantidad > 0) {
                    totalCajas += cantidad;
                    posts++;
                }
            });
            
            if (totalCajas > 0) {
                workerData.push({
                    name: workerName,
                    totalCajas: totalCajas,
                    posts: posts,
                    avgPerPost: posts > 0 ? (totalCajas / posts) : 0
                });
            }
        });
        
        // Ordenar por total de cajas
        workerData.sort((a, b) => b.totalCajas - a.totalCajas);
        
        if (workerData.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos de operarios para mostrar.</p>';
            return;
        }
        
        // Mostrar todos los operarios ordenados
        const topWorkers = workerData; // Mostrar todos
        
        chartContainerEl.innerHTML = '';
        const rect = chartContainerEl.getBoundingClientRect();
        const margin = {top: 60, right: 30, bottom: 120, left: 80};
        const width = Math.max(rect.width - margin.left - margin.right, 600);
        const height = (rect.height > 50 ? rect.height : 450) - margin.top - margin.bottom;
        
        const svg = d3.select("#chartContainer").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Escalas
        const x = d3.scalePoint()
            .domain(topWorkers.map((d, i) => i))
            .range([0, width])
            .padding(0.1);
        
        const y = d3.scaleLinear()
            .domain([0, d3.max(topWorkers, d => d.totalCajas)])
            .nice()
            .range([height, 0]);
        
        // Crear l√≠nea de evoluci√≥n
        const line = d3.line()
            .x((d, i) => x(i))
            .y(d => y(d.totalCajas))
            .curve(d3.curveCardinal);
        
        // √Årea bajo la l√≠nea
        const area = d3.area()
            .x((d, i) => x(i))
            .y0(height)
            .y1(d => y(d.totalCajas))
            .curve(d3.curveCardinal);
        
        // Gradiente para el √°rea
        const gradient = svg.append("defs")
            .append("linearGradient")
            .attr("id", "areaGradient")
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", 0).attr("y1", height)
            .attr("x2", 0).attr("y2", 0);
        
        gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#667eea")
            .attr("stop-opacity", 0.1);
        
        gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#667eea")
            .attr("stop-opacity", 0.6);
        
        // Dibujar √°rea
        svg.append("path")
            .datum(topWorkers)
            .attr("class", "area")
            .attr("d", area)
            .style("fill", "url(#areaGradient)")
            .style("opacity", 0)
            .transition().duration(1000)
            .style("opacity", 1);
        
        // Dibujar l√≠nea principal
        const path = svg.append("path")
            .datum(topWorkers)
            .attr("class", "evolution-line")
            .attr("d", line)
            .style("fill", "none")
            .style("stroke", "#667eea")
            .style("stroke-width", "3px")
            .style("stroke-dasharray", function() { return this.getTotalLength(); })
            .style("stroke-dashoffset", function() { return this.getTotalLength(); })
            .transition().duration(2000)
            .style("stroke-dashoffset", 0);
        
        // Puntos interactivos
        svg.selectAll(".evolution-point")
            .data(topWorkers)
            .join("circle")
            .attr("class", "evolution-point")
            .attr("cx", (d, i) => x(i))
            .attr("cy", d => y(d.totalCajas))
            .attr("r", 0)
            .style("fill", "#667eea")
            .style("stroke", "#ffffff")
            .style("stroke-width", "2px")
            .style("cursor", "pointer")
            .transition().delay((d, i) => 1500 + i * 100).duration(300)
            .attr("r", 6)
            .selection()
            .on("mouseover", function(event, d) {
                d3.select(this).transition().duration(200).attr("r", 8);
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`
                    <strong>${d.name}</strong><br/>
                    <strong>Total Cajas:</strong> ${d.totalCajas}<br/>
                    <strong>Asignaciones:</strong> ${d.posts}<br/>
                    <strong>Promedio/Asignaci√≥n:</strong> ${d.avgPerPost.toFixed(1)} cajas
                `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 15) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).transition().duration(200).attr("r", 6);
                tooltip.transition().duration(500).style("opacity", 0);
            });
        
        // Etiquetas de trabajadores
        svg.selectAll(".worker-label")
            .data(topWorkers)
            .join("text")
            .attr("class", "worker-label")
            .attr("x", (d, i) => x(i))
            .attr("y", height + 20)
            .attr("text-anchor", "middle")
            .style("font-size", "10px")
            .style("fill", "#666")
            .text(d => d.name.length > 12 ? d.name.substring(0, 10) + "..." : d.name)
            .attr("transform", (d, i) => `rotate(-45, ${x(i)}, ${height + 20})`)
            .style("opacity", 0)
            .transition().delay(2500).duration(500)
            .style("opacity", 1);
        
        // Ejes
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickFormat(() => ""));
        
        svg.append("g").call(d3.axisLeft(y));
        
        // Etiquetas de ejes y t√≠tulo
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("font-weight", "bold")
            .text("Evoluci√≥n de Productividad - Top 10 Operarios");
        
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 15)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Total Cajas Producidas");
        
        svg.append("text")
            .attr("transform", `translate(${width/2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .text("Operarios (ordenados por productividad)");
        
        // L√≠nea de promedio
        const avgCajas = d3.mean(topWorkers, d => d.totalCajas);
        svg.append("line")
            .attr("x1", 0)
            .attr("x2", width)
            .attr("y1", y(avgCajas))
            .attr("y2", y(avgCajas))
            .style("stroke", "#ff6b6b")
            .style("stroke-width", "2px")
            .style("stroke-dasharray", "5,5")
            .style("opacity", 0)
            .transition().delay(3000).duration(500)
            .style("opacity", 0.7);
        
        // Etiqueta de promedio
        svg.append("text")
            .attr("x", width - 10)
            .attr("y", y(avgCajas) - 5)
            .attr("text-anchor", "end")
            .style("font-size", "12px")
            .style("fill", "#ff6b6b")
            .style("font-weight", "bold")
            .text(`Promedio: ${avgCajas.toFixed(1)}`)
            .style("opacity", 0)
            .transition().delay(3000).duration(500)
            .style("opacity", 1);
    }
    
    function renderWorkerEvolutionCHChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        
        // Preparar datos por trabajador con c/h
        const workerData = [];
        dataToProcess.forEach(worker => {
            const workerName = worker.name || `ID: ${worker.client_id}`;
            let totalCajas = 0;
            let totalHours = 0;
            
            (worker.operator_posts || []).forEach(post => {
                totalCajas += Number(post.count) || 0;
                if (post.created_at) {
                    const start = new Date(post.created_at);
                    const end = post.finish_at ? new Date(post.finish_at) : new Date();
                    if (end > start) totalHours += (end - start) / 3600000;
                }
            });
            
            if (totalHours > 0) {
                workerData.push({
                    name: workerName,
                    cajasHora: totalCajas / totalHours,
                    totalCajas: totalCajas,
                    totalHours: totalHours
                });
            }
        });
        
        // Ordenar por cajas/hora
        workerData.sort((a, b) => b.cajasHora - a.cajasHora);
        
        if (workerData.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos de operarios para mostrar.</p>';
            return;
        }
        
        // Mostrar todos los operarios ordenados
        const allWorkers = workerData;
        
        chartContainerEl.innerHTML = '';
        const rect = chartContainerEl.getBoundingClientRect();
        const margin = {top: 60, right: 30, bottom: 120, left: 80};
        const width = Math.max(rect.width - margin.left - margin.right, 600);
        const height = (rect.height > 50 ? rect.height : 450) - margin.top - margin.bottom;
        
        const svg = d3.select("#chartContainer").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Escalas
        const x = d3.scalePoint()
            .domain(allWorkers.map((d, i) => i))
            .range([0, width])
            .padding(0.1);
        
        const y = d3.scaleLinear()
            .domain([0, d3.max(allWorkers, d => d.cajasHora)])
            .nice()
            .range([height, 0]);
        
        // Crear l√≠nea de evoluci√≥n
        const line = d3.line()
            .x((d, i) => x(i))
            .y(d => y(d.cajasHora))
            .curve(d3.curveCardinal);
        
        // √Årea bajo la l√≠nea
        const area = d3.area()
            .x((d, i) => x(i))
            .y0(height)
            .y1(d => y(d.cajasHora))
            .curve(d3.curveCardinal);
        
        // Gradiente para el √°rea
        const gradient = svg.append("defs")
            .append("linearGradient")
            .attr("id", "area-gradient-ch")
            .attr("x1", "0%")
            .attr("y1", "0%")
            .attr("x2", "0%")
            .attr("y2", "100%");
        
        gradient.append("stop")
            .attr("offset", "0%")
            .attr("stop-color", "#a855f7")
            .attr("stop-opacity", 0.6);
        
        gradient.append("stop")
            .attr("offset", "100%")
            .attr("stop-color", "#a855f7")
            .attr("stop-opacity", 0.1);
        
        // Dibujar √°rea con animaci√≥n
        svg.append("path")
            .datum(allWorkers)
            .attr("class", "area")
            .attr("d", area)
            .style("fill", "url(#area-gradient-ch)")
            .style("opacity", 0)
            .transition().duration(1500)
            .style("opacity", 1);
        
        // Dibujar l√≠nea con animaci√≥n
        const path = svg.append("path")
            .datum(allWorkers)
            .attr("class", "trend-line")
            .attr("d", line)
            .attr("stroke", "#9333ea")
            .attr("stroke-width", 3)
            .attr("fill", "none");
        
        const totalLength = path.node().getTotalLength();
        path.attr("stroke-dasharray", totalLength + " " + totalLength)
            .attr("stroke-dashoffset", totalLength)
            .transition().duration(2000).ease(d3.easeLinear)
            .attr("stroke-dashoffset", 0);
        
        // Puntos en la l√≠nea
        svg.selectAll(".trend-point")
            .data(allWorkers)
            .join("circle")
            .attr("class", "trend-point")
            .attr("cx", (d, i) => x(i))
            .attr("cy", d => y(d.cajasHora))
            .attr("r", 0)
            .attr("stroke", "#9333ea")
            .attr("fill", "#fff")
            .on("mouseover", function(e, d) {
                d3.select(this).attr("r", 6).attr("stroke-width", 3);
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`<strong>${d.name}</strong><br/>c/h: ${d.cajasHora.toFixed(2)}<br/>Total: ${d.totalCajas} cajas<br/>Horas: ${d.totalHours.toFixed(1)}h`)
                    .style("left", (e.pageX + 10) + "px").style("top", (e.pageY - 15) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).attr("r", 4).attr("stroke-width", 2);
                tooltip.transition().duration(500).style("opacity", 0);
            })
            .transition().delay((d, i) => 2000 + i * 30).duration(300)
            .attr("r", 4)
            .attr("stroke-width", 2);
        
        // Etiquetas de trabajadores
        svg.selectAll(".worker-label")
            .data(allWorkers)
            .join("text")
            .attr("class", "worker-label")
            .attr("x", (d, i) => x(i))
            .attr("y", height + 20)
            .attr("text-anchor", "middle")
            .style("font-size", "10px")
            .style("fill", "#666")
            .text(d => d.name.length > 12 ? d.name.substring(0, 10) + "..." : d.name)
            .attr("transform", (d, i) => `rotate(-45, ${x(i)}, ${height + 20})`)
            .style("opacity", 0)
            .transition().delay(2500).duration(500)
            .style("opacity", 1);
        
        // Ejes
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(x).tickFormat(() => ""));
        
        svg.append("g").call(d3.axisLeft(y));
        
        // Etiquetas de ejes y t√≠tulo
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("font-weight", "bold")
            .text("Evoluci√≥n de Cajas/Hora - Todos los Operarios");
        
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 15)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Cajas por Hora");
        
        svg.append("text")
            .attr("transform", `translate(${width/2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .text("Operarios (ordenados por eficiencia)");
        
        // L√≠nea de promedio
        const avgCH = d3.mean(allWorkers, d => d.cajasHora);
        svg.append("line")
            .attr("x1", 0)
            .attr("x2", width)
            .attr("y1", y(avgCH))
            .attr("y2", y(avgCH))
            .style("stroke", "#10b981")
            .style("stroke-width", "2px")
            .style("stroke-dasharray", "5,5")
            .style("opacity", 0)
            .transition().delay(3000).duration(500)
            .style("opacity", 0.7);
        
        // Etiqueta de promedio
        svg.append("text")
            .attr("x", width - 10)
            .attr("y", y(avgCH) - 5)
            .attr("text-anchor", "end")
            .style("font-size", "12px")
            .style("fill", "#10b981")
            .style("font-weight", "bold")
            .text(`Promedio: ${avgCH.toFixed(2)} c/h`)
            .style("opacity", 0)
            .transition().delay(3000).duration(500)
            .style("opacity", 1);
    }
    
    function renderWorkerDistributionChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        const postDistribution = {};
        const activeWorkers = {};
        
        // Analizar distribuci√≥n actual de trabajadores
        dataToProcess.forEach(worker => {
            const workerName = worker.name || `ID: ${worker.client_id}`;
            let workerCurrentPost = null;
            let workerTotalCajas = 0;
            
            (worker.operator_posts || []).forEach(post => {
                const cantidad = Number(post.count) || 0;
                workerTotalCajas += cantidad;
                
                // Si el puesto no tiene finish_at, est√° activo
                if (!post.finish_at && post.created_at && cantidad >= 0) {
                    workerCurrentPost = post.rfid_reading?.name || 'Sin Puesto';
                }
            });
            
            // Solo contar trabajadores con producci√≥n
            if (workerTotalCajas > 0 && workerCurrentPost) {
                if (!postDistribution[workerCurrentPost]) {
                    postDistribution[workerCurrentPost] = {
                        puesto: workerCurrentPost,
                        trabajadores: 0,
                        totalCajas: 0,
                        workers: []
                    };
                }
                
                postDistribution[workerCurrentPost].trabajadores++;
                postDistribution[workerCurrentPost].totalCajas += workerTotalCajas;
                postDistribution[workerCurrentPost].workers.push({
                    name: workerName,
                    cajas: workerTotalCajas
                });
            }
        });
        
        const chartData = Object.values(postDistribution).sort((a, b) => b.trabajadores - a.trabajadores);
        
        if (chartData.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay trabajadores activos para mostrar distribuci√≥n.</p>';
            return;
        }
        
        chartContainerEl.innerHTML = '';
        
        // Crear un gr√°fico de burbujas
        const rect = chartContainerEl.getBoundingClientRect();
        const margin = {top: 60, right: 30, bottom: 100, left: 80};
        const width = Math.max(rect.width - margin.left - margin.right, 600);
        const height = (rect.height > 50 ? rect.height : 450) - margin.top - margin.bottom;
        
        const svg = d3.select("#chartContainer").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Escalas
        const xScale = d3.scaleBand()
            .domain(chartData.map(d => d.puesto))
            .range([0, width])
            .padding(0.2);
        
        const yScale = d3.scaleLinear()
            .domain([0, d3.max(chartData, d => d.trabajadores)])
            .nice()
            .range([height, 0]);
        
        const sizeScale = d3.scaleSqrt()
            .domain([0, d3.max(chartData, d => d.totalCajas)])
            .range([20, 80]);
        
        const colorScale = d3.scaleOrdinal(d3.schemeSet3);
        
        // Crear c√≠rculos (burbujas)
        const bubbles = svg.selectAll(".bubble")
            .data(chartData)
            .join("circle")
            .attr("class", "bubble")
            .attr("cx", d => xScale(d.puesto) + xScale.bandwidth() / 2)
            .attr("cy", height)
            .attr("r", 0)
            .style("fill", (d, i) => colorScale(i))
            .style("stroke", "#fff")
            .style("stroke-width", "2px")
            .style("opacity", 0.8)
            .style("cursor", "pointer");
        
        // Animaci√≥n de entrada
        bubbles.transition()
            .duration(1000)
            .delay((d, i) => i * 100)
            .attr("cy", d => yScale(d.trabajadores))
            .attr("r", d => sizeScale(d.totalCajas));
        
        // Tooltips y eventos
        bubbles
            .on("mouseover", function(event, d) {
                d3.select(this).style("opacity", 1).style("stroke-width", "3px");
                
                const topWorkers = d.workers
                    .sort((a, b) => b.cajas - a.cajas)
                    .slice(0, 3)
                    .map(w => `${w.name}: ${w.cajas} cajas`)
                    .join('<br/>');
                
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`
                    <strong>Puesto:</strong> ${d.puesto}<br/>
                    <strong>Trabajadores:</strong> ${d.trabajadores}<br/>
                    <strong>Total Cajas:</strong> ${d.totalCajas}<br/>
                    <strong>Promedio por trabajador:</strong> ${(d.totalCajas / d.trabajadores).toFixed(1)}<br/>
                    <strong>Top trabajadores:</strong><br/>${topWorkers}
                `)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 15) + "px");
            })
            .on("mouseout", function() {
                d3.select(this).style("opacity", 0.8).style("stroke-width", "2px");
                tooltip.transition().duration(500).style("opacity", 0);
            });
        
        // Etiquetas en las burbujas
        svg.selectAll(".bubble-label")
            .data(chartData)
            .join("text")
            .attr("class", "bubble-label")
            .attr("x", d => xScale(d.puesto) + xScale.bandwidth() / 2)
            .attr("y", d => yScale(d.trabajadores))
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .style("font-size", "12px")
            .style("font-weight", "bold")
            .style("fill", "#333")
            .style("pointer-events", "none")
            .text(d => d.trabajadores)
            .style("opacity", 0)
            .transition()
            .delay(1200)
            .duration(500)
            .style("opacity", 1);
        
        // Ejes
        svg.append("g")
            .attr("transform", `translate(0,${height})`)
            .call(d3.axisBottom(xScale))
            .selectAll("text")
            .attr("transform", "translate(-10,5)rotate(-45)")
            .style("text-anchor", "end")
            .style("font-size", "10px");
        
        svg.append("g").call(d3.axisLeft(yScale));
        
        // Etiquetas de ejes
        svg.append("text")
            .attr("x", width / 2)
            .attr("y", 0 - (margin.top / 2))
            .attr("text-anchor", "middle")
            .style("font-size", "16px")
            .style("font-weight", "bold")
            .text("Distribuci√≥n de Trabajadores Activos por Puesto");
        
        svg.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left + 15)
            .attr("x", 0 - (height / 2))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("N√∫mero de Trabajadores");
        
        svg.append("text")
            .attr("transform", `translate(${width/2}, ${height + margin.bottom - 10})`)
            .style("text-anchor", "middle")
            .text("Puestos de Trabajo");
        
        // Leyenda del tama√±o
        const legend = svg.append("g")
            .attr("transform", `translate(${width - 150}, 20)`);
        
        legend.append("text")
            .attr("x", 0)
            .attr("y", 0)
            .style("font-size", "12px")
            .style("font-weight", "bold")
            .text("Tama√±o = Total Cajas");
        
        const legendData = [
            { size: sizeScale(d3.min(chartData, d => d.totalCajas)), label: "M√≠n" },
            { size: sizeScale(d3.max(chartData, d => d.totalCajas)), label: "M√°x" }
        ];
        
        const legendItems = legend.selectAll(".legend-item")
            .data(legendData)
            .join("g")
            .attr("class", "legend-item")
            .attr("transform", (d, i) => `translate(0, ${20 + i * 30})`);
        
        legendItems.append("circle")
            .attr("cx", 10)
            .attr("cy", 0)
            .attr("r", d => d.size)
            .style("fill", colorScale(0))
            .style("opacity", 0.6);
        
        legendItems.append("text")
            .attr("x", 25)
            .attr("y", 5)
            .style("font-size", "10px")
            .text(d => d.label);
    }
    
    function renderRankingChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        const rankings = dataToProcess.map(worker => {
            const totalCajas = (worker.operator_posts || []).reduce((sum, post) => sum + (Number(post.count) || 0), 0);
            let totalHours = 0;
            (worker.operator_posts || []).forEach(post => {
                if (post.created_at) {
                    const start = new Date(post.created_at);
                    const end = post.finish_at ? new Date(post.finish_at) : new Date();
                    if (end > start) totalHours += (end - start) / 3600000;
                }
            });
            
            return {
                name: worker.name || `ID: ${worker.client_id}`,
                totalCajas,
                cajasHora: totalHours > 0 ? (totalCajas / totalHours) : 0,
                efficiency: totalHours > 0 ? ((totalCajas / totalHours) * 100 / 50).toFixed(1) : 0 // Asumiendo 50 cajas/hora como 100%
            };
        }).filter(w => w.totalCajas > 0).sort((a, b) => b.totalCajas - a.totalCajas);
        
        if (rankings.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para rankings.</p>';
            return;
        }
        
        chartContainerEl.innerHTML = '';
        const container = d3.select("#chartContainer");
        
        // Crear cards de ranking
        const rankingCards = container.selectAll(".ranking-card")
            .data(rankings.slice(0, 10)) // Top 10
            .join("div")
            .attr("class", "ranking-card")
            .style("opacity", 0)
            .style("transform", "translateY(20px)")
            .transition().delay((d, i) => i * 100).duration(500)
            .style("opacity", 1)
            .style("transform", "translateY(0px)")
            .selection();
        
        rankingCards.each(function(d, i) {
            const card = d3.select(this);
            
            card.append("div")
                .style("display", "flex")
                .style("align-items", "center")
                .each(function() {
                    const content = d3.select(this);
                    
                    // Posici√≥n
                    content.append("div")
                        .attr("class", "ranking-position")
                        .text(i + 1);
                    
                    // Informaci√≥n del trabajador
                    const info = content.append("div").style("flex", "1");
                    
                    info.append("div")
                        .style("font-size", "1.2rem")
                        .style("font-weight", "bold")
                        .text(d.name);
                    
                    info.append("div")
                        .style("font-size", "0.9rem")
                        .style("opacity", "0.8")
                        .text(`${d.totalCajas} cajas ‚Ä¢ ${d.cajasHora.toFixed(1)} c/h ‚Ä¢ ${d.efficiency}% eficiencia`);
                    
                    // Medalla para top 3
                    if (i < 3) {
                        const medals = ["ü•á", "ü•à", "ü•â"];
                        content.append("div")
                            .style("font-size", "2rem")
                            .text(medals[i]);
                    }
                });
        });
        
        // T√≠tulo
        container.insert("h3", ":first-child")
            .style("text-align", "center")
            .style("margin", "1rem 0")
            .style("font-size", "1.5rem")
            .style("font-weight", "bold")
            .style("color", "#1f2937")
            .text("üèÜ Top 10 Trabajadores M√°s Productivos");
    }
    
    function renderRankingCHChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        const rankings = dataToProcess.map(worker => {
            const totalCajas = (worker.operator_posts || []).reduce((sum, post) => sum + (Number(post.count) || 0), 0);
            let totalHours = 0;
            (worker.operator_posts || []).forEach(post => {
                if (post.created_at) {
                    const start = new Date(post.created_at);
                    const end = post.finish_at ? new Date(post.finish_at) : new Date();
                    if (end > start) totalHours += (end - start) / 3600000;
                }
            });
            
            return {
                name: worker.name || `ID: ${worker.client_id}`,
                totalCajas,
                cajasHora: totalHours > 0 ? (totalCajas / totalHours) : 0,
                totalHours: totalHours,
                efficiency: totalHours > 0 ? ((totalCajas / totalHours) * 100 / 50).toFixed(1) : 0
            };
        }).filter(w => w.totalHours > 0).sort((a, b) => b.cajasHora - a.cajasHora); // Ordenar por cajas/hora
        
        if (rankings.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para rankings.</p>';
            return;
        }
        
        chartContainerEl.innerHTML = '';
        const container = d3.select("#chartContainer");
        
        // Crear cards de ranking
        const rankingCards = container.selectAll(".ranking-card")
            .data(rankings.slice(0, 10)) // Top 10
            .join("div")
            .attr("class", "ranking-card")
            .style("background", "linear-gradient(135deg, #10b981 0%, #059669 100%)") // Verde esmeralda
            .style("opacity", 0)
            .style("transform", "translateY(20px)")
            .transition().delay((d, i) => i * 100).duration(500)
            .style("opacity", 1)
            .style("transform", "translateY(0px)")
            .selection();
        
        rankingCards.each(function(d, i) {
            const card = d3.select(this);
            
            card.append("div")
                .style("display", "flex")
                .style("align-items", "center")
                .each(function() {
                    const content = d3.select(this);
                    
                    // Posici√≥n
                    content.append("div")
                        .attr("class", "ranking-position")
                        .text(i + 1);
                    
                    // Informaci√≥n del trabajador
                    const info = content.append("div").style("flex", "1");
                    
                    info.append("div")
                        .style("font-size", "1.2rem")
                        .style("font-weight", "bold")
                        .text(d.name);
                    
                    info.append("div")
                        .style("font-size", "0.9rem")
                        .style("opacity", "0.9")
                        .html(`<strong style="font-size:1.1rem;">‚ö° ${d.cajasHora.toFixed(2)} c/h</strong> ‚Ä¢ ${d.totalCajas} cajas ‚Ä¢ ${d.totalHours.toFixed(1)}h ‚Ä¢ ${d.efficiency}% eficiencia`);
                    
                    // Medalla para top 3
                    if (i < 3) {
                        const medals = ["ü•á", "ü•à", "ü•â"];
                        content.append("div")
                            .style("font-size", "2rem")
                            .text(medals[i]);
                    }
                });
        });
        
        // T√≠tulo
        container.insert("h3", ":first-child")
            .style("text-align", "center")
            .style("margin", "1rem 0")
            .style("font-size", "1.5rem")
            .style("font-weight", "bold")
            .style("color", "#1f2937")
            .text("‚ö° Top 10 por Cajas/Hora - M√°xima Eficiencia");
    }
    
    function renderFullRankingChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        const rankings = dataToProcess.map(worker => {
            const totalCajas = (worker.operator_posts || []).reduce((sum, post) => sum + (Number(post.count) || 0), 0);
            let totalHours = 0;
            (worker.operator_posts || []).forEach(post => {
                if (post.created_at) {
                    const start = new Date(post.created_at);
                    const end = post.finish_at ? new Date(post.finish_at) : new Date();
                    if (end > start) totalHours += (end - start) / 3600000;
                }
            });
            
            return {
                name: worker.name || `ID: ${worker.client_id}`,
                totalCajas,
                cajasHora: totalHours > 0 ? (totalCajas / totalHours) : 0,
                totalHours: totalHours,
                efficiency: totalHours > 0 ? ((totalCajas / totalHours) * 100 / 50).toFixed(1) : 0
            };
        }).filter(w => w.totalCajas > 0).sort((a, b) => b.totalCajas - a.totalCajas);
        
        if (rankings.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para rankings.</p>';
            return;
        }
        
        chartContainerEl.innerHTML = '';
        const container = d3.select("#chartContainer");
        
        // T√≠tulo
        container.append("h3")
            .style("text-align", "center")
            .style("margin", "1rem 0")
            .style("font-size", "1.5rem")
            .style("font-weight", "bold")
            .style("color", "#1f2937")
            .text(`üìã Ranking Completo - ${rankings.length} Trabajadores`);
        
        // Estad√≠sticas generales
        const statsDiv = container.append("div")
            .style("display", "grid")
            .style("grid-template-columns", "repeat(auto-fit, minmax(200px, 1fr))")
            .style("gap", "1rem")
            .style("margin", "1rem 0")
            .style("padding", "1rem")
            .style("background", "#f9fafb")
            .style("border-radius", "0.5rem");
        
        const totalCajasGlobal = rankings.reduce((sum, w) => sum + w.totalCajas, 0);
        const avgCajasHora = rankings.reduce((sum, w) => sum + w.cajasHora, 0) / rankings.length;
        
        statsDiv.append("div")
            .style("text-align", "center")
            .html(`<div style="font-size: 0.875rem; color: #6b7280;">Total Cajas</div><div style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">${totalCajasGlobal}</div>`);
        
        statsDiv.append("div")
            .style("text-align", "center")
            .html(`<div style="font-size: 0.875rem; color: #6b7280;">Promedio c/h</div><div style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">${avgCajasHora.toFixed(1)}</div>`);
        
        statsDiv.append("div")
            .style("text-align", "center")
            .html(`<div style="font-size: 0.875rem; color: #6b7280;">Trabajadores</div><div style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">${rankings.length}</div>`);
        
        // Crear tabla scrolleable con todos los rankings
        const tableContainer = container.append("div")
            .style("max-height", "500px")
            .style("overflow-y", "auto")
            .style("margin", "1rem 0")
            .style("border", "1px solid #e5e7eb")
            .style("border-radius", "0.5rem");
        
        const table = tableContainer.append("table")
            .style("width", "100%")
            .style("border-collapse", "collapse")
            .style("background", "white");
        
        // Header de la tabla
        const thead = table.append("thead")
            .style("background", "linear-gradient(135deg, #667eea 0%, #764ba2 100%)")
            .style("color", "white")
            .style("position", "sticky")
            .style("top", "0")
            .style("z-index", "10");
        
        const headerRow = thead.append("tr");
        ['#', 'Trabajador', 'Total Cajas', 'Horas', 'Cajas/Hora', 'Eficiencia'].forEach(header => {
            headerRow.append("th")
                .style("padding", "0.75rem")
                .style("text-align", "left")
                .style("font-size", "0.875rem")
                .style("font-weight", "600")
                .text(header);
        });
        
        // Body de la tabla
        const tbody = table.append("tbody");
        
        rankings.forEach((worker, i) => {
            const row = tbody.append("tr")
                .style("border-bottom", "1px solid #e5e7eb")
                .style("transition", "all 0.2s ease")
                .on("mouseover", function() {
                    d3.select(this)
                        .style("background", "#f3f4f6")
                        .style("transform", "scale(1.01)");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .style("background", i % 2 === 0 ? "white" : "#f9fafb")
                        .style("transform", "scale(1)");
                })
                .style("background", i % 2 === 0 ? "white" : "#f9fafb");
            
            // Posici√≥n con medallas para top 3
            const positionCell = row.append("td")
                .style("padding", "0.75rem")
                .style("font-weight", "bold")
                .style("font-size", "1rem");
            
            if (i < 3) {
                const medals = ["ü•á", "ü•à", "ü•â"];
                positionCell.html(`${medals[i]} ${i + 1}`);
            } else {
                positionCell.text(i + 1);
            }
            
            // Nombre
            row.append("td")
                .style("padding", "0.75rem")
                .style("font-weight", i < 3 ? "600" : "normal")
                .text(worker.name);
            
            // Total Cajas
            row.append("td")
                .style("padding", "0.75rem")
                .style("font-weight", i < 3 ? "600" : "normal")
                .style("color", i < 3 ? "#10b981" : "#1f2937")
                .text(worker.totalCajas);
            
            // Horas trabajadas
            row.append("td")
                .style("padding", "0.75rem")
                .text(worker.totalHours.toFixed(1) + "h");
            
            // Cajas por hora
            row.append("td")
                .style("padding", "0.75rem")
                .style("font-weight", "500")
                .text(worker.cajasHora.toFixed(1));
            
            // Eficiencia
            const efficiencyCell = row.append("td")
                .style("padding", "0.75rem");
            
            const efficiency = parseFloat(worker.efficiency);
            let efficiencyColor = "#6b7280";
            if (efficiency >= 100) efficiencyColor = "#10b981";
            else if (efficiency >= 80) efficiencyColor = "#f59e0b";
            else efficiencyColor = "#ef4444";
            
            efficiencyCell.append("span")
                .style("padding", "0.25rem 0.5rem")
                .style("background", efficiencyColor)
                .style("color", "white")
                .style("border-radius", "0.25rem")
                .style("font-size", "0.875rem")
                .style("font-weight", "600")
                .text(worker.efficiency + "%");
        });
    }
    
    function renderFullRankingCHChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        const rankings = dataToProcess.map(worker => {
            const totalCajas = (worker.operator_posts || []).reduce((sum, post) => sum + (Number(post.count) || 0), 0);
            let totalHours = 0;
            (worker.operator_posts || []).forEach(post => {
                if (post.created_at) {
                    const start = new Date(post.created_at);
                    const end = post.finish_at ? new Date(post.finish_at) : new Date();
                    if (end > start) totalHours += (end - start) / 3600000;
                }
            });
            
            return {
                name: worker.name || `ID: ${worker.client_id}`,
                totalCajas,
                cajasHora: totalHours > 0 ? (totalCajas / totalHours) : 0,
                totalHours: totalHours,
                efficiency: totalHours > 0 ? ((totalCajas / totalHours) * 100 / 50).toFixed(1) : 0
            };
        }).filter(w => w.totalHours > 0).sort((a, b) => b.cajasHora - a.cajasHora); // Ordenar por cajas/hora
        
        if (rankings.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para rankings.</p>';
            return;
        }
        
        chartContainerEl.innerHTML = '';
        const container = d3.select("#chartContainer");
        
        // T√≠tulo
        container.append("h3")
            .style("text-align", "center")
            .style("margin", "1rem 0")
            .style("font-size", "1.5rem")
            .style("font-weight", "bold")
            .style("color", "#1f2937")
            .text(`‚ö° Ranking Completo por Cajas/Hora - ${rankings.length} Trabajadores`);
        
        // Estad√≠sticas generales
        const statsDiv = container.append("div")
            .style("display", "grid")
            .style("grid-template-columns", "repeat(auto-fit, minmax(200px, 1fr))")
            .style("gap", "1rem")
            .style("margin", "1rem 0")
            .style("padding", "1rem")
            .style("background", "#f9fafb")
            .style("border-radius", "0.5rem");
        
        const totalCajasGlobal = rankings.reduce((sum, w) => sum + w.totalCajas, 0);
        const avgCajasHora = rankings.reduce((sum, w) => sum + w.cajasHora, 0) / rankings.length;
        const topCajasHora = rankings[0].cajasHora;
        
        statsDiv.append("div")
            .style("text-align", "center")
            .html(`<div style="font-size: 0.875rem; color: #6b7280;">Total Cajas</div><div style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">${totalCajasGlobal}</div>`);
        
        statsDiv.append("div")
            .style("text-align", "center")
            .html(`<div style="font-size: 0.875rem; color: #6b7280;">Promedio c/h</div><div style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">${avgCajasHora.toFixed(1)}</div>`);
        
        statsDiv.append("div")
            .style("text-align", "center")
            .html(`<div style="font-size: 0.875rem; color: #6b7280;">Mejor c/h</div><div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">${topCajasHora.toFixed(1)}</div>`);
        
        // Crear tabla scrolleable con todos los rankings
        const tableContainer = container.append("div")
            .style("max-height", "500px")
            .style("overflow-y", "auto")
            .style("margin", "1rem 0")
            .style("border", "1px solid #e5e7eb")
            .style("border-radius", "0.5rem");
        
        const table = tableContainer.append("table")
            .style("width", "100%")
            .style("border-collapse", "collapse")
            .style("background", "white");
        
        // Header de la tabla
        const thead = table.append("thead")
            .style("background", "linear-gradient(135deg, #84cc16 0%, #65a30d 100%)")
            .style("color", "white")
            .style("position", "sticky")
            .style("top", "0")
            .style("z-index", "10");
        
        const headerRow = thead.append("tr");
        ['#', 'Trabajador', 'Cajas/Hora', 'Total Cajas', 'Horas', 'Eficiencia'].forEach(header => {
            headerRow.append("th")
                .style("padding", "0.75rem")
                .style("text-align", "left")
                .style("font-size", "0.875rem")
                .style("font-weight", "600")
                .text(header);
        });
        
        // Body de la tabla
        const tbody = table.append("tbody");
        
        rankings.forEach((worker, i) => {
            const row = tbody.append("tr")
                .style("border-bottom", "1px solid #e5e7eb")
                .style("transition", "all 0.2s ease")
                .on("mouseover", function() {
                    d3.select(this)
                        .style("background", "#f3f4f6")
                        .style("transform", "scale(1.01)");
                })
                .on("mouseout", function() {
                    d3.select(this)
                        .style("background", i % 2 === 0 ? "white" : "#f9fafb")
                        .style("transform", "scale(1)");
                })
                .style("background", i % 2 === 0 ? "white" : "#f9fafb");
            
            // Posici√≥n con medallas para top 3
            const positionCell = row.append("td")
                .style("padding", "0.75rem")
                .style("font-weight", "bold")
                .style("font-size", "1rem");
            
            if (i < 3) {
                const medals = ["ü•á", "ü•à", "ü•â"];
                positionCell.html(`${medals[i]} ${i + 1}`);
            } else {
                positionCell.text(i + 1);
            }
            
            // Nombre
            row.append("td")
                .style("padding", "0.75rem")
                .style("font-weight", i < 3 ? "600" : "normal")
                .text(worker.name);
            
            // Cajas por hora (columna destacada)
            row.append("td")
                .style("padding", "0.75rem")
                .style("font-weight", "700")
                .style("font-size", "1.1rem")
                .style("color", i < 3 ? "#84cc16" : "#65a30d")
                .text(worker.cajasHora.toFixed(2));
            
            // Total Cajas
            row.append("td")
                .style("padding", "0.75rem")
                .text(worker.totalCajas);
            
            // Horas trabajadas
            row.append("td")
                .style("padding", "0.75rem")
                .text(worker.totalHours.toFixed(1) + "h");
            
            // Eficiencia
            const efficiencyCell = row.append("td")
                .style("padding", "0.75rem");
            
            const efficiency = parseFloat(worker.efficiency);
            let efficiencyColor = "#6b7280";
            if (efficiency >= 100) efficiencyColor = "#10b981";
            else if (efficiency >= 80) efficiencyColor = "#f59e0b";
            else efficiencyColor = "#ef4444";
            
            efficiencyCell.append("span")
                .style("padding", "0.25rem 0.5rem")
                .style("background", efficiencyColor)
                .style("color", "white")
                .style("border-radius", "0.25rem")
                .style("font-size", "0.875rem")
                .style("font-weight", "600")
                .text(worker.efficiency + "%");
        });
    }
    
    // Nueva funci√≥n: Panel de Insights
    function renderInsightsChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        if (dataToProcess.length === 0) { chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos.</p>'; return; }
        chartContainerEl.innerHTML = '';
        const container = d3.select("#chartContainer");
        const workers = dataToProcess.map(w => { const tc = (w.operator_posts || []).reduce((s, p) => s + (Number(p.count) || 0), 0); let th = 0; (w.operator_posts || []).forEach(p => { if (p.created_at) { const st = new Date(p.created_at); const et = p.finish_at ? new Date(p.finish_at) : new Date(); if (et > st) th += (et - st) / 3600000; } }); return { name: w.name || `ID: ${w.client_id}`, totalCajas: tc, cajasHora: th > 0 ? (tc / th) : 0, totalHours: th }; }).filter(w => w.totalCajas > 0).sort((a, b) => b.totalCajas - a.totalCajas);
        const avgCH = workers.reduce((s, w) => s + w.cajasHora, 0) / workers.length;
        const top = workers[0], bot = workers[workers.length - 1];
        container.append("h3").style("text-align", "center").style("margin", "1rem 0 2rem 0").style("font-size", "1.5rem").style("font-weight", "bold").style("color", "#1f2937").text("üí° Insights Inteligentes");
        const ic = container.append("div").style("max-height", "600px").style("overflow-y", "auto").style("padding", "0 1rem");
        const ins = [{ icon: "üåü", title: "Mejor Trabajador", message: `${top.name} lidera con ${top.totalCajas} cajas (${top.cajasHora.toFixed(1)} c/h)`, color: "#10b981" }];
        if (bot.cajasHora < avgCH * 0.7) ins.push({ icon: "‚ö†Ô∏è", title: "Necesita Apoyo", message: `${bot.name} est√° ${((1 - bot.cajasHora/avgCH) * 100).toFixed(0)}% por debajo del promedio`, color: "#ef4444" });
        const out = workers.filter(w => w.cajasHora > avgCH * 1.2); if (out.length > 0) ins.push({ icon: "üöÄ", title: "Rendimiento Excepcional", message: `${out.length} trabajador${out.length > 1 ? 'es' : ''} superan el promedio en +20%`, color: "#10b981" });
        ins.push({ icon: "üìä", title: "Distribuci√≥n", message: `${workers.filter(w => w.cajasHora > avgCH).length} sobre el promedio, ${workers.filter(w => w.cajasHora <= avgCH).length} por debajo`, color: "#3b82f6" });
        ins.push({ icon: "üèÜ", title: "Top 3", message: `1¬∫ ${workers[0].name} (${workers[0].totalCajas}), 2¬∫ ${workers[1]?.name || 'N/A'} (${workers[1]?.totalCajas || 0}), 3¬∫ ${workers[2]?.name || 'N/A'} (${workers[2]?.totalCajas || 0})`, color: "#f59e0b" });
        const stdDev = Math.sqrt(workers.reduce((s, w) => s + Math.pow(w.cajasHora - avgCH, 2), 0) / workers.length);
        const cs = stdDev < avgCH * 0.2 ? "Alta" : stdDev < avgCH * 0.4 ? "Media" : "Baja";
        ins.push({ icon: "üìâ", title: "Consistencia", message: `Variabilidad ${cs} (œÉ=${stdDev.toFixed(1)} c/h)`, color: cs === "Alta" ? "#10b981" : cs === "Media" ? "#f59e0b" : "#ef4444" });
        ins.forEach((i, idx) => { const c = ic.append("div").style("background", "linear-gradient(135deg, #ffffff 0%, #f9fafb 100%)").style("border-left", `4px solid ${i.color}`).style("border-radius", "0.5rem").style("padding", "1rem").style("margin-bottom", "1rem").style("box-shadow", "0 2px 4px rgba(0,0,0,0.1)").style("opacity", "0"); setTimeout(() => c.style("opacity", "1"), idx * 100); const h = c.append("div").style("display", "flex").style("align-items", "center").style("margin-bottom", "0.5rem"); h.append("span").style("font-size", "1.5rem").style("margin-right", "0.75rem").text(i.icon); h.append("h4").style("font-size", "1rem").style("font-weight", "600").style("color", i.color).style("margin", "0").text(i.title); c.append("p").style("font-size", "0.875rem").style("color", "#4b5563").style("margin", "0").style("padding-left", "2.25rem").text(i.message); });
    }
    
    // Nueva funci√≥n: Comparativa Temporal
    async function renderTemporalComparisonChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        chartContainerEl.innerHTML = '<div class="text-center p-4"><div class="spinner"></div><p class="mt-2">Cargando datos de comparaci√≥n...</p></div>';
        const container = d3.select("#chartContainer");
        
        try {
            // Obtener per√≠odo actual
            const currentPeriod = getDateRange(dateRangeSelect ? dateRangeSelect.value : 'today');
            
            // Calcular per√≠odo anterior equivalente
            const currentStart = new Date(currentPeriod.from);
            const currentEnd = new Date(currentPeriod.to);
            const daysDiff = Math.ceil((currentEnd - currentStart) / (1000 * 60 * 60 * 24));
            
            const previousEnd = new Date(currentStart);
            previousEnd.setDate(previousEnd.getDate() - 1);
            const previousStart = new Date(previousEnd);
            previousStart.setDate(previousStart.getDate() - daysDiff + 1);
            
            const previousPeriod = {
                from: formatDateForAPI(previousStart),
                to: formatDateForAPI(previousEnd)
            };
            
            // Cargar datos del per√≠odo anterior
            const previousResponse = await fetch(`${apiBaseUrl}?from=${previousPeriod.from}&to=${previousPeriod.to}`);
            if (!previousResponse.ok) throw new Error('Error al cargar datos anteriores');
            const previousApiResponse = await previousResponse.json();
            
            // Verificar que la respuesta tenga el formato correcto
            if (!previousApiResponse.success || !Array.isArray(previousApiResponse.data)) {
                throw new Error('No hay datos disponibles para el per√≠odo anterior');
            }
            const previousData = previousApiResponse.data;
            
            // Procesar datos actuales
            const currentDataProcessed = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
            
            // Comparar trabajadores
            const comparisons = currentDataProcessed.map(currWorker => {
                const currTotalCajas = (currWorker.operator_posts || []).reduce((s, p) => s + (Number(p.count) || 0), 0);
                let currTotalHours = 0;
                (currWorker.operator_posts || []).forEach(p => {
                    if (p.created_at) {
                        const st = new Date(p.created_at);
                        const et = p.finish_at ? new Date(p.finish_at) : new Date();
                        if (et > st) currTotalHours += (et - st) / 3600000;
                    }
                });
                const currCajasHora = currTotalHours > 0 ? (currTotalCajas / currTotalHours) : 0;
                
                // Buscar mismo trabajador en per√≠odo anterior
                const prevWorker = previousData.find(w => w.client_id === currWorker.client_id);
                let prevTotalCajas = 0, prevTotalHours = 0, prevCajasHora = 0;
                
                if (prevWorker) {
                    prevTotalCajas = (prevWorker.operator_posts || []).reduce((s, p) => s + (Number(p.count) || 0), 0);
                    (prevWorker.operator_posts || []).forEach(p => {
                        if (p.created_at) {
                            const st = new Date(p.created_at);
                            const et = p.finish_at ? new Date(p.finish_at) : new Date();
                            if (et > st) prevTotalHours += (et - st) / 3600000;
                        }
                    });
                    prevCajasHora = prevTotalHours > 0 ? (prevTotalCajas / prevTotalHours) : 0;
                }
                
                const changeInCajas = prevTotalCajas > 0 ? ((currTotalCajas - prevTotalCajas) / prevTotalCajas * 100) : (currTotalCajas > 0 ? 100 : 0);
                const changeInCH = prevCajasHora > 0 ? ((currCajasHora - prevCajasHora) / prevCajasHora * 100) : (currCajasHora > 0 ? 100 : 0);
                
                return {
                    name: currWorker.name || `ID: ${currWorker.client_id}`,
                    currCajas: currTotalCajas,
                    prevCajas: prevTotalCajas,
                    currHours: currTotalHours,
                    prevHours: prevTotalHours,
                    currCH: currCajasHora,
                    prevCH: prevCajasHora,
                    changeCajas: changeInCajas,
                    changeCH: changeInCH,
                    hasPrevData: !!prevWorker
                };
            }).filter(w => w.currCajas > 0 || w.prevCajas > 0);
            
            comparisons.sort((a, b) => b.changeCH - a.changeCH); // Ordenar por cambio en c/h
            
            chartContainerEl.innerHTML = '';
            container.append("h3").style("text-align", "center").style("margin", "1rem 0").style("font-size", "1.5rem").style("font-weight", "bold").style("color", "#1f2937").text("üìà Comparativa Temporal de Per√≠odos");
            
            // Info de per√≠odos
            container.append("div").style("background", "linear-gradient(135deg, #667eea 0%, #764ba2 100%)").style("color", "white").style("padding", "1rem").style("border-radius", "0.5rem").style("margin", "1rem 0").style("text-align", "center").html(`<p style="margin: 0; font-size: 0.9rem;"><strong>Per√≠odo Actual:</strong> ${currentPeriod.from} ‚Üí ${currentPeriod.to} | <strong>Per√≠odo Anterior:</strong> ${previousPeriod.from} ‚Üí ${previousPeriod.to}</p>`);
            
            if (comparisons.length === 0) {
                container.append("p").style("text-align", "center").style("color", "#6b7280").style("padding", "2rem").text("No hay datos disponibles para comparaci√≥n.");
                return;
            }
            
            // Estad√≠sticas generales - Usar cambio en c/h como m√©trica principal (m√°s justo)
            const avgChangeCajas = comparisons.reduce((s, w) => s + w.changeCajas, 0) / comparisons.length;
            const avgChangeCH = comparisons.reduce((s, w) => s + w.changeCH, 0) / comparisons.length;
            const improving = comparisons.filter(w => w.changeCH > 0).length; // Basado en c/h
            const declining = comparisons.filter(w => w.changeCH < 0).length; // Basado en c/h
            const newWorkers = comparisons.filter(w => !w.hasPrevData).length;
            
            // Aviso sobre comparaci√≥n
            container.append("div").style("background", "linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)").style("border-left", "4px solid #f59e0b").style("padding", "1rem").style("border-radius", "0.5rem").style("margin", "1rem 0").html('<div style="display: flex; align-items: center;"><span style="font-size: 1.5rem; margin-right: 0.5rem;">‚ö†Ô∏è</span><p style="margin: 0; font-size: 0.85rem; color: #92400e;"><strong>Nota:</strong> El "Cambio Cajas" puede ser negativo si los per√≠odos tienen diferente duraci√≥n (ej: d√≠a parcial vs d√≠a completo). <strong>Usa "Cambio c/h"</strong> para comparar eficiencia real.</p></div>');
            
            const statsDiv = container.append("div").style("display", "grid").style("grid-template-columns", "repeat(auto-fit, minmax(180px, 1fr))").style("gap", "1rem").style("margin", "1rem 0").style("padding", "1rem").style("background", "#f9fafb").style("border-radius", "0.5rem");
            statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Mejorando</div><div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">${improving} ‚Üë</div>`);
            statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Bajando</div><div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;">${declining} ‚Üì</div>`);
            statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Nuevos</div><div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${newWorkers}</div>`);
            statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Cambio Cajas</div><div style="font-size: 1.5rem; font-weight: bold; color: ${avgChangeCajas > 0 ? '#10b981' : '#ef4444'};">${avgChangeCajas > 0 ? '+' : ''}${avgChangeCajas.toFixed(1)}%</div>`);
            statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Cambio c/h</div><div style="font-size: 1.5rem; font-weight: bold; color: ${avgChangeCH > 0 ? '#10b981' : '#ef4444'};">${avgChangeCH > 0 ? '+' : ''}${avgChangeCH.toFixed(1)}%</div>`);
            
            // Tabla de comparaci√≥n
            const tableContainer = container.append("div").style("max-height", "500px").style("overflow-y", "auto").style("margin", "1rem 0").style("border", "1px solid #e5e7eb").style("border-radius", "0.5rem");
            const table = tableContainer.append("table").style("width", "100%").style("border-collapse", "collapse").style("background", "white");
            const thead = table.append("thead").style("background", "linear-gradient(135deg, #667eea 0%, #764ba2 100%)").style("color", "white").style("position", "sticky").style("top", "0").style("z-index", "10");
            const headerRow = thead.append("tr");
            ['Trabajador', 'Horas Act.', 'Horas Ant.', 'Cajas Act.', 'Cajas Ant.', 'c/h Actual', 'c/h Anterior', 'Cambio c/h %'].forEach(h => headerRow.append("th").style("padding", "0.75rem").style("text-align", "left").style("font-size", "0.875rem").style("font-weight", "600").text(h));
            
            const tbody = table.append("tbody");
            comparisons.slice(0, 20).forEach((w, i) => {
                const row = tbody.append("tr").style("border-bottom", "1px solid #e5e7eb").style("background", i % 2 === 0 ? "white" : "#f9fafb");
                row.append("td").style("padding", "0.75rem").style("font-weight", "500").text(w.name);
                row.append("td").style("padding", "0.75rem").style("font-size", "0.85rem").style("color", "#6b7280").text(w.currHours.toFixed(1) + 'h');
                row.append("td").style("padding", "0.75rem").style("font-size", "0.85rem").style("color", "#6b7280").text(w.hasPrevData ? w.prevHours.toFixed(1) + 'h' : 'N/A');
                row.append("td").style("padding", "0.75rem").text(w.currCajas);
                row.append("td").style("padding", "0.75rem").text(w.hasPrevData ? w.prevCajas : 'N/A');
                row.append("td").style("padding", "0.75rem").style("font-weight", "600").text(w.currCH.toFixed(2));
                row.append("td").style("padding", "0.75rem").style("font-weight", "600").text(w.hasPrevData ? w.prevCH.toFixed(2) : 'N/A');
                const changeCHCell = row.append("td").style("padding", "0.75rem");
                changeCHCell.append("span").style("padding", "0.25rem 0.5rem").style("background", w.changeCH > 0 ? '#10b981' : w.changeCH < 0 ? '#ef4444' : '#6b7280').style("color", "white").style("border-radius", "0.25rem").style("font-size", "0.875rem").style("font-weight", "600").text(`${w.changeCH > 0 ? '+' : ''}${w.changeCH.toFixed(1)}%`);
            });
        } catch (error) {
            chartContainerEl.innerHTML = `<div class="text-center p-4 text-red-500"><p>Error al cargar la comparaci√≥n: ${error.message}</p><p class="text-sm mt-2">Verifica que hay datos disponibles para el per√≠odo anterior.</p></div>`;
            console.error('Error en comparaci√≥n temporal:', error);
        }
    }
    
    // Nueva funci√≥n: Heatmap por hora
    function renderHeatmapChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        if (dataToProcess.length === 0) { chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos.</p>'; return; }
        chartContainerEl.innerHTML = '';
        const container = d3.select("#chartContainer");
        container.append("h3").style("text-align", "center").style("margin", "1rem 0").style("font-size", "1.5rem").style("font-weight", "bold").style("color", "#1f2937").text("üïê Heatmap de Productividad por Hora");
        const hourlyData = {};
        dataToProcess.forEach(w => { 
            const wn = w.name || `ID: ${w.client_id}`; 
            hourlyData[wn] = Array(24).fill(0); 
            (w.operator_posts || []).forEach(p => { 
                if (p.created_at) { 
                    const startDate = new Date(p.created_at);
                    const endDate = p.finish_at ? new Date(p.finish_at) : new Date();
                    const count = Number(p.count) || 0;
                    
                    // Calcular horas trabajadas
                    const startHour = startDate.getHours();
                    const endHour = endDate.getHours();
                    const totalMinutes = (endDate - startDate) / 60000; // Duraci√≥n en minutos
                    
                    if (totalMinutes > 0 && count > 0) {
                        // Si el trabajo es en la misma hora
                        if (startHour === endHour) {
                            hourlyData[wn][startHour] += count;
                        } else {
                            // Distribuir proporcionalmente entre las horas trabajadas
                            const startMinutes = 60 - startDate.getMinutes(); // Minutos restantes en hora de inicio
                            const endMinutes = endDate.getMinutes(); // Minutos en hora de fin
                            
                            // Minutos en horas completas intermedias
                            const hoursInBetween = endHour - startHour - 1;
                            const totalWorkMinutes = startMinutes + (hoursInBetween * 60) + endMinutes;
                            
                            if (totalWorkMinutes > 0) {
                                // Asignar a hora de inicio
                                hourlyData[wn][startHour] += Math.round(count * (startMinutes / totalWorkMinutes));
                                
                                // Asignar a horas intermedias
                                for (let h = startHour + 1; h < endHour; h++) {
                                    hourlyData[wn][h] += Math.round(count * (60 / totalWorkMinutes));
                                }
                                
                                // Asignar a hora de fin
                                if (endMinutes > 0) {
                                    hourlyData[wn][endHour] += Math.round(count * (endMinutes / totalWorkMinutes));
                                }
                            }
                        }
                    } else if (count > 0) {
                        // Fallback: asignar a hora de inicio si no hay finish_at v√°lido
                        hourlyData[wn][startHour] += count;
                    }
                } 
            }); 
        });
        const workers = Object.keys(hourlyData).filter(n => hourlyData[n].some(v => v > 0)).slice(0, 15);
        if (workers.length === 0) { container.append("p").style("text-align", "center").style("color", "#6b7280").style("padding", "2rem").text("No hay suficientes datos temporales."); return; }
        let minH = 23, maxH = 0; workers.forEach(w => { hourlyData[w].forEach((v, h) => { if (v > 0) { minH = Math.min(minH, h); maxH = Math.max(maxH, h); } }); });
        minH = Math.max(0, minH - 1); maxH = Math.min(23, maxH + 1);
        const hours = Array.from({length: maxH - minH + 1}, (_, i) => minH + i);
        const rect = chartContainerEl.getBoundingClientRect(); const containerWidth = rect.width;
        const margin = {top: 80, right: 100, bottom: 60, left: 150}; const cellSize = Math.min(40, (containerWidth - margin.left - margin.right) / hours.length);
        const width = cellSize * hours.length, height = cellSize * workers.length;
        const svg = d3.select("#chartContainer").append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        const maxValue = d3.max(workers, w => d3.max(hourlyData[w]));
        const colorScale = d3.scaleSequential().domain([0, maxValue]).interpolator(d3.interpolateRgb("#f0f9ff", "#0369a1"));
        workers.forEach((w, i) => { hours.forEach((h, j) => { const v = hourlyData[w][h]; svg.append("rect").attr("x", j * cellSize).attr("y", i * cellSize).attr("width", cellSize - 2).attr("height", cellSize - 2).attr("fill", v > 0 ? colorScale(v) : "#f3f4f6").attr("stroke", "#e5e7eb").attr("stroke-width", 1).style("cursor", "pointer").on("mouseover", function(e) { d3.select(this).attr("stroke", "#1f2937").attr("stroke-width", 2); tooltip.transition().duration(200).style("opacity", .9); tooltip.html(`<strong>${w}</strong><br/>Hora: ${h}:00<br/>Cajas: ${v}`).style("left", (e.pageX + 10) + "px").style("top", (e.pageY - 15) + "px"); }).on("mouseout", function() { d3.select(this).attr("stroke", "#e5e7eb").attr("stroke-width", 1); tooltip.transition().duration(500).style("opacity", 0); }); if (v > 0) svg.append("text").attr("x", j * cellSize + cellSize / 2).attr("y", i * cellSize + cellSize / 2).attr("text-anchor", "middle").attr("dominant-baseline", "middle").style("font-size", `${Math.min(10, cellSize / 4)}px`).style("font-weight", "bold").style("fill", v > maxValue * 0.6 ? "white" : "#1f2937").style("pointer-events", "none").text(v); }); });
        svg.selectAll(".worker-label").data(workers).join("text").attr("class", "worker-label").attr("x", -10).attr("y", (d, i) => i * cellSize + cellSize / 2).attr("text-anchor", "end").attr("dominant-baseline", "middle").style("font-size", "11px").style("font-weight", "500").text(d => d.length > 20 ? d.substring(0, 17) + '...' : d);
        svg.selectAll(".hour-label").data(hours).join("text").attr("class", "hour-label").attr("x", (d, i) => i * cellSize + cellSize / 2).attr("y", -10).attr("text-anchor", "middle").style("font-size", "11px").style("font-weight", "500").text(d => `${d}:00`);
        const hourTotals = Array(24).fill(0); workers.forEach(w => { hourlyData[w].forEach((v, h) => { hourTotals[h] += v; }); });
        const peakHour = hourTotals.indexOf(Math.max(...hourTotals));
        const statsDiv = container.insert("div", ":first-child").style("display", "grid").style("grid-template-columns", "repeat(auto-fit, minmax(200px, 1fr))").style("gap", "1rem").style("margin", "1rem 0").style("padding", "1rem").style("background", "#f9fafb").style("border-radius", "0.5rem");
        statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Hora Pico</div><div style="font-size: 1.5rem; font-weight: bold; color: #0369a1;">${peakHour}:00</div>`);
        statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Producci√≥n en Hora Pico</div><div style="font-size: 1.5rem; font-weight: bold; color: #0369a1;">${hourTotals[peakHour]} cajas</div>`);
        statsDiv.append("div").style("text-align", "center").html(`<div style="font-size: 0.875rem; color: #6b7280;">Rango Horario</div><div style="font-size: 1.5rem; font-weight: bold; color: #0369a1;">${minH}:00 - ${maxH}:00</div>`);
        
        // Leyenda explicativa
        const legendDiv = container.append("div")
            .style("margin-top", "2rem")
            .style("padding", "1.5rem")
            .style("background", "linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%)")
            .style("border-left", "4px solid #0369a1")
            .style("border-radius", "0.5rem")
            .style("box-shadow", "0 2px 4px rgba(0,0,0,0.1)");
        
        legendDiv.append("div")
            .style("display", "flex")
            .style("align-items", "center")
            .style("margin-bottom", "1rem")
            .html('<span style="font-size: 1.5rem; margin-right: 0.75rem;">‚ÑπÔ∏è</span><h4 style="font-size: 1.1rem; font-weight: 600; color: #0369a1; margin: 0;">¬øC√≥mo se calcula este Heatmap?</h4>');
        
        legendDiv.append("div")
            .style("font-size", "0.9rem")
            .style("color", "#334155")
            .style("line-height", "1.6")
            .html(`
                <p style="margin: 0.5rem 0;"><strong>üìä Distribuci√≥n proporcional de la producci√≥n:</strong> Las cajas no se asignan √∫nicamente a la hora de inicio, sino que se distribuyen proporcionalmente entre todas las horas trabajadas.</p>
                <p style="margin: 0.5rem 0;"><strong>üïê Ejemplo:</strong> Si un trabajador produce 120 cajas de 8:30 a 11:15:</p>
                <ul style="margin: 0.5rem 0; padding-left: 2rem;">
                    <li><strong>8:00-9:00</strong>: 30 minutos trabajados ‚Üí recibe ~22 cajas</li>
                    <li><strong>9:00-10:00</strong>: 60 minutos trabajados ‚Üí recibe ~43 cajas</li>
                    <li><strong>10:00-11:00</strong>: 60 minutos trabajados ‚Üí recibe ~43 cajas</li>
                    <li><strong>11:00-12:00</strong>: 15 minutos trabajados ‚Üí recibe ~12 cajas</li>
                </ul>
                <p style="margin: 0.5rem 0;"><strong>üé® Escala de colores:</strong> Del azul claro (baja producci√≥n) al azul oscuro (alta producci√≥n). Los n√∫meros en cada celda muestran la cantidad exacta de cajas.</p>
                <p style="margin: 0.5rem 0;"><strong>üí° Interpretaci√≥n:</strong> Este heatmap te permite identificar las franjas horarias m√°s productivas y las horas de menor rendimiento para optimizar la planificaci√≥n.</p>
            `);
    }

    function formatDateForAPI(date) { const y = date.getFullYear(), m = String(date.getMonth() + 1).padStart(2, '0'), d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
    function getDateRange(selectedValue) {
        const today = new Date(); today.setHours(0,0,0,0); let from = new Date(today), to = new Date(today);
        
        // Si es personalizado, usar las fechas del input
        if (selectedValue === 'custom') {
            if (customDateFrom && customDateFrom.value) {
                from = new Date(customDateFrom.value);
            }
            if (customDateTo && customDateTo.value) {
                to = new Date(customDateTo.value);
            } else {
                to = new Date(from); // Si no hay fecha 'hasta', usar la misma que 'desde'
            }
        } else {
            switch(selectedValue){ case 'yesterday':from.setDate(today.getDate()-1);to.setDate(today.getDate()-1);break; case 'day_minus_2':from.setDate(today.getDate()-2);to.setDate(today.getDate()-2);break; case 'day_minus_3':from.setDate(today.getDate()-3);to.setDate(today.getDate()-3);break; case 'day_minus_4':from.setDate(today.getDate()-4);to.setDate(today.getDate()-4);break; case 'day_minus_5':from.setDate(today.getDate()-5);to.setDate(today.getDate()-5);break; case 'day_minus_6':from.setDate(today.getDate()-6);to.setDate(today.getDate()-6);break; case 'day_minus_7':from.setDate(today.getDate()-7);to.setDate(today.getDate()-7);break; case 'last7days':from.setDate(today.getDate()-6);break; case 'last30days':from.setDate(today.getDate()-29);break; }
        }
        
        let apiTo = new Date(to); apiTo.setDate(to.getDate()+1); return {from:formatDateForAPI(from), to:formatDateForAPI(apiTo)};
    }
    function calculateCajasHora(count, startTimeStr, endTimeStr) {
        const q = parseFloat(count)||0; if(!startTimeStr)return 'N/A'; const sT = new Date(startTimeStr); if(isNaN(sT.getTime()))return 'N/A';
        const eT = endTimeStr ? new Date(endTimeStr) : new Date(); if(isNaN(eT.getTime()))return 'N/A';
        if(eT <= sT)return q > 0 ? 'N/A' : '0.00'; const dMs = eT.getTime()-sT.getTime(), dH = dMs/3600000;
        if(dH <= 0)return q > 0 ? 'N/A' : '0.00'; if(q === 0)return '0.00'; return (q/dH).toFixed(2);
    }
    function updateLiveCajasHoraCells() { document.querySelectorAll('.live-cajas-hora').forEach(c => { c.textContent = calculateCajasHora(c.dataset.count, c.dataset.startTime, null); }); }
    function filterDataByCheckbox(data) { if(filterPostsCheckbox && filterPostsCheckbox.checked) return data.filter(w => w.operator_posts && w.operator_posts.some(p=>(p.count??0)>0)); return data; }
    function filterDataBySearch(data, searchTerm) {
        if(!searchTerm)return data; const lST = searchTerm.toLowerCase();
        return data.filter(w => (w.name||'').toLowerCase().includes(lST) || (w.client_id||'').toString().toLowerCase().includes(lST) || (w.operator_posts && w.operator_posts.some(p => ((p.rfid_reading?.name||'').toLowerCase().includes(lST)) || ((p.product_list?.name||'').toLowerCase().includes(lST)))));
    }
    function updateGrandTotalUnidades() {
        const sT = searchInput ? searchInput.value : ''; const dF = filterDataBySearch(filterDataByCheckbox(originalWorkersData), sT);
        let gT = 0; dF.forEach(w => { gT += (w.operator_posts||[]).reduce((s,p)=>{const c=p.count??0; if(filterPostsCheckbox && filterPostsCheckbox.checked&&c===0)return s; return s+c;},0); });
        if(totalUnidadesTurnoHeader) totalUnidadesTurnoHeader.textContent = `(${gT})`;
    }
    function updateKPICards() {
        const searchTerm = searchInput ? searchInput.value : '';
        const dataToDisplay = filterDataBySearch(filterDataByCheckbox(originalWorkersData), searchTerm);

        if (!kpiTotalCajas || (dataToDisplay.length === 0 && !searchTerm && (!filterPostsCheckbox || !filterPostsCheckbox.checked) && originalWorkersData.length === 0) || (dataToDisplay.length === 0 && filterPostsCheckbox && filterPostsCheckbox.checked)) {
            if(kpiTotalCajas)kpiTotalCajas.textContent='-';
            if(kpiTrabajadoresActivos)kpiTrabajadoresActivos.textContent='0';
            if(kpiAvgCajasHora)kpiAvgCajasHora.textContent='-';
            if(kpiPuestoMasProductivo)kpiPuestoMasProductivo.textContent='-';
            if(kpiCardContainer && !isLocked)kpiCardContainer.classList.add('hidden');
            return;
        }
        if(kpiCardContainer && !isLocked)kpiCardContainer.classList.remove('hidden');

        let totalCajas = 0, totalHorasTrabajadas = 0, trabajadoresActivos = 0;
        let topWorkerName = '-', topWorkerCajas = 0;
        let totalPosts = 0, totalTiempoTotal = 0;
        
        dataToDisplay.forEach(worker => {
            let workerHasProductionInView = false;
            let cajasDelTrabajadorActual = 0;

            if (worker.operator_posts && worker.operator_posts.length > 0) {
                worker.operator_posts.forEach(post => {
                    const cantidad = Number(post.count) || 0;
                    if (cantidad > 0) {
                        workerHasProductionInView = true;
                        cajasDelTrabajadorActual += cantidad;
                        totalCajas += cantidad;
                        totalPosts++;
                        
                        if (post.created_at) {
                            const start = new Date(post.created_at);
                            const end = post.finish_at ? new Date(post.finish_at) : new Date();
                            if (end > start) {
                                const duracionHoras = (end - start) / (1000 * 60 * 60);
                                totalHorasTrabajadas += duracionHoras;
                                totalTiempoTotal += duracionHoras;
                            }
                        }
                    }
                });
            }
            
            if (workerHasProductionInView) {
                trabajadoresActivos++;
                if (cajasDelTrabajadorActual > topWorkerCajas) {
                    topWorkerCajas = cajasDelTrabajadorActual;
                    topWorkerName = worker.name || `ID: ${worker.client_id}`;
                }
            }
        });
        
        const avgCajasHora = totalHorasTrabajadas > 0 ? (totalCajas / totalHorasTrabajadas).toFixed(1) : '0.0';
        
        // Calcular eficiencia global basada en los mejores rendimientos
        let eficienciaGlobal = '0';
        let cajasHoraPorTrabajador = [];
        if (totalHorasTrabajadas > 0) {
            // Obtener cajas/hora de todos los trabajadores activos
            dataToDisplay.forEach(worker => {
                let workerCajas = 0;
                let workerHoras = 0;
                (worker.operator_posts || []).forEach(post => {
                    const cantidad = Number(post.count) || 0;
                    if (cantidad > 0 && post.created_at) {
                        workerCajas += cantidad;
                        const start = new Date(post.created_at);
                        const end = post.finish_at ? new Date(post.finish_at) : new Date();
                        if (end > start) {
                            workerHoras += (end - start) / (1000 * 60 * 60);
                        }
                    }
                });
                if (workerHoras > 0 && workerCajas > 0) {
                    cajasHoraPorTrabajador.push(workerCajas / workerHoras);
                }
            });
            
            if (cajasHoraPorTrabajador.length >= 3) {
                // Tomar los 3 mejores rendimientos como referencia (100%)
                const top3CajasHora = [...cajasHoraPorTrabajador].sort((a, b) => b - a).slice(0, 3);
                const referenciaOptima = top3CajasHora.reduce((sum, val) => sum + val, 0) / 3;
                const avgActual = parseFloat(avgCajasHora);
                eficienciaGlobal = Math.min(100, (avgActual / referenciaOptima * 100)).toFixed(0);
            } else if (cajasHoraPorTrabajador.length > 0) {
                // Si hay menos de 3 trabajadores, usar el mejor como referencia
                const mejorRendimiento = Math.max(...cajasHoraPorTrabajador);
                const avgActual = parseFloat(avgCajasHora);
                eficienciaGlobal = Math.min(100, (avgActual / mejorRendimiento * 100)).toFixed(0);
            }
        }
        
        const tiempoPromedioPorCaja = totalCajas > 0 ? (totalHorasTrabajadas * 60 / totalCajas).toFixed(1) : '0.0'; // minutos por caja
        
        // Actualizar valores y tooltips
        if (kpiTotalCajas) {
            kpiTotalCajas.innerHTML = `${totalCajas}<span class="trend-arrow trend-up">‚Üó</span>`;
            updateKPIIndicator('kpiTotalCajasIndicator', totalCajas > 1000 ? 'excellent' : totalCajas > 500 ? 'good' : 'warning');
            const tooltip = document.getElementById('kpiTotalCajasTooltip');
            if (tooltip) tooltip.textContent = `Total: ${totalCajas} cajas producidas por ${trabajadoresActivos} trabajadores`;
        }
        if (kpiTrabajadoresActivos) {
            kpiTrabajadoresActivos.innerHTML = `${trabajadoresActivos}<span class="trend-arrow trend-stable">‚Üí</span>`;
            updateKPIIndicator('kpiTrabajadoresIndicator', trabajadoresActivos > 10 ? 'excellent' : trabajadoresActivos > 5 ? 'good' : 'warning');
            const tooltip = document.getElementById('kpiTrabajadoresTooltip');
            if (tooltip) tooltip.textContent = `${trabajadoresActivos} operarios activos con producci√≥n registrada`;
        }
        if (kpiAvgCajasHora) {
            kpiAvgCajasHora.innerHTML = `${avgCajasHora}<span class="trend-arrow trend-up">‚Üó</span>`;
            updateKPIIndicator('kpiAvgIndicator', parseFloat(avgCajasHora) > 40 ? 'excellent' : parseFloat(avgCajasHora) > 25 ? 'good' : 'warning');
            const tooltip = document.getElementById('kpiAvgTooltip');
            if (tooltip) tooltip.textContent = `Productividad promedio: ${avgCajasHora} cajas/hora (${totalHorasTrabajadas.toFixed(1)}h trabajadas)`;
        }
        if (kpiPuestoMasProductivo) {
            const displayName = topWorkerName.length > 12 ? topWorkerName.substring(0, 9) + "..." : topWorkerName;
            kpiPuestoMasProductivo.innerHTML = `${displayName}<span class="trend-arrow trend-up">‚Üó</span>`;
            updateKPIIndicator('kpiTopIndicator', topWorkerCajas > 200 ? 'excellent' : topWorkerCajas > 100 ? 'good' : 'warning');
            const tooltip = document.getElementById('kpiTopTooltip');
            if (tooltip) tooltip.textContent = `${topWorkerName}: ${topWorkerCajas} cajas producidas (l√≠der del per√≠odo)`;
        }
        if (kpiEficienciaGlobal) {
            const eficienciaNum = parseFloat(eficienciaGlobal);
            kpiEficienciaGlobal.innerHTML = `${eficienciaGlobal}%<span class="trend-arrow ${eficienciaNum > 80 ? 'trend-up' : eficienciaNum > 60 ? 'trend-stable' : 'trend-down'}">${eficienciaNum > 80 ? '‚Üó' : eficienciaNum > 60 ? '‚Üí' : '‚Üò'}</span>`;
            updateKPIIndicator('kpiEficienciaIndicator', eficienciaNum > 80 ? 'excellent' : eficienciaNum > 60 ? 'good' : 'warning');
            
            const tooltip = document.getElementById('kpiEficienciaTooltip');
            if (tooltip && cajasHoraPorTrabajador && cajasHoraPorTrabajador.length >= 3) {
                const top3 = [...cajasHoraPorTrabajador].sort((a, b) => b - a).slice(0, 3);
                const referencia = (top3.reduce((sum, val) => sum + val, 0) / 3).toFixed(1);
                tooltip.textContent = `Eficiencia: ${avgCajasHora} c/h vs referencia √≥ptima: ${referencia} c/h (${eficienciaGlobal}%)`;
            }
        }
        if (kpiTiempoPromedio) {
            kpiTiempoPromedio.innerHTML = `${tiempoPromedioPorCaja}min<span class="trend-arrow ${tiempoPromedioPorCaja < 1.5 ? 'trend-up' : tiempoPromedioPorCaja < 2.5 ? 'trend-stable' : 'trend-down'}">${tiempoPromedioPorCaja < 1.5 ? '‚Üó' : tiempoPromedioPorCaja < 2.5 ? '‚Üí' : '‚Üò'}</span>`;
            updateKPIIndicator('kpiTiempoIndicator', tiempoPromedioPorCaja < 1.5 ? 'excellent' : tiempoPromedioPorCaja < 2.5 ? 'good' : 'warning');
            const tooltip = document.getElementById('kpiTiempoTooltip');
            if (tooltip) tooltip.textContent = `Tiempo promedio: ${tiempoPromedioPorCaja} minutos por caja (${totalCajas} cajas totales)`;
        }
    }
    
    function updateKPIIndicator(indicatorId, status) {
        const indicator = document.getElementById(indicatorId);
        if (indicator) {
            indicator.className = `kpi-indicator ${status}`;
        }
    }
    function populateTable(data) {
        if(liveUpdateIntervalId)clearInterval(liveUpdateIntervalId);liveUpdateIntervalId=null;
        if(!tableBody) return;
        tableBody.querySelectorAll('tr:not(#loadingRow):not(#errorRow):not(#noDataRow)').forEach(r=>r.remove());
        const sT=searchInput?searchInput.value:'',dFC=filterDataByCheckbox(data),dTD=filterDataBySearch(dFC,sT);
        displayedPostRowsCount=0;let wVPC=0;
        dTD.forEach(w=>{const hVP=w.operator_posts&&w.operator_posts.some(p=>(p.count??0)>0);if(filterPostsCheckbox && filterPostsCheckbox.checked&&!hVP&&sT==='')return;let wMSD=false;if(sT){const lS=sT.toLowerCase();if((w.name||'').toLowerCase().includes(lS)||(w.client_id||'').toString().toLowerCase().includes(lS))wMSD=true;}let hADP=false;if(w.operator_posts){w.operator_posts.forEach(p=>{if((p.count??0)>0||(filterPostsCheckbox && !filterPostsCheckbox.checked)){if(filterPostsCheckbox && filterPostsCheckbox.checked&&(p.count??0)===0){}else{if(sT){const lS=sT.toLowerCase();if((p.rfid_reading?.name||'').toLowerCase().includes(lS)||(p.product_list?.name||'').toLowerCase().includes(lS))hADP=true;}else hADP=true;}}});}if(!wMSD&&!hADP&&sT!=='')return;wVPC++;if(w.operator_posts){w.operator_posts.forEach(p=>{const pC=p.count??0;let dTP=false;if(pC>0||(filterPostsCheckbox && !filterPostsCheckbox.checked)){if(filterPostsCheckbox && filterPostsCheckbox.checked&&pC===0){}else{if(sT){const lS=sT.toLowerCase();if(wMSD||(p.rfid_reading?.name||'').toLowerCase().includes(lS)||(p.product_list?.name||'').toLowerCase().includes(lS))dTP=true;}else dTP=true;}}if(dTP)displayedPostRowsCount++;});}});
        updateGrandTotalUnidades();updateKPICards();updateHeaderButtonsState();
        if(noDataRow){ if(displayedPostRowsCount===0){noDataRow.querySelector('td').textContent=sT?`No se encontraron resultados para "${sT}".`:(filterPostsCheckbox && filterPostsCheckbox.checked&&data.length>0?'Ning√∫n trabajador cumple los criterios.':'No se encontraron datos.');noDataRow.classList.remove('hidden');}else{noDataRow.classList.add('hidden');}}
        let hLC=false;wVPC=0;
        dTD.forEach(w=>{const tQS=(w.operator_posts||[]).reduce((s,p)=>s+((p.count??0)>0?(p.count??0):0),0);let wSBR=false;const lST=sT.toLowerCase();if(!sT){wSBR=!(filterPostsCheckbox && filterPostsCheckbox.checked&&!((w.operator_posts||[]).some(p=>(p.count??0)>0)));}else{if((w.name||'').toLowerCase().includes(lST)||(w.client_id||'').toString().toLowerCase().includes(lST))wSBR=true;else if(w.operator_posts)wSBR=w.operator_posts.some(p=>((p.rfid_reading?.name||'').toLowerCase().includes(lST))||((p.product_list?.name||'').toLowerCase().includes(lST)));}if(!wSBR)return;wVPC++;
        const wR=tableBody.insertRow();wR.classList.add('bg-blue-50','hover:bg-blue-100','transition-colors');wR.insertCell().textContent=w.client_id??'-';const nC=wR.insertCell();nC.textContent=w.name??'Sin Nombre';
        if(!isLocked){const aLIA=document.createElement('button');aLIA.classList.add('ml-2','px-2','py-1','text-xs','font-semibold','text-white','bg-gradient-to-r','from-purple-500','to-indigo-500','hover:from-purple-600','hover:to-indigo-600','rounded-md','shadow-sm','hover:shadow-md','transition-all','duration-150','inline-flex','items-center','gap-1');aLIA.title="An√°lisis Individual con IA";aLIA.innerHTML=`<svg style="width:14px;height:14px;" viewBox="0 0 24 24" fill="currentColor"><path d="M9.5 2A7.5 7.5 0 002 9.5c0 1.76.61 3.37 1.63 4.66l-1.36 4.08a1 1 0 001.28 1.28l4.08-1.36A7.47 7.47 0 009.5 17a7.5 7.5 0 000-15zM9 12H8v-1h1v1zm2 0h-1v-1h1v1zm2 0h-1v-1h1v1zm0-3H8V8h5v1z"/><circle cx="17" cy="17" r="5" fill="currentColor" opacity="0.5"/><path d="M17 14v6m-3-3h6" stroke="white" stroke-width="2" stroke-linecap="round"/></svg><span>ü§ñ IA</span>`;aLIA.addEventListener('click',(e)=>{e.stopPropagation();fetchLocalAIWorkerAnalysis(w);});nC.appendChild(aLIA);}
        const wUC=wR.insertCell();wUC.textContent=tQS;wR.insertCell();wR.insertCell();wR.insertCell();wR.insertCell();wR.insertCell();wR.insertCell();Array.from(wR.cells).forEach(c=>c.classList.add('px-4','py-3','text-sm','font-medium','text-gray-900','whitespace-nowrap'));
        if(w.operator_posts&&w.operator_posts.length>0){const sP=[...w.operator_posts].sort((a,b)=>(new Date(a.created_at)||0)-(new Date(b.created_at)||0));sP.forEach((p,pI)=>{const pC=p.count??0;let dTPR=false;if(!sT){if(pC>0||(filterPostsCheckbox && !filterPostsCheckbox.checked))dTPR=true;}else{const lS=sT.toLowerCase();if((w.name||'').toLowerCase().includes(lS)||(w.client_id||'').toString().toLowerCase().includes(lS)||(p.rfid_reading?.name||'').toLowerCase().includes(lS)||(p.product_list?.name||'').toLowerCase().includes(lS)){if(pC>0||(filterPostsCheckbox && !filterPostsCheckbox.checked))dTPR=true;}}if(!dTPR && !(filterPostsCheckbox && !filterPostsCheckbox.checked && pC === 0 && !sT)) return; if(filterPostsCheckbox && filterPostsCheckbox.checked && pC === 0 && dTPR && !sT) return;
        const pR=tableBody.insertRow();pR.classList.add((tableBody.rows.length-3)%2===0?'bg-white':'bg-gray-50','hover:bg-gray-100');pR.insertCell();pR.insertCell();pR.insertCell();pR.insertCell().textContent=p.rfid_reading?.name??'N/A';pR.insertCell().textContent=p.created_at?dateFormatter.format(new Date(p.created_at)):'-';pR.insertCell().textContent=p.finish_at?dateFormatter.format(new Date(p.finish_at)):'-';
        const qC=pR.insertCell();qC.textContent=pC+' ';const cHC=pR.insertCell();cHC.textContent=calculateCajasHora(pC,p.created_at,p.finish_at);
        if(!isLocked){const eIS=document.createElement('span');eIS.classList.add('edit-icon');eIS.innerHTML=`<svg class="icon" style="width:16px;height:16px;" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM16 5l-1.5-1.5L13 5l1.5 1.5L16 5zM5 14H3v2h12v-2H5z"/></svg>`;eIS.addEventListener('click',()=>showEditQuantityModal(w.client_id,pI,pC,qC,cHC,wUC));qC.appendChild(eIS);}
        if(!p.finish_at&&p.created_at){cHC.classList.add('live-cajas-hora');cHC.dataset.startTime=p.created_at;cHC.dataset.count=pC;hLC=true;}
        pR.insertCell().textContent=p.product_list?.name??'N/A';Array.from(pR.cells).forEach(c=>c.classList.add('px-4','py-3','text-sm','text-gray-600','whitespace-nowrap'));pR.cells[3].classList.add('pl-8');});}});
        if(hLC)liveUpdateIntervalId=setInterval(updateLiveCajasHoraCells,5000);
    }
    
    function exportToExcel() {
        const searchTerm = searchInput ? searchInput.value : '';
        const dataFiltered = filterDataBySearch(filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData))), searchTerm);
        if (!dataFiltered || dataFiltered.length === 0) { const noDataModal = document.createElement('div'); noDataModal.innerHTML = `<div class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-[2000]"><div class="bg-white rounded-lg shadow-xl p-6"><h3 class="text-lg font-medium">Sin Datos</h3><p class="mt-2">No hay datos para exportar.</p><button onclick="this.closest('.fixed').remove()" class="mt-4 px-3 py-1 bg-blue-500 text-white rounded">OK</button></div></div>`; document.body.appendChild(noDataModal); return; }
        const flattenedData = [];
        dataFiltered.forEach(worker => {
            const totalQuantitySum = (worker.operator_posts || []).reduce((sum, post) => sum + ((Number(post.count) ?? 0) > 0 ? (Number(post.count) ?? 0) : 0), 0);
            let workerShouldBeIncluded = !searchTerm || (worker.name || '').toLowerCase().includes(searchTerm.toLowerCase()) || (worker.client_id || '').toString().toLowerCase().includes(searchTerm.toLowerCase());
            if (!workerShouldBeIncluded && worker.operator_posts) { workerShouldBeIncluded = worker.operator_posts.some(post => ((post.rfid_reading?.name || '').toLowerCase().includes(searchTerm.toLowerCase())) || ((post.product_list?.name || '').toLowerCase().includes(searchTerm.toLowerCase())));}
            if (filterPostsCheckbox && filterPostsCheckbox.checked && !((worker.operator_posts || []).some(p => (Number(p.count) ?? 0) > 0)) && !workerShouldBeIncluded) return;
            (worker.operator_posts || []).filter(post => { let pMS = true; if(searchTerm){ const lS = searchTerm.toLowerCase(); pMS = (post.rfid_reading?.name || '').toLowerCase().includes(lS) || (post.product_list?.name || '').toLowerCase().includes(lS) || workerShouldBeIncluded; } return ((Number(post.count) ?? 0) > 0 || (filterPostsCheckbox && !filterPostsCheckbox.checked)) && pMS;
            }).forEach(post => { flattenedData.push({ 'Codigo': worker.client_id ?? '-', 'Nombre Trabajador': worker.name ?? 'Sin Nombre', 'Unidades Turno': totalQuantitySum, 'Puesto': post.rfid_reading?.name ?? 'N/A', 'Inicio Puesto': post.created_at ? dateFormatter.format(new Date(post.created_at)) : '-', 'Fin Puesto': post.finish_at ? dateFormatter.format(new Date(post.finish_at)) : '-', 'Cantidad Puesto': (Number(post.count) ?? 0), 'Cajas/Hora': calculateCajasHora(post.count, post.created_at, post.finish_at), 'Confeccion': post.product_list?.name ?? 'N/A' }); });
        });
        if (flattenedData.length === 0) { const noDetModal = document.createElement('div'); noDetModal.innerHTML = `<div class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-[2000]"><div class="bg-white rounded-lg shadow-xl p-6"><h3 class="text-lg font-medium">Sin Detalles</h3><p class="mt-2">No hay detalles para exportar.</p><button onclick="this.closest('.fixed').remove()" class="mt-4 px-3 py-1 bg-blue-500 text-white rounded">OK</button></div></div>`; document.body.appendChild(noDetModal); return; }
        const colOrd = ['Codigo', 'Nombre Trabajador', 'Unidades Turno', 'Puesto', 'Inicio Puesto', 'Fin Puesto', 'Cantidad Puesto', 'Cajas/Hora', 'Confeccion'];
        const ws = XLSX.utils.json_to_sheet(flattenedData.map(r => Object.fromEntries(colOrd.map(c => [c, r[c] ?? '']))), { header: colOrd });
        ws["!cols"] = colOrd.map(k => ({ wch: flattenedData.reduce((w, r) => Math.max(w, (r[k]?.toString() ?? '').length), k.length) + 2 }));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "TrabajadoresDetalle");
        if(dateRangeSelect && filterPostsCheckbox) { XLSX.writeFile(wb, `Informe_Trabajadores_${dateRangeSelect.options[dateRangeSelect.selectedIndex].text.replace(/ /g, '_')}${filterPostsCheckbox.checked ? '_ConPuestos' : ''}.xlsx`);}
        else { XLSX.writeFile(wb, `Informe_Trabajadores.xlsx`); }
    }

    function printTable() { window.print(); }

    function fetchData(fromDate, toDate) {
        const apiUrl = `${apiBaseUrl}?from_date=${fromDate}&to_date=${toDate}`;
        if(loadingRow) loadingRow.classList.remove('hidden'); if(errorRow) errorRow.classList.add('hidden'); if(noDataRow) noDataRow.classList.add('hidden');
        if(tableBody) tableBody.querySelectorAll('tr:not(#loadingRow):not(#errorRow):not(#noDataRow)').forEach(r=>r.remove());
        if(exportExcelBtn)exportExcelBtn.disabled=true; updateHeaderButtonsState();
        if(liveUpdateIntervalId)clearInterval(liveUpdateIntervalId);liveUpdateIntervalId=null;
        fetch(apiUrl)
            .then(r=>r.ok?r.json():r.text().then(t=>{throw new Error(`Error HTTP ${r.status}: ${t}`);}))
            .then(apiR=>{if(loadingRow)loadingRow.classList.add('hidden');
                if(apiR.success&&Array.isArray(apiR.data)){originalWorkersData=apiR.data.sort((a,b)=>{const fFP=(w)=>{if(!w.operator_posts||w.operator_posts.length===0)return null;const aP=w.operator_posts.filter(p=>(p.count??0)>0&&p.created_at).map(p=>({...p,cAD:new Date(p.created_at)})).filter(p=>!isNaN(p.cAD.getTime()));if(aP.length===0)return null;aP.sort((p1,p2)=>p1.cAD-p2.cAD);return aP[0];};const fPA=fFP(a),fPB=fFP(b);const pNA=fPA?.rfid_reading?.name??null,pNB=fPB?.rfid_reading?.name??null;if(pNA&&pNB){const nC=pNA.localeCompare(pNB,undefined,{numeric:true,sensitivity:'base'});if(nC!==0)return nC;return(a.name??'').localeCompare(b.name??'');}else if(pNA)return -1;else if(pNB)return 1;else return(a.name??'').localeCompare(b.name??'');});populateTable(originalWorkersData);}
                else if(apiR.success&&(!Array.isArray(apiR.data)||apiR.data.length===0)){originalWorkersData=[];populateTable(originalWorkersData);}
                else{originalWorkersData=[];populateTable([]);throw new Error(apiR.message||"Error en API.");}
            })
            .catch(e=>{console.error("Error en fetch:",e);if(loadingRow)loadingRow.classList.add('hidden');if(errorCell)errorCell.textContent=`Error: ${e.message}`;if(errorRow)errorRow.classList.remove('hidden');if(totalUnidadesTurnoHeader)totalUnidadesTurnoHeader.textContent='(Error)';updateHeaderButtonsState();});
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        tableBody = document.getElementById('workersTableBody');
        loadingRow = document.getElementById('loadingRow');
        errorRow = document.getElementById('errorRow');
        errorCell = errorRow.querySelector('td');
        noDataRow = document.getElementById('noDataRow');
        exportExcelBtn = document.getElementById('exportExcelBtn');
        printBtn = document.getElementById('printBtn');
        dateRangeSelect = document.getElementById('dateRangeSelect');
        customDateRangeContainer = document.getElementById('customDateRangeContainer');
        customDateFrom = document.getElementById('customDateFrom');
        customDateTo = document.getElementById('customDateTo');
        applyCustomDateBtn = document.getElementById('applyCustomDateBtn');
        filterPostsCheckbox = document.getElementById('filterPostsCheckbox');
        analizarTodosLocalAIBtn = document.getElementById('analizarTodosLocalAIBtn');
        viewWorkerChartBtn = document.getElementById('viewWorkerChartBtn');
        viewWorkerCHChartBtn = document.getElementById('viewWorkerCHChartBtn');
        viewPostChartBtn = document.getElementById('viewPostChartBtn');
        viewPostCHChartBtn = document.getElementById('viewPostCHChartBtn');
        viewWorkerPieChartBtn = document.getElementById('viewWorkerPieChartBtn');
        viewWorkerCHPieChartBtn = document.getElementById('viewWorkerCHPieChartBtn');
        viewConfeccionPorTrabajadorChartBtn = document.getElementById('viewConfeccionPorTrabajadorChartBtn');
        viewWorkerEvolutionBtn = document.getElementById('viewWorkerEvolutionBtn');
        viewWorkerEvolutionCHBtn = document.getElementById('viewWorkerEvolutionCHBtn');
        viewDistributionBtn = document.getElementById('viewDistributionBtn');
        viewRankingBtn = document.getElementById('viewRankingBtn');
        viewRankingCHBtn = document.getElementById('viewRankingCHBtn');
        viewFullRankingBtn = document.getElementById('viewFullRankingBtn');
        viewFullRankingCHBtn = document.getElementById('viewFullRankingCHBtn');
        viewInsightsBtn = document.getElementById('viewInsightsBtn');
        viewTemporalComparisonBtn = document.getElementById('viewTemporalComparisonBtn');
        viewHeatmapBtn = document.getElementById('viewHeatmapBtn');
        totalUnidadesTurnoHeader = document.getElementById('totalUnidadesTurnoHeader');
        searchInput = document.getElementById('searchInput');
        lockButton = document.getElementById('lockButton');
        lockIcon = document.getElementById('lockIcon');
        unlockIcon = document.getElementById('unlockIcon');
        passwordModal = document.getElementById('passwordModal');
        passwordInput = document.getElementById('passwordInput');
        passwordError = document.getElementById('passwordError');
        cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        submitPasswordBtn = document.getElementById('submitPasswordBtn');
        editQuantityModal = document.getElementById('editQuantityModal');
        editQuantityInput = document.getElementById('editQuantityInput');
        editQuantityError = document.getElementById('editQuantityError');
        editApiStatus = document.getElementById('editApiStatus');
        cancelEditBtn = document.getElementById('cancelEditBtn');
        saveEditBtn = document.getElementById('saveEditBtn');
        analysisModal = document.getElementById('analysisModal');
        analysisModalTitle = document.getElementById('analysisModalTitle');
        analysisModalContent = document.getElementById('analysisModalContent');
        analysisModalStatus = document.getElementById('analysisModalStatus');
        closeAnalysisModalBtn = document.getElementById('closeAnalysisModalBtn');
        okAnalysisModalBtn = document.getElementById('okAnalysisModalBtn');
        promptEditModal = document.getElementById('promptEditModal');
        promptTextArea = document.getElementById('promptTextArea');
        promptDataSummary = document.getElementById('promptDataSummary');
        closePromptEditModalBtn = document.getElementById('closePromptEditModalBtn');
        cancelPromptEditBtn = document.getElementById('cancelPromptEditBtn');
        sendPromptBtn = document.getElementById('sendPromptBtn');
        chartModal = document.getElementById('chartModal');
        chartModalTitleEl = document.getElementById('chartModalTitle');
        chartContainerEl = document.getElementById('chartContainer');
        tooltip = d3.select('#tooltip');
        kpiCardContainer = document.getElementById('kpiCardContainer');
        kpiTotalCajas = document.getElementById('kpiTotalCajas');
        kpiTrabajadoresActivos = document.getElementById('kpiTrabajadoresActivos');
        kpiAvgCajasHora = document.getElementById('kpiAvgCajasHora');
        kpiPuestoMasProductivo = document.getElementById('kpiPuestoMasProductivo');
        kpiEficienciaGlobal = document.getElementById('kpiEficienciaGlobal');
        kpiTiempoPromedio = document.getElementById('kpiTiempoPromedio');
        toggleFullscreenChartBtn = document.getElementById('toggleFullscreenChartBtn');
        expandIcon = document.getElementById('expandIcon');
        contractIcon = document.getElementById('contractIcon');
        countdownModal = document.getElementById('countdownModal');
        countdownNumber = document.getElementById('countdownNumber');
        extendSessionBtn = document.getElementById('extendSessionBtn');
        sessionIndicator = document.getElementById('sessionIndicator');
        sessionTime = document.getElementById('sessionTime');

        if (exportExcelBtn) {
            if (typeof exportToExcel === 'function') { exportExcelBtn.addEventListener('click', exportToExcel); }
            else { console.error('ERROR: exportToExcel no es una funci√≥n al adjuntar listener.'); }
        }
        if (printBtn) {
            if (typeof printTable === 'function') { printBtn.addEventListener('click', printTable); }
            else { console.error('ERROR: printTable no es una funci√≥n al adjuntar listener.'); }
        }
        if (analizarTodosLocalAIBtn) analizarTodosLocalAIBtn.addEventListener('click', fetchLocalAIOverallAnalysis);
        if (viewWorkerChartBtn) viewWorkerChartBtn.addEventListener('click', () => showChartModal('workers'));
        if (viewWorkerCHChartBtn) viewWorkerCHChartBtn.addEventListener('click', () => showChartModal('workersCH'));
        if (viewPostChartBtn) viewPostChartBtn.addEventListener('click', () => showChartModal('postsBar'));
        if (viewPostCHChartBtn) viewPostCHChartBtn.addEventListener('click', () => showChartModal('postsCHBar'));
        if (viewWorkerPieChartBtn) viewWorkerPieChartBtn.addEventListener('click', () => showChartModal('workerPie'));
        if (viewWorkerCHPieChartBtn) viewWorkerCHPieChartBtn.addEventListener('click', () => showChartModal('workerCHPie'));
        if (viewConfeccionPorTrabajadorChartBtn) viewConfeccionPorTrabajadorChartBtn.addEventListener('click', () => showChartModal('confeccionPorTrabajador'));
        if (viewWorkerEvolutionBtn) viewWorkerEvolutionBtn.addEventListener('click', () => showChartModal('workerEvolution'));
        if (viewWorkerEvolutionCHBtn) viewWorkerEvolutionCHBtn.addEventListener('click', () => showChartModal('workerEvolutionCH'));
        if (viewDistributionBtn) viewDistributionBtn.addEventListener('click', () => showChartModal('distribution'));
        if (viewRankingBtn) viewRankingBtn.addEventListener('click', () => showChartModal('ranking'));
        if (viewRankingCHBtn) viewRankingCHBtn.addEventListener('click', () => showChartModal('rankingCH'));
        if (viewFullRankingBtn) viewFullRankingBtn.addEventListener('click', () => showChartModal('fullRanking'));
        if (viewFullRankingCHBtn) viewFullRankingCHBtn.addEventListener('click', () => showChartModal('fullRankingCH'));
        if (viewInsightsBtn) viewInsightsBtn.addEventListener('click', () => showChartModal('insights'));
        if (viewTemporalComparisonBtn) viewTemporalComparisonBtn.addEventListener('click', () => showChartModal('temporalComparison'));
        if (viewHeatmapBtn) viewHeatmapBtn.addEventListener('click', () => showChartModal('heatmap'));
        
        if (dateRangeSelect) dateRangeSelect.addEventListener('change', (e) => { 
            const selectedValue = e.target.value;
            if (selectedValue === 'custom') {
                // Mostrar los inputs de fecha personalizada
                if (customDateRangeContainer) customDateRangeContainer.classList.remove('hidden');
                // Establecer fecha por defecto (hoy)
                const today = new Date();
                if (customDateFrom) customDateFrom.valueAsDate = today;
                if (customDateTo) customDateTo.valueAsDate = today;
            } else {
                // Ocultar los inputs de fecha personalizada
                if (customDateRangeContainer) customDateRangeContainer.classList.add('hidden');
                // Cargar datos con la opci√≥n predeterminada seleccionada
                const {from, to} = getDateRange(selectedValue);
                fetchData(from, to);
            }
        });
        if (filterPostsCheckbox) filterPostsCheckbox.addEventListener('change', () => { populateTable(originalWorkersData); updateKPICards(); updateHeaderButtonsState(); });
        if (searchInput) searchInput.addEventListener('input', () => { populateTable(originalWorkersData); updateKPICards(); updateHeaderButtonsState(); });
        if (cancelPasswordBtn) cancelPasswordBtn.addEventListener('click', hidePasswordModal);
        if (submitPasswordBtn) submitPasswordBtn.addEventListener('click', () => { 
            if (passwordInput.value === PASSWORD_HASH) { 
                hidePasswordModal(); 
                toggleLockState(false);
                if(passwordError) passwordError.classList.add('hidden');
            } else { 
                if(passwordError) {
                    passwordError.textContent = 'Contrase√±a incorrecta.';
                    passwordError.classList.remove('hidden');
                }
                if(passwordInput) passwordInput.select(); 
            } 
        });
        if (passwordInput) passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && submitPasswordBtn) submitPasswordBtn.click(); });
        if (cancelEditBtn) cancelEditBtn.addEventListener('click', hideEditQuantityModal);
        if (saveEditBtn) saveEditBtn.addEventListener('click', handleSaveEdit);
        if (editQuantityInput) editQuantityInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && saveEditBtn) saveEditBtn.click(); });
        if (closeAnalysisModalBtn) closeAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
        if (okAnalysisModalBtn) okAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
        if (closePromptEditModalBtn) closePromptEditModalBtn.addEventListener('click', hidePromptEditModal);
        if (cancelPromptEditBtn) cancelPromptEditBtn.addEventListener('click', hidePromptEditModal);
        if (sendPromptBtn) sendPromptBtn.addEventListener('click', sendEditedPrompt);
        
        const localCloseChartModalBtn = document.getElementById('closeChartModalBtn');
        const localOkChartModalBtn = document.getElementById('okChartModalBtn');
        if(chartModal && localCloseChartModalBtn) localCloseChartModalBtn.addEventListener('click', hideChartModal);
        if(chartModal && localOkChartModalBtn) localOkChartModalBtn.addEventListener('click', hideChartModal);
        if(toggleFullscreenChartBtn) toggleFullscreenChartBtn.addEventListener('click', toggleChartFullscreen);

        if (lockButton) lockButton.addEventListener('click', () => { if (isLocked) showPasswordModal(); else toggleLockState(true); });
        
        // Event listener para aplicar fechas personalizadas
        if (applyCustomDateBtn) applyCustomDateBtn.addEventListener('click', () => {
            if (!customDateFrom || !customDateFrom.value) {
                alert('Por favor, selecciona una fecha de inicio');
                return;
            }
            const {from, to} = getDateRange('custom');
            fetchData(from, to);
        });
        
        // Event listener para cambios en los inputs de fecha (Enter para aplicar)
        if (customDateFrom) customDateFrom.addEventListener('keypress', (e) => { if (e.key === 'Enter' && applyCustomDateBtn) applyCustomDateBtn.click(); });
        if (customDateTo) customDateTo.addEventListener('keypress', (e) => { if (e.key === 'Enter' && applyCustomDateBtn) applyCustomDateBtn.click(); });
        
        // Event listeners para el sistema de sesi√≥n
        if (extendSessionBtn) extendSessionBtn.addEventListener('click', extendSession);
        
        // Configurar listeners de actividad
        setupActivityListeners();
        
        // Verificar sesi√≥n guardada al cargar
        if (loadSession()) {
            toggleLockState(false);
            console.log('Sesi√≥n restaurada desde cach√©');
        }

        const {from, to} = getDateRange(dateRangeSelect.value);
        fetchData(from, to);
        toggleLockState(isLocked); 
    });
</script>

</body>
</html>
