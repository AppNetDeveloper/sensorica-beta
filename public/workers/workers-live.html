<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti칩n de Producci칩n - Tarjetas</title>
  <!-- Hoja de estilos SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <!-- Font Awesome para 칤conos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Script SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Script SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Eliminamos el fondo negro */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #f6f7f8;
      color: white;
      padding: 10px 20px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .header-left img {
      height: 50px;
      width: auto;
    }
    .header-left .icon {
      font-size: 1.5rem;
      cursor: pointer;
      color: #28a745;
      transition: color 0.3s ease;
    }
    .header-left .icon:hover {
      color: #218838;
    }
    .header-right {
      font-size: 1.2rem;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }
    .header-right small {
      font-size: 0.9rem;
      color: #ffc107;
    }
    .content {
      padding: 8px; /* Reducir el padding */
      max-width: 100%; /* Para que ocupe todo el ancho */
      margin: 0;       /* Quitar auto-centramiento */
      padding-bottom: 80px; /* Ajusta este valor al alto de tu footer */
    }

    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }
    .card {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      width: calc(100% / 6 - 10px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.3s;
    }
    @media (max-width: 1800px) {
      .card {
        width: calc(100% / 5 - 10px);
      }
    }
    @media (max-width: 1500px) {
      .card {
        width: calc(100% / 4 - 10px);
      }
    }
    @media (max-width: 1200px) {
      .card {
        width: calc(100% / 3 - 10px);
      }
    }
    @media (max-width: 768px) {
      .card {
        width: calc(100% / 2 - 10px);
      }
    }
    @media (max-width: 480px) {
      .card {
        width: calc(100% / 1 - 10px);
      }
    }
    .card:hover {
      transform: scale(1.05);
    }
    .card h3 {
      margin: 0;
      font-size: var(--nameSize, 1rem);
      color: #343a40;
    }
    .card .stats-container {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }
    .card .stat {
      text-align: center;
      flex: 1;
    }
    .card .stat span {
      display: block;
      font-size: var(--labelSize, 0.9rem);
      color: #555;
    }
    .card .stat .value {
      font-size: var(--numberSize, 1.8rem);
      font-weight: bold;
    }
    .rfid-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    .rfid-item {
      font-size: 1rem;
      font-weight: bold;
      background: rgba(0, 0, 0, 0.1);
      padding: 5px 10px;
      border-radius: 5px;
    }
    /* Si deseas el footer (franja inferior), lo mantienes o eliminas seg칰n prefieras */
    .footer-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #e2c100;
        color: #000;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between; /* icono a la izquierda y logo a la derecha */
        align-items: center;
    }
    .footer-bar img {
        height: 30px; /* Ajusta el tama침o seg칰n tus necesidades */
        margin-right: 30px;
        margin-left: 30px;
    }
    .floating-logo {
      position: fixed;
      bottom: 40px;  /* Distancia desde la parte inferior */
      right: 20px;   /* Distancia desde la parte derecha */
      z-index: 9999; /* Asegura que est칠 por encima del contenido */
    }
    .floating-logo img {
      height: 50px;  /* Ajusta el tama침o a tu gusto */
      /* A침ade margen, sombra, borde, etc., si deseas un estilo especial */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2); /* sombra */
    }

  </style>
</head>
<body>
    <div class="screen-container">


        <!-- Content -->
        <div class="content">
            <div class="card-container" id="cardContainer">
                <!-- Las tarjetas se llenar치n din치micamente aqu칤 -->
            </div>
        </div>

        <!-- Logo flotante -->
        <div class="floating-logo">
          <img src="logo-float.png" alt="autoconto logo">
        </div>
        <!-- Barra de herramientas -->

        <!-- Footer / franja inferior -->
        <footer class="footer-bar">
            <i class="fa fa-file-excel icon" id="exportExcel" title="Exportar a Excel"></i>
           <!--  <img src="logo.png" alt="autoconto logo"> -->
        </footer>
    </div>

    <script>
        const workersApiUrl = '/api/workers';
    
        // 游늷 Variable global para almacenar los colores RFID
        let rfidColorsGlobal = [];
    
        // 游늷 Obtener par치metros de la URL con valores predeterminados
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                shift: params.get('shift') === 'true',
                order: params.get('order') === 'true',
                name: params.get('name') === 'true',
                id: params.get('id') === 'true',
                nameSize: params.get('nameSize') || '1rem',
                numberSize: params.get('numberSize') || '1.8rem',
                idSize: params.get('idSize') || '1rem',
                labelSize: params.get('labelSize') || '0.9rem',
            };
        }
    
        const config = getUrlParams();
    
        // Aplicar estilos din치micos a la p치gina
        document.documentElement.style.setProperty('--nameSize', config.nameSize);
        document.documentElement.style.setProperty('--numberSize', config.numberSize);
        document.documentElement.style.setProperty('--labelSize', config.labelSize);
    

    
        // 游늷 Variable global para almacenar los operadores
        let operatorsData = [];

        // 游늷 Funci칩n para cargar operadores y colores RFID desde la API
        function loadOperators() {
            $.ajax({
                url: `${workersApiUrl}/list-all`,
                method: 'GET',
                success: function (response) {
                    const operators = response.operators; 
                    rfidColorsGlobal = response.rfid_colors || []; // 游늷 Guardamos los colores RFID globalmente

                    operatorsData = operators; 

                    const container = $('#cardContainer');
                    container.empty();

                    if (!operators || operators.length === 0) {
                        container.append('<p>No hay operadores disponibles.</p>');
                        return;
                    }

                    const maxTurn = Math.max(...operators.map(o => o.count_shift || 0));
                    const maxOrder = Math.max(...operators.map(o => o.count_order || 0));

                    operators.forEach(operator => {
                        const turnValue = operator.count_shift || 0;
                        const orderValue = operator.count_order || 0;

                        const turnClass = turnValue === 0 ? 'black' : turnValue === maxTurn ? 'black' : 'black';
                        const orderClass = orderValue === 0 ? 'black' : orderValue === maxOrder ? 'black' : 'black';

                        // 游늷 Creamos un objeto para almacenar los productos por color RFID
                        let rfidHtml = '';
                        let rfidProducts = {};

                        operator.operator_posts.forEach(post => {
                            const colorName = post.rfid_color_name; // El color RFID
                            const productName = post.product_list_name; // El nombre del producto
                            const count = post.count; // El valor de count

                            if (!rfidProducts[colorName]) {
                                rfidProducts[colorName] = [];
                            }
                            rfidProducts[colorName].push({
                                productName: productName,
                                count: count,
                            });
                        });

                        // Generar el HTML para los productos de cada color RFID
                        if (rfidColorsGlobal.length > 0) {
                            // Dentro de tu bucle donde construyes la tarjeta, 
                            // genera rfidHtml de esta forma:
                            rfidHtml = `
                              <div class="rfid-container" style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
                                ${rfidColorsGlobal.map(color => {
                                  const products = rfidProducts[color.name] || [];
                                  
                                  // Para cada producto, generamos un "cuadro" con la franja de color y el n칰mero
                                  const colorHtml = products.map(product => {
                                    // Verifica si el nombre del producto no es nulo/vac칤o
                                    if (product.productName && product.productName.trim() !== "") {
                                      // Trunca el nombre si excede 10 caracteres
                                      const truncatedName = product.productName.length > 10 
                                        ? product.productName.substring(0, 10) + '...' 
                                        : product.productName;

                                      return `
                                        <div style="
                                          background: #fff;
                                          border: 1px solid #ddd;
                                          border-radius: 5px;
                                          width: 80px;
                                          text-align: center;
                                          padding: 10px;
                                        ">
                                          <!-- Contenedor para la franja de color y el n칰mero -->
                                          <div style="display: flex; align-items: center;">
                                            <!-- Franja vertical de color -->
                                            <div style="
                                              width: 5px;
                                              height: 40px;
                                              background-color: ${color.name};
                                              margin-right: 8px;
                                            "></div>
                                            <!-- N칰mero grande -->
                                            <div style="font-size: 1.8rem; font-weight: bold; color: #333;">
                                              ${product.count}
                                            </div>
                                          </div>
                                          <!-- Nombre debajo -->
                                          <div style="margin-top: 5px; font-size: 0.9rem; color: #555;">
                                            ${truncatedName}
                                          </div>
                                        </div>
                                      `;
                                    } 
                                    // Si no hay nombre, no retorna nada
                                    return '';
                                  }).join('');

                                  return colorHtml;
                                }).join('')}
                              </div>
                            `;
                        }

                        // Construir la tarjeta
                        // Primero, calcula los porcentajes para la barra apilada:
                        let total = turnValue + orderValue;
                        let turnPerc, orderPerc;
                        if (total === 0) {
                          // Si ambos son 0, forzamos un 50/50 en el relleno
                          turnPerc = 50;
                          orderPerc = 50;
                        } else {
                          turnPerc = ((turnValue / total) * 100).toFixed(0);
                          orderPerc = ((orderValue / total) * 100).toFixed(0);
                        }

                        // Construir la barra apilada:
                        const stackedBar = `
                          <div style="
                            display: flex;
                            margin: 10px 0;
                            border-radius: 5px;
                            overflow: hidden;
                            height: 40px;
                            box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
                          ">
                            <!-- Secci칩n para turnValue -->
                            <div style="
                              flex: 0 0 ${turnPerc}%;
                              background-color: #f0b41f;
                              display: flex;
                              justify-content: center;
                              align-items: center;
                              color: #343a40;
                              font-weight: bold;
                            ">
                              ${turnValue}
                            </div>
                            <!-- Secci칩n para orderValue -->
                            <div style="
                              flex: 0 0 ${orderPerc}%;
                              background-color: #ffe680;
                              display: flex;
                              justify-content: center;
                              align-items: center;
                              color: #343a40;
                              font-weight: bold;
                            ">
                              ${orderValue}
                            </div>
                          </div>
                        `;

                        // Construir la tarjeta completa:
                        const card = `
                          <div class="card" style="padding: 0; border-radius: 8px; overflow: hidden;">
                            <!-- Encabezado (Header) que ocupa todo el ancho -->
                            <div style="
                              background-color: #faf7f7;
                              color: #ffffff;
                              padding: 10px;
                              width: 100%;
                              box-sizing: border-box;
                              border-top-left-radius: 8px;
                              border-top-right-radius: 8px;
                            ">
                              ${config.name ? `
                                <h3 style="
                                  margin: 0;
                                  display: flex;
                                  justify-content: space-between;
                                  align-items: center;
                                  color: black;
                                ">
                                  <span>${operator.name.length > 10 ? operator.name.substring(0, 10) + '...' : operator.name}</span>
                                  <span>${operator.id}</span>
                                </h3>
                              ` : ''}
                            </div>

                            <!-- Cuerpo (Body) de la tarjeta -->
                            <div style="padding: 15px;">
                              ${config.id ? `
                                <p style="font-size: ${config.idSize}; margin: 0 0 10px;">
                                  <span>Tiempo Medio / UDS:</span> 5:03
                                </p>
                              ` : ''}

                              <!-- Barra apilada con turnValue y orderValue -->
                              ${stackedBar}                              
                              <!-- Secci칩n RFID (si existe) -->
                              ${rfidHtml}
                            </div>
                          </div>
                        `;

                        container.append(card);
                    });
                },
                error: function (xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al cargar operadores',
                        text: `Status: ${xhr.status}. Mensaje: ${xhr.responseJSON?.error || 'Error desconocido'}`,
                    });
                },
            });
        }

        // 游늷 Funci칩n para exportar datos a Excel
        function exportToExcel() {
            if (operatorsData.length === 0) {
                Swal.fire('Error', 'No hay datos para exportar.', 'error');
                return;
            }
            const rfidColorNames = rfidColorsGlobal.map(color => color.name);
            const rows = operatorsData.map(operator => {
                let row = {
                    ...(config.name && { Nombre: operator.name }),
                    ...(config.id && { ID: operator.id }),
                    ...(config.shift && { Turno: operator.count_shift || 0 }),
                    ...(config.order && { Orden: operator.count_order || 0 }),
                };
                rfidColorNames.forEach(color => {
                    row[color] = 0;
                });
                return row;
            });
            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Operadores');
            XLSX.writeFile(workbook, 'operadores.xlsx');
        }
    
        // 游늷 Inicializar la carga de operadores y la exportaci칩n a Excel
        $(document).ready(function () {
            loadOperators();
            setInterval(loadOperators, 5000);
            $('#exportExcel').click(exportToExcel);
        });
    </script>
</body>
</html>
