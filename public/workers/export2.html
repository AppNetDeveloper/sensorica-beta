<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tabla Trabajadores Ordenada por Primer Puesto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { padding: 0; }
            .container { box-shadow: none; margin: 0; max-width: 100%; }
            .modal { display: none !important; }
            .kpi-card-container, #searchInputContainer { display: none !important; }
        }
        .live-cajas-hora {}
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: flex;
            justify-content: center; align-items: center; z-index: 1000; padding: 1rem;
            transition: all 0.3s ease-in-out;
        }
        .modal-content {
            background-color: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); width: 100%; max-width: 600px;
            display: flex; flex-direction: column;
            transition: all 0.3s ease-in-out;
        }
        #chartModal .modal-content {
            max-width: 850px; /* Ancho normal */
            height: auto;
            max-height: 90vh; /* Alto normal */
        }

        /* Estilos para modal maximizado */
        .modal.modal-fullscreen { padding: 0; }
        .modal.modal-fullscreen .modal-content {
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            margin: 0;
            border-radius: 0;
            padding: 0; 
            display: flex;
            flex-direction: column;
        }
        .modal.modal-fullscreen .modal-header {
            padding: 1rem; 
            flex-shrink: 0; 
        }
        .modal.modal-fullscreen .chart-container {
            width: 100% !important; 
            flex-grow: 1; 
            padding: 1rem; 
            box-sizing: border-box; 
            display: block; 
            overflow-x: auto !important; 
            overflow-y: hidden; 
        }
         .modal.modal-fullscreen .chart-container svg {
            margin-left: 0;
            margin-right: 0;
        }
        .modal.modal-fullscreen .modal-footer {
            padding: 1rem; 
            flex-shrink: 0; 
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-header h3 { margin: 0; }
        .modal-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: right;}


        .edit-icon, .analyze-icon, .fullscreen-icon {
            cursor: pointer; margin-left: 8px; color: #3b82f6;
            display: inline-flex; align-items: center;
        }
        .edit-icon:hover, .analyze-icon:hover, .fullscreen-icon:hover { color: #2563eb; }
        .hidden { display: none; }
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px;
            border-radius: 50%; border-left-color: #09f;
            animation: spin 1s ease infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .chart-container { width: 100%; height: 450px; overflow-x: auto; flex-shrink: 0; }
        .chart-container svg { display: block; margin: auto; }
        .bar { fill: steelblue; }
        .bar:hover { fill: #2563eb; }
        .axis-label { font-size: 0.8rem; }
        .tooltip {
            position: absolute; text-align: center; padding: 6px; font: 12px sans-serif;
            background: lightsteelblue; border: 0px; border-radius: 8px;
            pointer-events: none; opacity: 0; z-index: 1010;
        }
        .pie-slice-label { /* Estilo para etiquetas del grÃ¡fico circular */
            font-size: 9px;
            fill: #333; /* Cambiado a color oscuro para etiquetas externas */
        }
        .btn-ia-local { background-color: #4f46e5; }
        .btn-ia-local:hover { background-color: #4338ca; }
        .kpi-card {
            background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem;
            padding: 1rem; text-align: center;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }
        .kpi-title { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.25rem; }
        .kpi-value { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .legend-item { display: flex; align-items: center; margin-right: 15px; font-size: 0.8rem; }
        .legend-color { width: 12px; height: 12px; margin-right: 5px; border: 1px solid #ccc; }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

<div class="container mx-auto bg-white rounded-lg shadow-md overflow-hidden">
    <div class="p-4 md:p-6 border-b border-gray-200">
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
             <div class="flex items-center gap-3">
                 <h1 class="text-2xl font-bold text-gray-700">Listado de Trabajadores</h1>
                 <div id="lockButton" class="no-print cursor-pointer text-gray-600 hover:text-blue-600 transition-colors">
                     <svg id="lockIcon" class="icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6zm-1.5-1a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v1a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-1z" clip-rule="evenodd" /></svg>
                     <svg id="unlockIcon" class="icon hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h1.5a.5.5 0 00.5-.5V8a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5v.5a.5.5 0 00.5.5H9v1h4z" clip-rule="evenodd" /><path d="M9 5.5a3 3 0 00-3 3V9h1.5a.5.5 0 01.5.5v1a.5.5 0 01-.5.5H5v.5a3 3 0 003 3h.5a.5.5 0 00.5-.5V12a.5.5 0 00-.5-.5H8a.5.5 0 00-.5.5v.5a.5.5 0 00.5.5h.5a1.5 1.5 0 001.5-1.5v-.5a.5.5 0 00-.5-.5H9V9h1V5.5z"/></svg>
                 </div>
            </div>
             <div class="flex flex-col sm:flex-row sm:items-center gap-4 no-print">
                 <div class="flex items-center space-x-2">
                     <label for="dateRangeSelect" class="text-sm font-medium text-gray-700">Periodo:</label>
                     <select id="dateRangeSelect" name="dateRange" class="block w-full sm:w-auto pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm">
                         <option value="today" selected>Hoy</option>
                         <option value="yesterday">Ayer</option>
                         <option value="day_minus_2">Hace 2 dÃ­as</option>
                         <option value="day_minus_3">Hace 3 dÃ­as</option>
                         <option value="day_minus_4">Hace 4 dÃ­as</option>
                         <option value="day_minus_5">Hace 5 dÃ­as</option>
                         <option value="day_minus_6">Hace 6 dÃ­as</option>
                         <option value="day_minus_7">Hace 7 dÃ­as</option>
                         <option value="last7days">Ãšltimos 7 dÃ­as (rango)</option>
                         <option value="last30days">Ãšltimos 30 dÃ­as (rango)</option>
                     </select>
                 </div>
                  <div class="flex items-center">
                     <input id="filterPostsCheckbox" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" checked>
                     <label for="filterPostsCheckbox" class="ml-2 block text-sm text-gray-900">Solo operarios con asignaciones</label>
                   </div>
             </div>
        </div>
         <div class="flex flex-wrap justify-end items-center space-x-2 no-print mb-4">
            <button id="viewWorkerChartBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out hidden">ðŸ“Š Cajas/Trabajador</button>
            <button id="viewPostChartBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out hidden">ðŸ“Š Cajas/Puesto (Barras)</button>
            <button id="viewWorkerPieChartBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out hidden">ðŸ“Š Cajas/Empleado (Circular)</button>
            <button id="viewConfeccionPorTrabajadorChartBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out hidden">ðŸ“Š ConfecciÃ³n/Trabajador</button>
            <button id="analizarTodosLocalAIBtn" class="btn-ia-local text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out hidden">
                <svg class="icon mr-2 inline-block" style="width:18px; height:18px;" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 15c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm0-10c-2.06 0-3.82 1.22-4.58 3h9.16c-.76-1.78-2.52-3-4.58-3z"/></svg>
                Analizar Todos (IA)
            </button>
            <button id="exportExcelBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">Exportar a Excel</button>
            <button id="printBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition-colors duration-150 ease-in-out">Imprimir</button>
        </div>
    </div>

    <div id="kpiCardContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4 md:p-6 no-print">
        <div class="kpi-card"><div class="kpi-title">Total Cajas Producidas</div><div id="kpiTotalCajas" class="kpi-value">-</div></div>
        <div class="kpi-card"><div class="kpi-title">Trabajadores Activos</div><div id="kpiTrabajadoresActivos" class="kpi-value">-</div></div>
        <div class="kpi-card"><div class="kpi-title">Promedio Cajas/Hora Global</div><div id="kpiAvgCajasHora" class="kpi-value">-</div></div>
        <div class="kpi-card">
            <div class="kpi-title">Operario MÃ¡s Productivo</div>
            <div id="kpiPuestoMasProductivo" class="kpi-value">-</div> </div>
    </div>

    <div id="searchInputContainer" class="p-4 md:px-6 no-print">
        <input type="text" id="searchInput" placeholder="Buscar en tabla (Nombre, CÃ³digo, Puesto, ConfecciÃ³n)..." class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" autocomplete="off">
    </div>

    <div class="overflow-x-auto p-4 md:p-6">
        <table id="workersTable" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Codigo</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unidades (Turno) <span id="totalUnidadesTurnoHeader" class="font-bold"></span></th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puesto</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inicio Puesto</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fin Puesto</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cajas/Hora</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confeccion</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="workersTableBody">
                <tr id="loadingRow"><td colspan="9" class="px-4 py-4 text-center text-gray-500">Cargando datos...</td></tr>
                <tr id="errorRow" class="hidden"><td colspan="9" class="px-4 py-4 text-center text-red-500"></td></tr>
                <tr id="noDataRow" class="hidden"><td colspan="9" class="px-4 py-4 text-center text-gray-500">No se encontraron datos.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="passwordModal" class="modal hidden no-print">
    <div class="modal-content">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Introducir ContraseÃ±a</h3>
        <div>
            <input type="password" id="passwordInput" class="block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 mb-2" placeholder="ContraseÃ±a" autocomplete="new-password">
            <p id="passwordError" class="text-red-500 text-sm mb-4 hidden">ContraseÃ±a incorrecta.</p>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button type="button" id="cancelPasswordBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 rounded-md shadow-sm">Cancelar</button>
            <button type="button" id="submitPasswordBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-md shadow-sm">Desbloquear</button>
        </div>
    </div>
</div>

<div id="editQuantityModal" class="modal hidden no-print">
    <div class="modal-content">
        <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Editar Cantidad</h3>
        <div>
            <label for="editQuantityInput" class="block text-sm font-medium text-gray-700">Nueva cantidad:</label>
            <input type="number" id="editQuantityInput" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md p-2 mb-2" placeholder="Cantidad" autocomplete="off">
            <p id="editQuantityError" class="text-red-500 text-sm mb-4 hidden">Valor invÃ¡lido.</p>
            <p id="editApiStatus" class="text-sm mt-2"></p>
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button type="button" id="cancelEditBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 rounded-md shadow-sm">Cancelar</button>
            <button type="button" id="saveEditBtn" class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 border border-transparent rounded-md shadow-sm">Guardar</button>
        </div>
    </div>
</div>

<div id="analysisModal" class="modal hidden no-print">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="analysisModalTitle" class="text-lg font-medium leading-6 text-gray-900">AnÃ¡lisis de Rendimiento</h3>
            <button type="button" id="closeAnalysisModalBtn" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="analysisModalContent" class="text-sm text-gray-700 whitespace-pre-wrap overflow-y-auto" style="max-height: calc(90vh - 100px); margin-top:1rem; margin-bottom:1rem;"></div>
        <div id="analysisModalStatus" class="mt-3 text-sm text-gray-500"></div>
        <div class="modal-footer">
            <button type="button" id="okAnalysisModalBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-md shadow-sm">OK</button>
        </div>
    </div>
</div>

<div id="chartModal" class="modal hidden no-print">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="chartModalTitle" class="text-lg font-medium leading-6 text-gray-900">ðŸ“Š GrÃ¡fico de ProducciÃ³n</h3>
            <div class="flex items-center">
                 <button type="button" id="toggleFullscreenChartBtn" class="text-gray-500 hover:text-gray-700 mr-2 fullscreen-icon" title="Pantalla Completa">
                    <svg id="expandIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg>
                    <svg id="contractIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19v-4m0 0h4M15 19l-5-5M5 9V5m0 0h4M5 5l5 5m0 0M9 5h4M5 9v4m0 0M19 9v4" /></svg>
                </button>
                <button type="button" id="closeChartModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </div>
        <div id="chartContainer" class="chart-container"></div>
        <div class="modal-footer">
            <button type="button" id="okChartModalBtn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 border border-transparent rounded-md shadow-sm">OK</button>
        </div>
    </div>
</div>
<div id="tooltip" class="tooltip"></div>

<script>
    // URLs de API para datos de trabajadores y ediciÃ³n
    const apiBaseUrl = '/api/workers/all-list/completed';
    const apiEditPostUrl = '/api/operator-post/update-count';

    // URLs y configuraciÃ³n para la IA Local
    const localAISubmitTaskUrl = 'https://app.appnet.dev/api/ollama-tasks';
    const localAITaskStatusUrlBase = 'https://app.appnet.dev/api/ollama-tasks/';
    const defaultLocalAIModelName = 'gemma3:4b-it-qat';
    const localAIApiToken = 'Bearer 5b3ce3597851110001cf6248ff7d660a725f48be464b74';
    const localAICallbackUrl = 'https://tudominio.com/webhook/ollama-callback';

    // ConfiguraciÃ³n para obtener prompts desde la API de Laravel
    const apiPromptBaseUrl = '/api/ia-prompts/';
    const promptApiKeys = {
        individual: 'individual_worker_analysis_v3',
        global: 'overall_team_analysis_v3'
    };

    const fallbackIndividualPrompt = "Analiza al trabajador: {{workerName}} con datos: {{postsDetails}}. Compara con: {{overallSummary}}";
    const fallbackGlobalPrompt = "Analiza el rendimiento global con estos datos: {{overallSummary}}";

    // Variables globales (declaraciones)
    let tableBody, loadingRow, errorRow, errorCell, noDataRow, exportExcelBtn, printBtn,
        dateRangeSelect, filterPostsCheckbox, analizarTodosLocalAIBtn,
        viewWorkerChartBtn, viewPostChartBtn, viewWorkerPieChartBtn, viewConfeccionPorTrabajadorChartBtn,
        totalUnidadesTurnoHeader,
        lockButton, lockIcon, unlockIcon, passwordModal, passwordInput, passwordError,
        cancelPasswordBtn, submitPasswordBtn, editQuantityModal, editQuantityInput,
        editQuantityError, editApiStatus, cancelEditBtn, saveEditBtn,
        analysisModal, analysisModalTitle, analysisModalContent, analysisModalStatus,
        closeAnalysisModalBtn, okAnalysisModalBtn,
        chartModal, chartModalTitleEl, chartContainerEl, toggleFullscreenChartBtn, expandIcon, contractIcon,
        tooltip,
        kpiCardContainer, kpiTotalCajas, kpiTrabajadoresActivos, kpiAvgCajasHora, kpiPuestoMasProductivo,
        searchInput;

    let originalWorkersData = [];
    let displayedPostRowsCount = 0;
    let liveUpdateIntervalId = null;
    let isLocked = true;
    let currentEditContext = null;
    let currentLocalAITaskId = null;
    let localAIPollingIntervalId = null;
    let currentChartType = null; 

    const dateTimeFormatOptions = { year: 'numeric', month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false };
    const dateFormatter = new Intl.DateTimeFormat(navigator.language || 'es-ES', dateTimeFormatOptions);

    // --- Definiciones de Funciones ---

    async function getPromptFromServer(promptApiKey) {
        try {
            const response = await fetch(`${apiPromptBaseUrl}${promptApiKey}`);
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`Error al obtener prompt ${promptApiKey} desde API: ${response.status} - ${errorText}. Usando prompt de fallback.`);
                return { content: promptApiKey === promptApiKeys.individual ? fallbackIndividualPrompt : fallbackGlobalPrompt, modelName: defaultLocalAIModelName, error: true, errorMessage: `Error API ${response.status}: No se pudo cargar el prompt '${promptApiKey}'.` };
            }
            const promptData = await response.json();
            if (!promptData.content) {
                console.error(`Prompt ${promptApiKey} obtenido de API pero sin contenido. Usando fallback.`);
                return { content: promptApiKey === promptApiKeys.individual ? fallbackIndividualPrompt : fallbackGlobalPrompt, modelName: promptData.model_name || defaultLocalAIModelName, error: true, errorMessage: `Prompt '${promptApiKey}' sin contenido.` };
            }
            return { content: promptData.content, modelName: promptData.model_name || defaultLocalAIModelName, error: false };
        } catch (error) {
            console.error(`Error de red al obtener prompt ${promptApiKey}:`, error, ". Usando prompt de fallback.");
            return { content: promptApiKey === promptApiKeys.individual ? fallbackIndividualPrompt : fallbackGlobalPrompt, modelName: defaultLocalAIModelName, error: true, errorMessage: `Error de red al cargar prompt '${promptApiKey}'.` };
        }
    }

    function showPasswordModal() {
        if(passwordModal && passwordInput && passwordError) {
            passwordInput.value = ''; passwordError.classList.add('hidden');
            passwordModal.classList.remove('hidden'); passwordInput.focus();
        }
    }
    function hidePasswordModal() { if(passwordModal) passwordModal.classList.add('hidden'); }

    function updateHeaderButtonsState() {
        const hasData = displayedPostRowsCount > 0;
        const actionButtons = [analizarTodosLocalAIBtn, viewWorkerChartBtn, viewPostChartBtn, viewWorkerPieChartBtn, viewConfeccionPorTrabajadorChartBtn];
        actionButtons.forEach(btn => {
            if (btn) {
                if (isLocked || !hasData) { btn.classList.add('hidden'); btn.disabled = true; }
                else { btn.classList.remove('hidden'); btn.disabled = false; }
            }
        });
        if (exportExcelBtn) exportExcelBtn.disabled = !hasData;
        if (kpiCardContainer) {
            if (isLocked || !hasData) kpiCardContainer.classList.add('hidden');
            else kpiCardContainer.classList.remove('hidden');
        }
    }

    function toggleLockState(locked) {
        isLocked = locked;
        if (isLocked) { if(lockIcon) lockIcon.classList.remove('hidden'); if(unlockIcon) unlockIcon.classList.add('hidden'); }
        else { if(lockIcon) lockIcon.classList.add('hidden'); if(unlockIcon) unlockIcon.classList.remove('hidden'); }
        updateHeaderButtonsState(); populateTable(originalWorkersData);
    }
    
    function showEditQuantityModal(workerClientId, postIndex, currentQuantity, quantityCell, cajasHoraCell, workerUnitsCell) {
        currentEditContext = { workerClientId, postIndex, currentQuantity, quantityCell, cajasHoraCell, workerUnitsCell };
        if(editQuantityInput) editQuantityInput.value = currentQuantity;
        if(editQuantityError) editQuantityError.classList.add('hidden');
        if(editApiStatus) { editApiStatus.textContent = ''; editApiStatus.classList.remove('text-red-500', 'text-green-500');}
        if(editQuantityModal) editQuantityModal.classList.remove('hidden');
        if(editQuantityInput) {editQuantityInput.focus(); editQuantityInput.select(); }
        if(saveEditBtn) { saveEditBtn.disabled = false; saveEditBtn.textContent = 'Guardar'; }
    }
    function hideEditQuantityModal() { if(editQuantityModal) editQuantityModal.classList.add('hidden'); currentEditContext = null; }

    async function handleSaveEdit() {
        const newQuantity = parseFloat(editQuantityInput.value);
        if (isNaN(newQuantity) || newQuantity < 0) {
            if(editQuantityError) { editQuantityError.textContent = 'NÃºmero invÃ¡lido.'; editQuantityError.classList.remove('hidden'); }
            if(editApiStatus) editApiStatus.textContent = ''; return;
        }
        if(editQuantityError) editQuantityError.classList.add('hidden');
        if (currentEditContext) {
            const { workerClientId, postIndex, quantityCell, cajasHoraCell, workerUnitsCell } = currentEditContext;
            const worker = originalWorkersData.find(w => w.client_id === workerClientId);
            if (!worker || !worker.operator_posts || !worker.operator_posts[postIndex]) { if(editApiStatus) {editApiStatus.textContent = 'Error: Datos no encontrados.'; editApiStatus.classList.add('text-red-500');} return; }
            const post = worker.operator_posts[postIndex]; const postId = post.id;
            if (typeof postId === 'undefined') { if(editApiStatus) {editApiStatus.textContent = 'Error: Falta ID de puesto.'; editApiStatus.classList.add('text-red-500');} console.error("Post ID undefined:", post); return; }
            if(saveEditBtn) {saveEditBtn.disabled = true; saveEditBtn.textContent = 'Guardando...';}
            if(editApiStatus) {editApiStatus.textContent = 'Actualizando...'; editApiStatus.classList.remove('text-red-500', 'text-green-500');}
            const formData = new URLSearchParams(); formData.append('id', postId); formData.append('count', newQuantity);
            try {
                const response = await fetch(apiEditPostUrl, { method: 'POST', headers: { 'Accept': 'application/json', 'Authorization': 'Bearer 915afe8b7fabc2ca8d759761b0fe159f88bf0f064be7e4cd6a1f99021eff4e3b' }, body: formData });
                if (!response.ok) { let err = `Error Servidor: ${response.status}`; try { const eD = await response.json(); err = eD.message || err; } catch (e) { const tE = await response.text(); if(tE) err = tE; } throw new Error(err); }
                const result = await response.json();
                if (result.status === 'success') {
                    post.count = newQuantity; if(quantityCell) quantityCell.childNodes[0].nodeValue = newQuantity + ' ';
                    if(cajasHoraCell) cajasHoraCell.textContent = calculateCajasHora(post.count, post.created_at, post.finish_at);
                    if (cajasHoraCell && cajasHoraCell.classList.contains('live-cajas-hora')) cajasHoraCell.dataset.count = newQuantity;
                    const totalQtySum = worker.operator_posts.reduce((s, p) => s + ((p.count??0)>0?(p.count??0):0), 0); if(workerUnitsCell) workerUnitsCell.textContent = totalQtySum;
                    if(editApiStatus) {editApiStatus.textContent = result.message || 'Actualizado.'; editApiStatus.classList.add('text-green-500');} setTimeout(hideEditQuantityModal, 1500);
                    updateGrandTotalUnidades(); updateKPICards();
                } else { throw new Error(result.message || 'API indicÃ³ fallo.'); }
            } catch (error) { console.error('Error al guardar:', error); if(editApiStatus){editApiStatus.textContent = `Error: ${error.message}`; editApiStatus.classList.add('text-red-500');}
            } finally { if(saveEditBtn){saveEditBtn.disabled = false; saveEditBtn.textContent = 'Guardar';} }
        }
    }
    
    function showAnalysisModal(title = "AnÃ¡lisis de Rendimiento") {
        if(analysisModalTitle) analysisModalTitle.textContent = title;
        if(analysisModalContent) analysisModalContent.innerHTML = '<div class="spinner"></div>';
        if(analysisModalStatus) { analysisModalStatus.textContent = `Generando anÃ¡lisis...`; analysisModalStatus.classList.remove('text-red-500');}
        if(analysisModal) analysisModal.classList.remove('hidden');
    }
    function hideAnalysisModal() {
        if(analysisModal) analysisModal.classList.add('hidden');
        if (localAIPollingIntervalId) { clearInterval(localAIPollingIntervalId); localAIPollingIntervalId = null; currentLocalAITaskId = null; }
    }

    function generateOverallSummaryTextForContext() {
        const workersToAnalyze = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        if (workersToAnalyze.length === 0) return "No hay datos globales de trabajadores disponibles para comparaciÃ³n.";
        let totalCajasGlobal = 0, totalHorasTrabajadasGlobal = 0, puestosConteo = {}, individualWorkerSummaries = [];
        workersToAnalyze.forEach(worker => {
            let workerCajas = 0, workerHoras = 0;
            (worker.operator_posts || []).filter(p => (p.count ?? 0) > 0).forEach(post => {
                const cantidad = post.count || 0; workerCajas += cantidad; totalCajasGlobal += cantidad;
                if(post.rfid_reading?.name) puestosConteo[post.rfid_reading.name] = (puestosConteo[post.rfid_reading.name] || 0) + cantidad;
                if (post.created_at) { const start = new Date(post.created_at), end = post.finish_at ? new Date(post.finish_at) : new Date(); if (end > start) { const dH = (end.getTime() - start.getTime()) / 3600000; workerHoras += dH; totalHorasTrabajadasGlobal += dH; }}
            });
            individualWorkerSummaries.push({name: worker.name || `ID ${worker.client_id}`, cajas: workerCajas, eficiencia: workerHoras > 0 ? (workerCajas / workerHoras).toFixed(2) : 'N/A'});
        });
        individualWorkerSummaries.sort((a, b) => b.cajas - a.cajas);
        const topPerformers = individualWorkerSummaries.slice(0, Math.min(3, individualWorkerSummaries.length));
        const lowPerformers = individualWorkerSummaries.slice(Math.max(0, individualWorkerSummaries.length - 3)).reverse();
        const avgCajasHoraGlobal = totalHorasTrabajadasGlobal > 0 ? (totalCajasGlobal / totalHorasTrabajadasGlobal).toFixed(2) : 'N/A';
        let puestosSummary = Object.entries(puestosConteo).sort(([,a],[,b])=>b-a).map(([n,c])=>`  - ${n}: ${c} cajas`).join('\n')||"  - Sin datos por puesto.";
        let topSummary = topPerformers.map(w=>`  - ${w.name}: ${w.cajas} cajas (Ef: ${w.eficiencia} c/h)`).join('\n')||"  - N/A";
        let lowSummary = lowPerformers.map(w=>`  - ${w.name}: ${w.cajas} cajas (Ef: ${w.eficiencia} c/h)`).join('\n')||"  - N/A";
        return `- Trabajadores activos (con producciÃ³n): ${workersToAnalyze.length}\n- Total Cajas Equipo: ${totalCajasGlobal}\n- Promedio Cajas/Hora Global: ${avgCajasHoraGlobal} c/h\n- Puestos con actividad: ${Object.keys(puestosConteo).length}\n- DistribuciÃ³n Cajas/Puesto:\n${puestosSummary}\n- Top Productores:\n${topSummary}\n- Menor ProducciÃ³n:\n${lowSummary}`.trim();
    }

    async function fetchLocalAIWorkerAnalysis(worker) {
        const analysisTitle = `AnÃ¡lisis de ${worker.name || 'Desconocido'} (IA Local)`;
        showAnalysisModal(analysisTitle);
        const promptInfo = await getPromptFromServer(promptApiKeys.individual);
        if (promptInfo.error) {
            if(analysisModalContent) analysisModalContent.textContent = promptInfo.errorMessage || "Error al cargar prompt individual.";
            if(analysisModalStatus) analysisModalStatus.textContent = "Fallo al cargar prompt."; return;
        }
        let promptTemplate = promptInfo.content; const modelToUse = promptInfo.modelName;
        const workerName = worker.name || 'Desconocido';
        let workerTotalCajas = 0, workerTotalDurationHours = 0, activePostsCount = 0;
        let postsDetails = "Trabajador sin puestos con producciÃ³n.";
        if (worker.operator_posts) {
            const activeP = worker.operator_posts.filter(p => (p.count ?? 0) > 0); activePostsCount = activeP.length;
            if (activePostsCount > 0) {
                postsDetails = activeP.map(p => {
                    const cant = p.count || 0; workerTotalCajas += cant;
                    const sD = p.created_at ? new Date(p.created_at) : null; let eD = p.finish_at ? new Date(p.finish_at) : (sD ? new Date() : null);
                    if (sD && eD && eD > sD) workerTotalDurationHours += (eD.getTime() - sD.getTime()) / 3600000;
                    return `- P: ${p.rfid_reading?.name||'N/A'}, Conf: ${p.product_list?.name||'N/A'}, I: ${sD?dateFormatter.format(sD):'N/A'}, F: ${p.finish_at?dateFormatter.format(new Date(p.finish_at)):'Activo'}, Q: ${cant}, C/h: ${calculateCajasHora(cant,p.created_at,p.finish_at)}`;
                }).join('\n\n');
            }
        }
        const workerAvgCajasHora = workerTotalDurationHours > 0 ? (workerTotalCajas / workerTotalDurationHours).toFixed(2) : 'N/A';
        const overallSummaryCtx = generateOverallSummaryTextForContext();
        promptTemplate = promptTemplate.replace(/{{workerName}}/g, workerName).replace(/{{workerClientId}}/g, worker.client_id||'N/A').replace(/{{activePostsCount}}/g, activePostsCount).replace(/{{workerTotalCajas}}/g, workerTotalCajas).replace(/{{workerAvgCajasHora}}/g, workerAvgCajasHora).replace(/{{postsDetails}}/g, postsDetails).replace(/{{overallSummary}}/g, overallSummaryCtx);
        await submitLocalAITask(promptTemplate, analysisTitle, modelToUse);
    }

    async function fetchLocalAIOverallAnalysis() {
        const analysisTitle = "AnÃ¡lisis Global de Trabajadores (IA Local)";
        showAnalysisModal(analysisTitle);
        const promptInfo = await getPromptFromServer(promptApiKeys.global);
        if (promptInfo.error) {
            if(analysisModalContent) analysisModalContent.textContent = promptInfo.errorMessage || "Error al cargar prompt global.";
            if(analysisModalStatus) analysisModalStatus.textContent = "Fallo al cargar prompt."; return;
        }
        let promptTemplate = promptInfo.content; const modelToUse = promptInfo.modelName;
        const overallSummaryText = generateOverallSummaryTextForContext();
        if (overallSummaryText.startsWith("No hay datos globales")) {
            if(analysisModalContent) analysisModalContent.textContent = 'No hay datos para anÃ¡lisis global.';
            if(analysisModalStatus) analysisModalStatus.textContent = 'No disponible.'; return;
        }
        promptTemplate = promptTemplate.replace(/{{overallSummary}}/g, overallSummaryText);
        await submitLocalAITask(promptTemplate, analysisTitle, modelToUse);
    }

    async function submitLocalAITask(prompt, modalTitleText, modelName) {
        if(analysisModalStatus) analysisModalStatus.textContent = 'Enviando tarea a IA...';
        const effectiveModelName = modelName || defaultLocalAIModelName;
        const payload = { prompt, model: effectiveModelName, callback_url: localAICallbackUrl };
        console.log("Payload IA:", JSON.stringify(payload));
        try {
            const response = await fetch(localAISubmitTaskUrl, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': localAIApiToken }, body: JSON.stringify(payload) });
            if (!response.ok) { const eTxt = await response.text(); throw new Error(`Error envÃ­o IA: ${response.status}. ${eTxt}`); }
            const result = await response.json();
            if (result.success && result.task_id) { currentLocalAITaskId = result.task_id; if(analysisModalStatus) analysisModalStatus.textContent = `Tarea enviada (ID: ${currentLocalAITaskId}). Esperando...`; startLocalAIPolling(currentLocalAITaskId); }
            else { throw new Error(result.message || 'Respuesta IA inesperada.'); }
        } catch (error) { console.error('Error submitLocalAITask:', error); if(analysisModalContent) analysisModalContent.textContent = `Error envÃ­o IA:\n${error.message}`; if(analysisModalStatus){analysisModalStatus.textContent = 'Error envÃ­o.'; analysisModalStatus.classList.add('text-red-500');} }
    }

    function startLocalAIPolling(taskId) {
        if (localAIPollingIntervalId) clearInterval(localAIPollingIntervalId);
        pollLocalAITaskStatus(taskId); localAIPollingIntervalId = setInterval(() => pollLocalAITaskStatus(taskId), 10000);
    }

    async function pollLocalAITaskStatus(taskId) {
        if (!taskId) return;
        if(analysisModalStatus) analysisModalStatus.textContent = `Consultando tarea ${taskId} (IA)...`;
        const statusUrl = `${localAITaskStatusUrlBase}${taskId}`;
        try {
            const response = await fetch(statusUrl, { headers: { 'Accept': 'application/json', 'Authorization': localAIApiToken } });
            if (!response.ok) { if(analysisModalStatus){analysisModalStatus.textContent = `Error consulta tarea ${taskId}. Reintentando...`; analysisModalStatus.classList.add('text-red-500');} return; }
            const result = await response.json();
            if (result.task?.response) {
                if(analysisModalContent) analysisModalContent.textContent = result.task.response; if(analysisModalStatus){analysisModalStatus.textContent = 'AnÃ¡lisis (IA) completado.'; analysisModalStatus.classList.remove('text-red-500');}
                if (localAIPollingIntervalId) { clearInterval(localAIPollingIntervalId); localAIPollingIntervalId = null; currentLocalAITaskId = null; }
            } else if (result.task?.status && ['processing', 'queued', 'pending'].includes(result.task.status.toLowerCase())) {
                if(analysisModalStatus){analysisModalStatus.textContent = `Tarea ${taskId} (IA) en proceso (${result.task.status})...`; analysisModalStatus.classList.remove('text-red-500');}
            } else if (result.task?.status && result.task.status.toLowerCase() === 'failed') {
                if(analysisModalContent) analysisModalContent.textContent = `Tarea ${taskId} (IA) fallÃ³.` + (result.task.error ? `\nError: ${result.task.error}` : ''); if(analysisModalStatus){analysisModalStatus.textContent = `Fallo tarea ${taskId} (IA).`; analysisModalStatus.classList.add('text-red-500');}
                if (localAIPollingIntervalId) { clearInterval(localAIPollingIntervalId); localAIPollingIntervalId = null; currentLocalAITaskId = null; }
            } else { if(analysisModalStatus){analysisModalStatus.textContent = `Esperando tarea ${taskId} (IA)... (Estado: ${result.task?.status||'?'})...`; analysisModalStatus.classList.remove('text-red-500');}}
        } catch (error) { console.error(`Error pollLocalAITaskStatus ${taskId}:`, error); if(analysisModalStatus){analysisModalStatus.textContent = `Error red consulta tarea ${taskId}. Reintentando...`; analysisModalStatus.classList.add('text-red-500');} }
    }
    
    function showChartModal(chartType) {
        if(!chartModal || !chartModalTitleEl || !chartContainerEl) return;
        currentChartType = chartType; 
        chartModal.classList.remove('hidden');
        chartModal.classList.remove('modal-fullscreen'); 
        if(expandIcon) expandIcon.classList.remove('hidden');
        if(contractIcon) contractIcon.classList.add('hidden');
        renderCurrentChart();
    }

    function renderCurrentChart() { 
        if (!currentChartType || !chartModalTitleEl) return;
        if (currentChartType === 'workers') { chartModalTitleEl.textContent = 'ðŸ“Š ProducciÃ³n Total por Trabajador'; renderProductionByWorkerChart(); }
        else if (currentChartType === 'postsBar') { chartModalTitleEl.textContent = 'ðŸ“Š ProducciÃ³n Total por Puesto (Barras)'; renderProductionByPostBarChart(); }
        else if (currentChartType === 'workerPie') { chartModalTitleEl.textContent = 'ðŸ“Š DistribuciÃ³n de Cajas por Empleado (Circular)'; renderWorkerDistributionPieChart(); } 
        else if (currentChartType === 'confeccionPorTrabajador') { chartModalTitleEl.textContent = 'ðŸ“Š ConfecciÃ³n por Trabajador (Apilado)'; renderConfeccionPorTrabajadorChart(); }
    }

    function hideChartModal() {
        if(chartModal) {
            chartModal.classList.add('hidden');
            chartModal.classList.remove('modal-fullscreen'); 
            if(expandIcon) expandIcon.classList.remove('hidden');
            if(contractIcon) contractIcon.classList.add('hidden');
        }
        d3.select("#chartContainer svg").remove();
        currentChartType = null;
    }

    function toggleChartFullscreen() {
        if (!chartModal || !expandIcon || !contractIcon) return;
        chartModal.classList.toggle('modal-fullscreen');
        const isFullscreen = chartModal.classList.contains('modal-fullscreen');
        expandIcon.classList.toggle('hidden', isFullscreen);
        contractIcon.classList.toggle('hidden', !isFullscreen);
        setTimeout(() => { renderCurrentChart(); }, 100); 
    }

    function renderProductionByWorkerChart() {
        d3.select("#chartContainer svg").remove();
        const dataForChart = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)))
            .map(worker => ({ name: worker.name || `ID: ${worker.client_id || 'N/A'}`, value: (worker.operator_posts || []).reduce((sum, post) => sum + (Number(post.count) || 0), 0) }))
            .filter(d => d.value > 0).sort((a, b) => b.value - a.value);
        drawBarChart(dataForChart, "Total de Cajas Producidas por Trabajador", "Trabajadores", "Total de Cajas");
    }
    function renderProductionByPostBarChart() {
        d3.select("#chartContainer svg").remove();
        const postCounts = {};
        filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData))).forEach(worker => {
            (worker.operator_posts || []).forEach(post => { if ((Number(post.count) || 0) > 0 && post.rfid_reading?.name) postCounts[post.rfid_reading.name] = (postCounts[post.rfid_reading.name] || 0) + (Number(post.count) || 0); });
        });
        const dataForChart = Object.entries(postCounts).map(([name, value]) => ({ name, value })).filter(d => d.value > 0).sort((a,b) => b.value - a.value);
        drawBarChart(dataForChart, "Total de Cajas Producidas por Puesto", "Puestos de Trabajo", "Total de Cajas");
    }
    function drawBarChart(chartData, titleText, xAxisLabelText, yAxisLabelText) {
        if (!chartContainerEl) return;
        if (chartData.length === 0) { chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para mostrar.</p>'; return; }
        chartContainerEl.innerHTML = '';
        
        const rect = chartContainerEl.getBoundingClientRect();
        const containerWidth = rect.width;
        const dynamicContainerHeight = rect.height > 50 ? rect.height : 450;

        const margin = {top: 40, right: 30, bottom: 120, left: 70};
        const minBarWidth = 30; 
        const calculatedWidth = Math.max(containerWidth - margin.left - margin.right, chartData.length * minBarWidth);
        const width = calculatedWidth;
        const height = dynamicContainerHeight - margin.top - margin.bottom;

        if (height <= 0 || width <=0) { console.error("Dimensiones de grÃ¡fico invÃ¡lidas:", width, height); chartContainerEl.innerHTML = '<p class="text-center text-red-500 p-4">Error al calcular dimensiones del grÃ¡fico.</p>'; return;}
        const svg = d3.select("#chartContainer").append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        const x = d3.scaleBand().range([0, width]).domain(chartData.map(d => d.name)).padding(0.3);
        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").attr("transform", "translate(-10,5)rotate(-45)").style("text-anchor", "end").style("font-size", "10px");
        const y = d3.scaleLinear().domain([0, d3.max(chartData, d => d.value) || 10]).nice().range([height, 0]);
        svg.append("g").call(d3.axisLeft(y).ticks(Math.min(10, d3.max(chartData, d => d.value) || 10)));
        svg.selectAll(".bar").data(chartData).join("rect").attr("class", "bar").attr("x", d => x(d.name)).attr("y", d => y(d.value)).attr("width", x.bandwidth()).attr("height", d => Math.max(0, height - y(d.value)))
            .on("mouseover", function(event, d) { if(tooltip){tooltip.transition().duration(200).style("opacity", .9); tooltip.html(`<strong>${d.name}</strong><br/>Cajas: ${d.value}`).style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 15) + "px");} d3.select(this).style("fill", "#1d4ed8"); })
            .on("mouseout", function() { if(tooltip)tooltip.transition().duration(500).style("opacity", 0); d3.select(this).style("fill", "steelblue"); });
        svg.append("text").attr("x", width / 2).attr("y", 0 - (margin.top / 2) - 5).attr("text-anchor", "middle").style("font-size", "16px").style("font-weight", "bold").text(titleText);
        svg.append("text").attr("transform", "rotate(-90)").attr("y", 0 - margin.left + 15).attr("x",0 - (height / 2)).attr("dy", "1em").style("text-anchor", "middle").attr("class", "axis-label").text(yAxisLabelText);
        svg.append("text").attr("transform", `translate(${width/2}, ${height + margin.bottom - 10})`).style("text-anchor", "middle").attr("class", "axis-label").text(xAxisLabelText);
    }
    
    function renderWorkerDistributionPieChart() {
        if (!chartContainerEl) return;
        d3.select("#chartContainer svg").remove();
        const workerCounts = {};
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));

        dataToProcess.forEach(worker => {
            const workerName = worker.name || `ID: ${worker.client_id || 'N/A'}`;
            let totalCajasTrabajador = 0;
            (worker.operator_posts || []).forEach(post => {
                totalCajasTrabajador += (Number(post.count) || 0);
            });
            if (totalCajasTrabajador > 0) {
                 workerCounts[workerName] = (workerCounts[workerName] || 0) + totalCajasTrabajador;
            }
        });

        const dataForChart = Object.entries(workerCounts)
            .map(([name, value]) => ({ name, value }))
            .filter(d => d.value > 0)
            .sort((a,b) => b.value - a.value);

        if (dataForChart.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos de producciÃ³n por empleado para mostrar.</p>';
            return;
        }
        chartContainerEl.innerHTML = '';
        
        const rect = chartContainerEl.getBoundingClientRect();
        const availableWidth = rect.width;
        const availableHeight = rect.height > 50 ? rect.height : 450; // Usar 450 como alto base

        const marginPie = 40; 
        const radius = Math.min(availableWidth - (2*marginPie), availableHeight - (2*marginPie)) / 2;
        if (radius <=0) { console.error("Pie chart radius is invalid."); chartContainerEl.innerHTML = '<p class="text-center text-red-500 p-4">Error al calcular dimensiones del grÃ¡fico.</p>'; return; }

        const svg = d3.select("#chartContainer").append("svg").attr("width",availableWidth).attr("height",availableHeight).append("g").attr("transform",`translate(${availableWidth/2},${availableHeight/2})`);
        const color = d3.scaleOrdinal(d3.schemeCategory10); 
        const pie = d3.pie().value(d=>d.value).sort(null); 
        const data_ready = pie(dataForChart);
        
        const arcGenerator = d3.arc().innerRadius(0).outerRadius(radius); // Pie chart normal (no donut)
        const outerArcForLabels = d3.arc().innerRadius(radius * 1.05).outerRadius(radius * 1.05); // Para las lÃ­neas de las etiquetas

        svg.selectAll('allSlices').data(data_ready).join('path')
            .attr('d', arcGenerator)
            .attr('fill', d => color(d.data.name))
            .attr("stroke", "white").style("stroke-width", "2px").style("opacity", 0.8)
            .on("mouseover",function(e,d){
                d3.select(this).style("opacity", 1); 
                if(tooltip){
                    tooltip.transition().duration(200).style("opacity", .9);
                    const percent = (d.data.value/d3.sum(dataForChart,i=>i.value)*100).toFixed(1);
                    tooltip.html(`<strong>${d.data.name}</strong><br/>Cajas: ${d.data.value}<br/>(${percent}%)`).style("left",(e.pageX+10)+"px").style("top",(e.pageY-15)+"px");
                }
            })
            .on("mouseout",function(){d3.select(this).style("opacity", 0.8); if(tooltip)tooltip.transition().duration(500).style("opacity", 0);});

        // AÃ±adir polilÃ­neas y etiquetas fuera del grÃ¡fico
        svg.selectAll('allPolylines')
            .data(data_ready)
            .join('polyline')
            .attr("stroke", "black")
            .style("fill", "none")
            .attr("stroke-width", 1)
            .attr('points', function(d) {
                const percent = (d.data.value / d3.sum(dataForChart, item => item.value) * 100);
                if (percent < 2) return ""; // No dibujar lÃ­nea para porciones muy pequeÃ±as
                const posA = arcGenerator.centroid(d); // Punto de inicio en el centroide de la porciÃ³n
                const posB = outerArcForLabels.centroid(d); // Punto intermedio fuera del grÃ¡fico
                const posC = outerArcForLabels.centroid(d); // Punto final para el texto
                posC[0] = radius * 1.1 * (midAngle(d) < Math.PI ? 1 : -1); // Extender horizontalmente
                return [posA, posB, posC];
            });

        svg.selectAll('allLabels')
            .data(data_ready)
            .join('text')
            .attr('class', 'pie-slice-label') // Usar la clase CSS definida
            .text(d => {
                const percent = (d.data.value / d3.sum(dataForChart, item => item.value) * 100);
                if (percent < 2) return ""; // No mostrar etiqueta para porciones muy pequeÃ±as
                let namePart = d.data.name;
                if (namePart.length > 10) namePart = namePart.substring(0,8) + "..."; // Acortar nombres largos
                return `${namePart} (${percent.toFixed(0)}%)`;
            })
            .attr('transform', d => {
                const pos = outerArcForLabels.centroid(d);
                pos[0] = radius * 1.15 * (midAngle(d) < Math.PI ? 1 : -1); // Posicionar texto mÃ¡s allÃ¡ de la lÃ­nea
                pos[1] += 2; // PequeÃ±o ajuste vertical
                return `translate(${pos})`;
            })
            .style('text-anchor', d => (midAngle(d) < Math.PI ? 'start' : 'end'));

        function midAngle(d){ return d.startAngle + (d.endAngle - d.startAngle)/2; }
    }
    
    function renderConfeccionPorTrabajadorChart() {
        if (!chartContainerEl) { console.error("chartContainerEl no encontrado en renderConfeccionPorTrabajadorChart"); return; }
        d3.select("#chartContainer svg").remove();
        console.log("Render Confeccion/Trabajador: Iniciando");
        const dataToProcess = filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData)));
        if (dataToProcess.length === 0) { chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos para el grÃ¡fico de confecciÃ³n por trabajador.</p>'; console.log("Render Confeccion/Trabajador: Sin datos para procesar."); return; }
        chartContainerEl.innerHTML = '';

        const aggregatedData = {};
        const allConfecciones = new Set();
        dataToProcess.forEach(worker => {
            const workerIdentifier = worker.name || `ID: ${worker.client_id}`;
            if (!aggregatedData[workerIdentifier]) aggregatedData[workerIdentifier] = {};
            (worker.operator_posts || []).forEach(post => {
                const count = Number(post.count) || 0;
                if (count > 0 && post.product_list?.name) {
                    const confeccionName = post.product_list.name;
                    allConfecciones.add(confeccionName);
                    aggregatedData[workerIdentifier][confeccionName] = (aggregatedData[workerIdentifier][confeccionName] || 0) + count;
                }
            });
        });
        const confeccionKeys = Array.from(allConfecciones).sort();
        const chartData = Object.entries(aggregatedData).map(([trabajador, confecciones]) => {
            const row = { trabajador: trabajador };
            confeccionKeys.forEach(conKey => { row[conKey] = confecciones[conKey] || 0; });
            return row;
        }).sort((a,b) => d3.sum(confeccionKeys, key => b[key]) - d3.sum(confeccionKeys, key => a[key]));

        if (chartData.length === 0 || confeccionKeys.length === 0) {
            chartContainerEl.innerHTML = '<p class="text-center text-gray-500 p-4">No hay datos de producciÃ³n con confecciÃ³n por trabajador para mostrar.</p>';
            return;
        }
        const stack = d3.stack().keys(confeccionKeys);
        const series = stack(chartData);
        
        const rect = chartContainerEl.getBoundingClientRect();
        const containerWidth = rect.width;
        const dynamicContainerHeight = rect.height > 50 ? rect.height : 450;
        
        const margin = {top: 60, right: 30, bottom: 120, left: 70};
        const width = Math.max(containerWidth - margin.left - margin.right, chartData.length * 50);
        const height = dynamicContainerHeight - margin.top - margin.bottom;

        if (height <= 0 || width <=0) { console.error("Dimensiones de grÃ¡fico apilado invÃ¡lidas:", width, height); chartContainerEl.innerHTML = '<p class="text-center text-red-500 p-4">Error al calcular dimensiones del grÃ¡fico.</p>'; return;}

        const svg = d3.select("#chartContainer").append("svg").attr("width",width + margin.left + margin.right).attr("height",height + margin.top + margin.bottom).append("g").attr("transform",`translate(${margin.left},${margin.top})`);
        const x = d3.scaleBand().domain(chartData.map(d=>d.trabajador)).range([0,width]).padding(0.2);
        const y = d3.scaleLinear().domain([0,d3.max(series,d=>d3.max(d,d=>d[1]))||10]).nice().range([height,0]);
        const color = d3.scaleOrdinal(d3.schemeCategory10).domain(confeccionKeys);

        svg.append("g").selectAll("g").data(series).join("g").attr("fill",d=>color(d.key))
            .selectAll("rect").data(d=>d).join("rect")
            .attr("x",d=>x(d.data.trabajador))
            .attr("y",d=>y(d[1]))
            .attr("height",d=>Math.max(0,y(d[0])-y(d[1])))
            .attr("width",x.bandwidth())
            .on("mouseover",function(e,d){
                const parentData=d3.select(this.parentNode).datum(); const confeccionName=parentData.key; const value=d.data[confeccionName];
                if(tooltip){tooltip.transition().duration(200).style("opacity",.9);tooltip.html(`<strong>Trabajador:</strong> ${d.data.trabajador}<br/><strong>ConfecciÃ³n:</strong> ${confeccionName}<br/><strong>Cajas:</strong> ${value}`).style("left",(e.pageX+10)+"px").style("top",(e.pageY-15)+"px");}
                d3.select(this).style("stroke","black").style("stroke-width",0.5).style("opacity", 0.7);
            })
            .on("mouseout",function(){if(tooltip)tooltip.transition().duration(500).style("opacity",0);d3.select(this).style("stroke","none").style("opacity", 1);});
        svg.append("g").attr("transform",`translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").attr("transform","translate(-10,5)rotate(-45)").style("text-anchor","end");
        svg.append("g").call(d3.axisLeft(y).ticks(Math.min(10,d3.max(series,d=>d3.max(d,d=>d[1]))||10)));
        
        const legend = svg.append("g").attr("font-family","sans-serif").attr("font-size",10).attr("text-anchor","start")
            .attr("transform", `translate(0, ${-margin.top + 20})`)
            .selectAll("g").data(confeccionKeys.slice()).join("g")
            .attr("transform",(d,i)=>`translate(${i * ( (width / Math.min(confeccionKeys.length, 6)) * 0.8 ) },0)`);

        legend.append("rect").attr("x",0).attr("y", -7).attr("width",12).attr("height",12).attr("fill",color);
        legend.append("text").attr("x",15).attr("y",0).attr("dy","0.32em").text(d=>d.length > 12 ? d.substring(0,10)+"..." : d);
        
        svg.append("text").attr("x",width/2).attr("y",0-(margin.top/2)-5).attr("text-anchor","middle").style("font-size","16px").style("font-weight","bold").text("ProducciÃ³n de Confecciones por Trabajador");
    }

    function formatDateForAPI(date) { const y = date.getFullYear(), m = String(date.getMonth() + 1).padStart(2, '0'), d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
    function getDateRange(selectedValue) {
        const today = new Date(); today.setHours(0,0,0,0); let from = new Date(today), to = new Date(today);
        switch(selectedValue){ case 'yesterday':from.setDate(today.getDate()-1);to.setDate(today.getDate()-1);break; case 'day_minus_2':from.setDate(today.getDate()-2);to.setDate(today.getDate()-2);break; case 'day_minus_3':from.setDate(today.getDate()-3);to.setDate(today.getDate()-3);break; case 'day_minus_4':from.setDate(today.getDate()-4);to.setDate(today.getDate()-4);break; case 'day_minus_5':from.setDate(today.getDate()-5);to.setDate(today.getDate()-5);break; case 'day_minus_6':from.setDate(today.getDate()-6);to.setDate(today.getDate()-6);break; case 'day_minus_7':from.setDate(today.getDate()-7);to.setDate(today.getDate()-7);break; case 'last7days':from.setDate(today.getDate()-6);break; case 'last30days':from.setDate(today.getDate()-29);break; }
        let apiTo = new Date(to); apiTo.setDate(to.getDate()+1); return {from:formatDateForAPI(from), to:formatDateForAPI(apiTo)};
    }
    function calculateCajasHora(count, startTimeStr, endTimeStr) {
        const q = parseFloat(count)||0; if(!startTimeStr)return 'N/A'; const sT = new Date(startTimeStr); if(isNaN(sT.getTime()))return 'N/A';
        const eT = endTimeStr ? new Date(endTimeStr) : new Date(); if(isNaN(eT.getTime()))return 'N/A';
        if(eT <= sT)return q > 0 ? 'N/A' : '0.00'; const dMs = eT.getTime()-sT.getTime(), dH = dMs/3600000;
        if(dH <= 0)return q > 0 ? 'N/A' : '0.00'; if(q === 0)return '0.00'; return (q/dH).toFixed(2);
    }
    function updateLiveCajasHoraCells() { document.querySelectorAll('.live-cajas-hora').forEach(c => { c.textContent = calculateCajasHora(c.dataset.count, c.dataset.startTime, null); }); }
    function filterDataByCheckbox(data) { if(filterPostsCheckbox && filterPostsCheckbox.checked) return data.filter(w => w.operator_posts && w.operator_posts.some(p=>(p.count??0)>0)); return data; }
    function filterDataBySearch(data, searchTerm) {
        if(!searchTerm)return data; const lST = searchTerm.toLowerCase();
        return data.filter(w => (w.name||'').toLowerCase().includes(lST) || (w.client_id||'').toString().toLowerCase().includes(lST) || (w.operator_posts && w.operator_posts.some(p => ((p.rfid_reading?.name||'').toLowerCase().includes(lST)) || ((p.product_list?.name||'').toLowerCase().includes(lST)))));
    }
    function updateGrandTotalUnidades() {
        const sT = searchInput ? searchInput.value : ''; const dF = filterDataBySearch(filterDataByCheckbox(originalWorkersData), sT);
        let gT = 0; dF.forEach(w => { gT += (w.operator_posts||[]).reduce((s,p)=>{const c=p.count??0; if(filterPostsCheckbox && filterPostsCheckbox.checked&&c===0)return s; return s+c;},0); });
        if(totalUnidadesTurnoHeader) totalUnidadesTurnoHeader.textContent = `(${gT})`;
    }
    function updateKPICards() {
        const searchTerm = searchInput ? searchInput.value : '';
        const dataToDisplay = filterDataBySearch(filterDataByCheckbox(originalWorkersData), searchTerm);

        if (!kpiTotalCajas || (dataToDisplay.length === 0 && !searchTerm && (!filterPostsCheckbox || !filterPostsCheckbox.checked) && originalWorkersData.length === 0) || (dataToDisplay.length === 0 && filterPostsCheckbox && filterPostsCheckbox.checked)) {
            if(kpiTotalCajas)kpiTotalCajas.textContent='-';
            if(kpiTrabajadoresActivos)kpiTrabajadoresActivos.textContent='0';
            if(kpiAvgCajasHora)kpiAvgCajasHora.textContent='-';
            if(kpiPuestoMasProductivo)kpiPuestoMasProductivo.textContent='-';
            if(kpiCardContainer && !isLocked)kpiCardContainer.classList.add('hidden');
            return;
        }
        if(kpiCardContainer && !isLocked)kpiCardContainer.classList.remove('hidden');

        let totalCajasGlobal = 0;
        let totalHorasTrabajadasGlobal = 0;
        let trabajadoresActivosSet = new Set();
        let operarioMasProductivo = { nombre: '-', cajas: 0 };

        dataToDisplay.forEach(worker => {
            let workerHasProductionInView = false;
            let cajasDelTrabajadorActual = 0;

            if (worker.operator_posts && worker.operator_posts.length > 0) {
                worker.operator_posts.forEach(post => {
                    const cantidad = Number(post.count) || 0;
                    if (cantidad > 0) {
                        workerHasProductionInView = true;
                        totalCajasGlobal += cantidad;
                        cajasDelTrabajadorActual += cantidad;
                        if (post.created_at) {
                            const start = new Date(post.created_at), end = post.finish_at ? new Date(post.finish_at) : new Date();
                            if (end > start) totalHorasTrabajadasGlobal += (end.getTime() - start.getTime()) / 3600000;
                        }
                    }
                });
            }
            if (workerHasProductionInView) {
                trabajadoresActivosSet.add(worker.client_id);
                if (cajasDelTrabajadorActual > operarioMasProductivo.cajas) {
                    operarioMasProductivo = { nombre: worker.name || `ID ${worker.client_id}`, cajas: cajasDelTrabajadorActual };
                }
            }
        });

        if(kpiTotalCajas) kpiTotalCajas.textContent=totalCajasGlobal;
        if(kpiTrabajadoresActivos) kpiTrabajadoresActivos.textContent=trabajadoresActivosSet.size;
        if(kpiAvgCajasHora) kpiAvgCajasHora.textContent=totalHorasTrabajadasGlobal > 0 ? (totalCajasGlobal / totalHorasTrabajadasGlobal).toFixed(2) : 'N/A';
        
        if(kpiPuestoMasProductivo) {
            kpiPuestoMasProductivo.textContent = operarioMasProductivo.cajas > 0 ? `${operarioMasProductivo.nombre} (${operarioMasProductivo.cajas})` : '-';
        }
    }
    function populateTable(data) {
        if(liveUpdateIntervalId)clearInterval(liveUpdateIntervalId);liveUpdateIntervalId=null;
        if(!tableBody) return;
        tableBody.querySelectorAll('tr:not(#loadingRow):not(#errorRow):not(#noDataRow)').forEach(r=>r.remove());
        const sT=searchInput?searchInput.value:'',dFC=filterDataByCheckbox(data),dTD=filterDataBySearch(dFC,sT);
        displayedPostRowsCount=0;let wVPC=0;
        dTD.forEach(w=>{const hVP=w.operator_posts&&w.operator_posts.some(p=>(p.count??0)>0);if(filterPostsCheckbox && filterPostsCheckbox.checked&&!hVP&&sT==='')return;let wMSD=false;if(sT){const lS=sT.toLowerCase();if((w.name||'').toLowerCase().includes(lS)||(w.client_id||'').toString().toLowerCase().includes(lS))wMSD=true;}let hADP=false;if(w.operator_posts){w.operator_posts.forEach(p=>{if((p.count??0)>0||(filterPostsCheckbox && !filterPostsCheckbox.checked)){if(filterPostsCheckbox && filterPostsCheckbox.checked&&(p.count??0)===0){}else{if(sT){const lS=sT.toLowerCase();if((p.rfid_reading?.name||'').toLowerCase().includes(lS)||(p.product_list?.name||'').toLowerCase().includes(lS))hADP=true;}else hADP=true;}}});}if(!wMSD&&!hADP&&sT!=='')return;wVPC++;if(w.operator_posts){w.operator_posts.forEach(p=>{const pC=p.count??0;let dTP=false;if(pC>0||(filterPostsCheckbox && !filterPostsCheckbox.checked)){if(filterPostsCheckbox && filterPostsCheckbox.checked&&pC===0){}else{if(sT){const lS=sT.toLowerCase();if(wMSD||(p.rfid_reading?.name||'').toLowerCase().includes(lS)||(p.product_list?.name||'').toLowerCase().includes(lS))dTP=true;}else dTP=true;}}if(dTP)displayedPostRowsCount++;});}});
        updateGrandTotalUnidades();updateKPICards();updateHeaderButtonsState();
        if(noDataRow){ if(displayedPostRowsCount===0){noDataRow.querySelector('td').textContent=sT?`No se encontraron resultados para "${sT}".`:(filterPostsCheckbox && filterPostsCheckbox.checked&&data.length>0?'NingÃºn trabajador cumple los criterios.':'No se encontraron datos.');noDataRow.classList.remove('hidden');}else{noDataRow.classList.add('hidden');}}
        let hLC=false;wVPC=0;
        dTD.forEach(w=>{const tQS=(w.operator_posts||[]).reduce((s,p)=>s+((p.count??0)>0?(p.count??0):0),0);let wSBR=false;const lST=sT.toLowerCase();if(!sT){wSBR=!(filterPostsCheckbox && filterPostsCheckbox.checked&&!((w.operator_posts||[]).some(p=>(p.count??0)>0)));}else{if((w.name||'').toLowerCase().includes(lST)||(w.client_id||'').toString().toLowerCase().includes(lST))wSBR=true;else if(w.operator_posts)wSBR=w.operator_posts.some(p=>((p.rfid_reading?.name||'').toLowerCase().includes(lST))||((p.product_list?.name||'').toLowerCase().includes(lST)));}if(!wSBR)return;wVPC++;
        const wR=tableBody.insertRow();wR.classList.add('bg-blue-50','hover:bg-blue-100','transition-colors');wR.insertCell().textContent=w.client_id??'-';const nC=wR.insertCell();nC.textContent=w.name??'Sin Nombre';
        if(!isLocked){const aLIA=document.createElement('button');aLIA.classList.add('analyze-icon','ml-1','text-indigo-600','hover:text-indigo-800');aLIA.title="Analizar (IA)";aLIA.innerHTML=`<svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zm13.71-9.37c-.39-.39-1.02-.39-1.41 0L18 5.92 14.08 2 12 2c-1.1 0-2 .9-2 2v2H8c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v10h20V4c0-1.1-.9-2-2-2h-2.29L19.3 2.63c-.39-.39-1.02-.39-1.41 0zM16 14c0-2.21-1.79-4-4-4s-4 1.79-4 4 1.79 4 4 4 4-1.79 4-4zm-4-2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2z"/></svg>`;aLIA.addEventListener('click',(e)=>{e.stopPropagation();fetchLocalAIWorkerAnalysis(w);});nC.appendChild(aLIA);}
        const wUC=wR.insertCell();wUC.textContent=tQS;wR.insertCell();wR.insertCell();wR.insertCell();wR.insertCell();wR.insertCell();wR.insertCell();Array.from(wR.cells).forEach(c=>c.classList.add('px-4','py-3','text-sm','font-medium','text-gray-900','whitespace-nowrap'));
        if(w.operator_posts&&w.operator_posts.length>0){const sP=[...w.operator_posts].sort((a,b)=>(new Date(a.created_at)||0)-(new Date(b.created_at)||0));sP.forEach((p,pI)=>{const pC=p.count??0;let dTPR=false;if(!sT){if(pC>0||(filterPostsCheckbox && !filterPostsCheckbox.checked))dTPR=true;}else{const lS=sT.toLowerCase();if((w.name||'').toLowerCase().includes(lS)||(w.client_id||'').toString().toLowerCase().includes(lS)||(p.rfid_reading?.name||'').toLowerCase().includes(lS)||(p.product_list?.name||'').toLowerCase().includes(lS)){if(pC>0||(filterPostsCheckbox && !filterPostsCheckbox.checked))dTPR=true;}}if(!dTPR && !(filterPostsCheckbox && !filterPostsCheckbox.checked && pC === 0 && !sT)) return; if(filterPostsCheckbox && filterPostsCheckbox.checked && pC === 0 && dTPR && !sT) return;
        const pR=tableBody.insertRow();pR.classList.add((tableBody.rows.length-3)%2===0?'bg-white':'bg-gray-50','hover:bg-gray-100');pR.insertCell();pR.insertCell();pR.insertCell();pR.insertCell().textContent=p.rfid_reading?.name??'N/A';pR.insertCell().textContent=p.created_at?dateFormatter.format(new Date(p.created_at)):'-';pR.insertCell().textContent=p.finish_at?dateFormatter.format(new Date(p.finish_at)):'-';
        const qC=pR.insertCell();qC.textContent=pC+' ';const cHC=pR.insertCell();cHC.textContent=calculateCajasHora(pC,p.created_at,p.finish_at);
        if(!isLocked){const eIS=document.createElement('span');eIS.classList.add('edit-icon');eIS.innerHTML=`<svg class="icon" style="width:16px;height:16px;" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM16 5l-1.5-1.5L13 5l1.5 1.5L16 5zM5 14H3v2h12v-2H5z"/></svg>`;eIS.addEventListener('click',()=>showEditQuantityModal(w.client_id,pI,pC,qC,cHC,wUC));qC.appendChild(eIS);}
        if(!p.finish_at&&p.created_at){cHC.classList.add('live-cajas-hora');cHC.dataset.startTime=p.created_at;cHC.dataset.count=pC;hLC=true;}
        pR.insertCell().textContent=p.product_list?.name??'N/A';Array.from(pR.cells).forEach(c=>c.classList.add('px-4','py-3','text-sm','text-gray-600','whitespace-nowrap'));pR.cells[3].classList.add('pl-8');});}});
        if(hLC)liveUpdateIntervalId=setInterval(updateLiveCajasHoraCells,5000);
    }
    
    function exportToExcel() {
        const searchTerm = searchInput ? searchInput.value : '';
        const dataFiltered = filterDataBySearch(filterDataByCheckbox(JSON.parse(JSON.stringify(originalWorkersData))), searchTerm);
        if (!dataFiltered || dataFiltered.length === 0) { const noDataModal = document.createElement('div'); noDataModal.innerHTML = `<div class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-[2000]"><div class="bg-white rounded-lg shadow-xl p-6"><h3 class="text-lg font-medium">Sin Datos</h3><p class="mt-2">No hay datos para exportar.</p><button onclick="this.closest('.fixed').remove()" class="mt-4 px-3 py-1 bg-blue-500 text-white rounded">OK</button></div></div>`; document.body.appendChild(noDataModal); return; }
        const flattenedData = [];
        dataFiltered.forEach(worker => {
            const totalQuantitySum = (worker.operator_posts || []).reduce((sum, post) => sum + ((Number(post.count) ?? 0) > 0 ? (Number(post.count) ?? 0) : 0), 0);
            let workerShouldBeIncluded = !searchTerm || (worker.name || '').toLowerCase().includes(searchTerm.toLowerCase()) || (worker.client_id || '').toString().toLowerCase().includes(searchTerm.toLowerCase());
            if (!workerShouldBeIncluded && worker.operator_posts) { workerShouldBeIncluded = worker.operator_posts.some(post => ((post.rfid_reading?.name || '').toLowerCase().includes(searchTerm.toLowerCase())) || ((post.product_list?.name || '').toLowerCase().includes(searchTerm.toLowerCase())));}
            if (filterPostsCheckbox && filterPostsCheckbox.checked && !((worker.operator_posts || []).some(p => (Number(p.count) ?? 0) > 0)) && !workerShouldBeIncluded) return;
            (worker.operator_posts || []).filter(post => { let pMS = true; if(searchTerm){ const lS = searchTerm.toLowerCase(); pMS = (post.rfid_reading?.name || '').toLowerCase().includes(lS) || (post.product_list?.name || '').toLowerCase().includes(lS) || workerShouldBeIncluded; } return ((Number(post.count) ?? 0) > 0 || (filterPostsCheckbox && !filterPostsCheckbox.checked)) && pMS;
            }).forEach(post => { flattenedData.push({ 'Codigo': worker.client_id ?? '-', 'Nombre Trabajador': worker.name ?? 'Sin Nombre', 'Unidades Turno': totalQuantitySum, 'Puesto': post.rfid_reading?.name ?? 'N/A', 'Inicio Puesto': post.created_at ? dateFormatter.format(new Date(post.created_at)) : '-', 'Fin Puesto': post.finish_at ? dateFormatter.format(new Date(post.finish_at)) : '-', 'Cantidad Puesto': (Number(post.count) ?? 0), 'Cajas/Hora': calculateCajasHora(post.count, post.created_at, post.finish_at), 'Confeccion': post.product_list?.name ?? 'N/A' }); });
        });
        if (flattenedData.length === 0) { const noDetModal = document.createElement('div'); noDetModal.innerHTML = `<div class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center p-4 z-[2000]"><div class="bg-white rounded-lg shadow-xl p-6"><h3 class="text-lg font-medium">Sin Detalles</h3><p class="mt-2">No hay detalles para exportar.</p><button onclick="this.closest('.fixed').remove()" class="mt-4 px-3 py-1 bg-blue-500 text-white rounded">OK</button></div></div>`; document.body.appendChild(noDetModal); return; }
        const colOrd = ['Codigo', 'Nombre Trabajador', 'Unidades Turno', 'Puesto', 'Inicio Puesto', 'Fin Puesto', 'Cantidad Puesto', 'Cajas/Hora', 'Confeccion'];
        const ws = XLSX.utils.json_to_sheet(flattenedData.map(r => Object.fromEntries(colOrd.map(c => [c, r[c] ?? '']))), { header: colOrd });
        ws["!cols"] = colOrd.map(k => ({ wch: flattenedData.reduce((w, r) => Math.max(w, (r[k]?.toString() ?? '').length), k.length) + 2 }));
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "TrabajadoresDetalle");
        if(dateRangeSelect && filterPostsCheckbox) { XLSX.writeFile(wb, `Informe_Trabajadores_${dateRangeSelect.options[dateRangeSelect.selectedIndex].text.replace(/ /g, '_')}${filterPostsCheckbox.checked ? '_ConPuestos' : ''}.xlsx`);}
        else { XLSX.writeFile(wb, `Informe_Trabajadores.xlsx`); }
    }

    function printTable() { window.print(); }

    function fetchData(fromDate, toDate) {
        const apiUrl = `${apiBaseUrl}?from_date=${fromDate}&to_date=${toDate}`;
        if(loadingRow) loadingRow.classList.remove('hidden'); if(errorRow) errorRow.classList.add('hidden'); if(noDataRow) noDataRow.classList.add('hidden');
        if(tableBody) tableBody.querySelectorAll('tr:not(#loadingRow):not(#errorRow):not(#noDataRow)').forEach(r=>r.remove());
        if(exportExcelBtn)exportExcelBtn.disabled=true; updateHeaderButtonsState();
        if(liveUpdateIntervalId)clearInterval(liveUpdateIntervalId);liveUpdateIntervalId=null;
        fetch(apiUrl)
            .then(r=>r.ok?r.json():r.text().then(t=>{throw new Error(`Error HTTP ${r.status}: ${t}`);}))
            .then(apiR=>{if(loadingRow)loadingRow.classList.add('hidden');
                if(apiR.success&&Array.isArray(apiR.data)){originalWorkersData=apiR.data.sort((a,b)=>{const fFP=(w)=>{if(!w.operator_posts||w.operator_posts.length===0)return null;const aP=w.operator_posts.filter(p=>(p.count??0)>0&&p.created_at).map(p=>({...p,cAD:new Date(p.created_at)})).filter(p=>!isNaN(p.cAD.getTime()));if(aP.length===0)return null;aP.sort((p1,p2)=>p1.cAD-p2.cAD);return aP[0];};const fPA=fFP(a),fPB=fFP(b);const pNA=fPA?.rfid_reading?.name??null,pNB=fPB?.rfid_reading?.name??null;if(pNA&&pNB){const nC=pNA.localeCompare(pNB,undefined,{numeric:true,sensitivity:'base'});if(nC!==0)return nC;return(a.name??'').localeCompare(b.name??'');}else if(pNA)return -1;else if(pNB)return 1;else return(a.name??'').localeCompare(b.name??'');});populateTable(originalWorkersData);}
                else if(apiR.success&&(!Array.isArray(apiR.data)||apiR.data.length===0)){originalWorkersData=[];populateTable(originalWorkersData);}
                else{originalWorkersData=[];populateTable([]);throw new Error(apiR.message||"Error en API.");}
            })
            .catch(e=>{console.error("Error en fetch:",e);if(loadingRow)loadingRow.classList.add('hidden');if(errorCell)errorCell.textContent=`Error: ${e.message}`;if(errorRow)errorRow.classList.remove('hidden');if(totalUnidadesTurnoHeader)totalUnidadesTurnoHeader.textContent='(Error)';updateHeaderButtonsState();});
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        tableBody = document.getElementById('workersTableBody');
        loadingRow = document.getElementById('loadingRow');
        errorRow = document.getElementById('errorRow');
        errorCell = errorRow.querySelector('td');
        noDataRow = document.getElementById('noDataRow');
        exportExcelBtn = document.getElementById('exportExcelBtn');
        printBtn = document.getElementById('printBtn');
        dateRangeSelect = document.getElementById('dateRangeSelect');
        filterPostsCheckbox = document.getElementById('filterPostsCheckbox');
        analizarTodosLocalAIBtn = document.getElementById('analizarTodosLocalAIBtn');
        viewWorkerChartBtn = document.getElementById('viewWorkerChartBtn');
        viewPostChartBtn = document.getElementById('viewPostChartBtn');
        viewWorkerPieChartBtn = document.getElementById('viewWorkerPieChartBtn');
        viewConfeccionPorTrabajadorChartBtn = document.getElementById('viewConfeccionPorTrabajadorChartBtn');
        totalUnidadesTurnoHeader = document.getElementById('totalUnidadesTurnoHeader');
        searchInput = document.getElementById('searchInput');
        lockButton = document.getElementById('lockButton');
        lockIcon = document.getElementById('lockIcon');
        unlockIcon = document.getElementById('unlockIcon');
        passwordModal = document.getElementById('passwordModal');
        passwordInput = document.getElementById('passwordInput');
        passwordError = document.getElementById('passwordError');
        cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        submitPasswordBtn = document.getElementById('submitPasswordBtn');
        editQuantityModal = document.getElementById('editQuantityModal');
        editQuantityInput = document.getElementById('editQuantityInput');
        editQuantityError = document.getElementById('editQuantityError');
        editApiStatus = document.getElementById('editApiStatus');
        cancelEditBtn = document.getElementById('cancelEditBtn');
        saveEditBtn = document.getElementById('saveEditBtn');
        analysisModal = document.getElementById('analysisModal');
        analysisModalTitle = document.getElementById('analysisModalTitle');
        analysisModalContent = document.getElementById('analysisModalContent');
        analysisModalStatus = document.getElementById('analysisModalStatus');
        closeAnalysisModalBtn = document.getElementById('closeAnalysisModalBtn');
        okAnalysisModalBtn = document.getElementById('okAnalysisModalBtn');
        chartModal = document.getElementById('chartModal');
        chartModalTitleEl = document.getElementById('chartModalTitle');
        chartContainerEl = document.getElementById('chartContainer');
        tooltip = document.getElementById('tooltip');
        kpiCardContainer = document.getElementById('kpiCardContainer');
        kpiTotalCajas = document.getElementById('kpiTotalCajas');
        kpiTrabajadoresActivos = document.getElementById('kpiTrabajadoresActivos');
        kpiAvgCajasHora = document.getElementById('kpiAvgCajasHora');
        kpiPuestoMasProductivo = document.getElementById('kpiPuestoMasProductivo');
        toggleFullscreenChartBtn = document.getElementById('toggleFullscreenChartBtn');
        expandIcon = document.getElementById('expandIcon');
        contractIcon = document.getElementById('contractIcon');

        if (exportExcelBtn) {
            if (typeof exportToExcel === 'function') { exportExcelBtn.addEventListener('click', exportToExcel); }
            else { console.error('ERROR: exportToExcel no es una funciÃ³n al adjuntar listener.'); }
        }
        if (printBtn) {
            if (typeof printTable === 'function') { printBtn.addEventListener('click', printTable); }
            else { console.error('ERROR: printTable no es una funciÃ³n al adjuntar listener.'); }
        }
        if (analizarTodosLocalAIBtn) analizarTodosLocalAIBtn.addEventListener('click', fetchLocalAIOverallAnalysis);
        if (viewWorkerChartBtn) viewWorkerChartBtn.addEventListener('click', () => showChartModal('workers'));
        if (viewPostChartBtn) viewPostChartBtn.addEventListener('click', () => showChartModal('postsBar'));
        if (viewWorkerPieChartBtn) viewWorkerPieChartBtn.addEventListener('click', () => showChartModal('workerPie'));
        if (viewConfeccionPorTrabajadorChartBtn) viewConfeccionPorTrabajadorChartBtn.addEventListener('click', () => showChartModal('confeccionPorTrabajador'));
        
        if (dateRangeSelect) dateRangeSelect.addEventListener('change', (e) => { const {from, to} = getDateRange(e.target.value); fetchData(from, to); });
        if (filterPostsCheckbox) filterPostsCheckbox.addEventListener('change', () => { populateTable(originalWorkersData); updateKPICards(); updateHeaderButtonsState(); });
        if (searchInput) searchInput.addEventListener('input', () => { populateTable(originalWorkersData); updateKPICards(); updateHeaderButtonsState(); });
        if (cancelPasswordBtn) cancelPasswordBtn.addEventListener('click', hidePasswordModal);
        if (submitPasswordBtn) submitPasswordBtn.addEventListener('click', () => { if (passwordInput.value === 'boisolo') { hidePasswordModal(); toggleLockState(false); } else { if(passwordError)passwordError.classList.remove('hidden'); if(passwordInput)passwordInput.select(); } });
        if (passwordInput) passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && submitPasswordBtn) submitPasswordBtn.click(); });
        if (cancelEditBtn) cancelEditBtn.addEventListener('click', hideEditQuantityModal);
        if (saveEditBtn) saveEditBtn.addEventListener('click', handleSaveEdit);
        if (editQuantityInput) editQuantityInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && saveEditBtn) saveEditBtn.click(); });
        if (closeAnalysisModalBtn) closeAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
        if (okAnalysisModalBtn) okAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
        
        const localCloseChartModalBtn = document.getElementById('closeChartModalBtn');
        const localOkChartModalBtn = document.getElementById('okChartModalBtn');
        if(chartModal && localCloseChartModalBtn) localCloseChartModalBtn.addEventListener('click', hideChartModal);
        if(chartModal && localOkChartModalBtn) localOkChartModalBtn.addEventListener('click', hideChartModal);
        if(toggleFullscreenChartBtn) toggleFullscreenChartBtn.addEventListener('click', toggleChartFullscreen);

        if (lockButton) lockButton.addEventListener('click', () => { if (isLocked) showPasswordModal(); else toggleLockState(true); });

        const {from, to} = getDateRange(dateRangeSelect.value);
        fetchData(from, to);
        toggleLockState(isLocked); 
    });
</script>

</body>
</html>
