# ============================================
# CONFIGURACIÓN BÁSCULA UTILCELL SMART RS232
# ============================================

# Puerto serie
SERIAL_PORT=/dev/ttyUSB0
BAUD_RATE=115200
DATA_BITS=8
STOP_BITS=1
PARITY=none

# Comando RS232 para pedir peso
# AUTO = autodetección (recomendado primera vez)
# A = Comando 'A' para formato F4
# P = Comando 'P' para formato configurado
RS232_COMMAND=A

# Añadir terminadores al comando (detectado: CR+LF funciona)
RS232_APPEND_CR=true
RS232_APPEND_LF=true

# Delimitador de respuesta de la báscula
RS232_DELIMITER=LF

# FACTOR DE ESCALA (DIVISOR) - IMPORTANTE
# La báscula envía peso en décimas (ej: 1224330 = 122433.0 kg)
# RS232_SCALE = 0.1  → divide entre 10
# RS232_SCALE = 0.01 → divide entre 100
RS232_SCALE=0.1

# NÚMERO DE DECIMALES EN LA PUBLICACIÓN MQTT
# Valores: 0-8 ó 'auto'
# - 'auto' infiere los decimales según RS232_SCALE (ej: 0.001 -> 3 decimales)
# - Número (ej 2) redondea a ese número fijo de decimales
RS232_DECIMALS=auto

# UMBRAL DE CERO (elimina ruido cerca de 0)
# Si el peso está entre -THRESHOLD y +THRESHOLD, se publica como 0
# Ejemplo: 0.01 convierte -0.005, -0.000, 0.003 → 0
# Útil para evitar publicar -0 cuando la báscula está estable sin carga
RS232_ZERO_THRESHOLD=0.01

# NO PUBLICAR VALORES SIN CAMBIOS
# Si true, solo publica cuando el peso cambia (reduce tráfico MQTT)
# Si false, publica siempre (útil para heartbeat)
RS232_PUBLISH_UNCHANGED=false

# OFFSET (CALIBRACIÓN A 0)
# Valor a RESTAR del peso crudo antes de aplicar la escala
# Se usa para calibrar la báscula a 0 cuando no hay carga
# Fórmula paso 1: peso_bruto = (peso_crudo - OFFSET) * SCALE
RS232_OFFSET=0

# TARA (PESO DE CONTENEDOR)
# Valor en kg a RESTAR después de escalar
# Se usa para ignorar el peso del contenedor/recipiente
# Fórmula paso 2: peso_neto = peso_bruto - TARA
RS232_TARA=0.0

# AUTO-CALIBRACIÓN DE OFFSET
# Si está en true, al arrancar el sistema toma las primeras 10 lecturas
# y si todas están por encima de RS232_MIN_OFFSET, usa el promedio como offset
RS232_AUTO_OFFSET=true

# OFFSET MÍNIMO para activar auto-calibración
# Si las lecturas están por debajo de este valor, NO se calibra automáticamente
# (asume que ya hay carga en la báscula)
RS232_MIN_OFFSET=100000

# AUTO-CORRECCIÓN CONTINUA (DESACTIVADA por defecto para evitar saltos)
# Si tienes carga variable, déjalo en false
# Solo actívalo si la báscula está siempre sin carga y necesitas ajustes automáticos
RS232_AUTO_CORRECT_ENABLED=false

# Número de lecturas NEGATIVAS consecutivas antes de ajustar el offset
# Con POLL_INTERVAL_MS=300, 50 lecturas = 15 segundos de peso negativo
# Aumenta este valor para mayor seguridad (evita correcciones por ruido momentáneo)
RS232_AUTO_CORRECT_THRESHOLD=50

# Número de muestras de peso BAJO (0-10kg) antes de ajustar offset
# Con POLL_INTERVAL_MS=300, 100 lecturas = 30 segundos de peso bajo consistente
RS232_LOW_WEIGHT_SAMPLES=100

# Cambio MÁXIMO de offset por corrección automática (evita saltos grandes)
# Limita cuánto puede cambiar el offset en un solo ajuste
RS232_MAX_OFFSET_CHANGE=50000

# Guardar automáticamente el offset calculado en .env
RS232_PERSIST_OFFSET=true

# ===== AUTO-AJUSTE INTELIGENTE (SISTEMA DE 3 RANGOS) =====
# El sistema ajusta automáticamente OFFSET o TARA según el peso detectado
RS232_AUTO_TARA_ENABLED=false

# RANGO 1: [0 - RS232_AUTO_OFFSET_MAX] → Ajusta OFFSET (calibración a 0)
# Si el peso se mantiene estable en este rango, ajusta el offset para calibrar a 0
# Ejemplo: Si detecta 0.03 kg estable → ajusta offset para que lea 0
RS232_AUTO_OFFSET_MAX=0.05

# RANGO 2: [RS232_AUTO_TARA_MIN - RS232_AUTO_TARA_MAX] → Establece TARA (peso contenedor)
# Si el peso se mantiene estable en este rango, establece como tara
# IMPORTANTE: Si detecta un nuevo peso en este rango, REEMPLAZA la tara anterior
# Ejemplo: Contenedor 0.3 kg → tara=0.3 → cambias a contenedor 0.25 kg → tara=0.25
RS232_AUTO_TARA_MIN=0.05
RS232_AUTO_TARA_MAX=0.4

# RANGO 3: [> RS232_AUTO_TARA_MAX] → Peso real, no hace ajustes
# Si el peso supera este valor, se considera peso real de producto

# Tiempo de estabilidad (segundos)
# El peso debe mantenerse estable durante este tiempo antes de hacer ajuste
RS232_AUTO_TARA_TIME=30

# Intervalo de sondeo en milisegundos (cada cuánto pedir peso)
POLL_INTERVAL_MS=300

# ===== CONFIGURACIÓN DE DIRECCIONES (MÚLTIPLES BÁSCULAS) =====
# Direcciones de básculas a monitorizar (separadas por comas)
# El sistema consultará cíclicamente cada dirección configurada
# Ejemplo: RS232_ADDRESSES=1,2,3  (monitoriza 3 básculas)
RS232_ADDRESSES=1

# Prefijo del comando de dirección (opcional, vacío por defecto)
# Si tu báscula usa prefijo para direcciones (ej: '@01', '#01'), configúralo aquí
# Ejemplo: RS232_ADDRESS_PREFIX=@  (enviará '@01A', '@02A', etc.)
RS232_ADDRESS_PREFIX=

# ===== CONFIGURACIÓN ESPECÍFICA POR DIRECCIÓN =====
# Cada dirección puede tener su propia configuración de OFFSET, TARA y ESCALA
# Si no se especifica, usa los valores globales (RS232_OFFSET, RS232_TARA, RS232_SCALE)

# Ejemplos:
# Dirección 1:
RS232_OFFSET_1=0
RS232_TARA_1=0.0
RS232_SCALE_1=0.001

# Dirección 2:
# RS232_OFFSET_2=760500
# RS232_TARA_2=0.250
# RS232_SCALE_2=0.001

# Dirección 3:
# RS232_OFFSET_3=761000
# RS232_TARA_3=0.300
# RS232_SCALE_3=0.001

# ============================================
# CONFIGURACIÓN MQTT
# ============================================

MQTT_BROKER_URL=mqtt://localhost

# Topic base para publicar peso
# Publica en: sensorica/bascula/peso/smart_utilcell
MQTT_TOPIC_BASE=sensorica/bascula/peso

# Topic para recibir comando de TARA
# Enviar: {"value": true} para hacer tara
MQTT_TOPIC_TARA=sensorica/bascula/tara

# Topic para recibir comando de CERO
# Enviar: {"value": true} para hacer cero
MQTT_TOPIC_ZERO=sensorica/bascula/zero

# ============================================
# LOGS Y DEBUG
# ============================================

# Mostrar logs detallados (HEX, ASCII, etc)
LOG_VERBOSE=true
